<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales & Cash Dashboard</title>
  <style>
    :root {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      color-scheme: light;
      --bg: #f2f4f9;
      --surface: #ffffff;
      --surface-alt: #eef2ff;
      --border: #d8dce5;
      --text: #1a1d23;
      --muted: #6b7280;
      --primary: #2563eb;
      --accent: #1d4ed8;
      --good: #15803d;
      --warn: #c05621;
      --bad: #b91c1c;
      --shadow-1: 0 10px 25px rgba(16, 24, 40, 0.06);
      --shadow-2: 0 18px 40px rgba(16, 24, 40, 0.08);
      --ring: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
    [data-theme="dark"] {
      --bg: #0b1220;
      --surface: #0f172a;
      --surface-alt: #0b1327;
      --border: #1f2a44;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary: #60a5fa;
      --accent: #3b82f6;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --shadow-1: 0 10px 25px rgba(0, 0, 0, 0.35);
      --shadow-2: 0 18px 40px rgba(0, 0, 0, 0.45);
      --ring: 0 0 0 3px rgba(96, 165, 250, 0.25);
    }
    body {
      margin: 0;
      background: radial-gradient(1000px 600px at -10% -10%, #eef5ff, transparent),
                  radial-gradient(800px 500px at 110% -10%, #f8f0ff, transparent),
                  linear-gradient(180deg, #f7f9ff, #f2f4f9 40%);
      color: var(--text);
    }
    [data-theme="dark"] body {
      background: radial-gradient(1000px 600px at -10% -10%, #0b1530, transparent),
                  radial-gradient(800px 500px at 110% -10%, #1a1230, transparent),
                  linear-gradient(180deg, #0f172a, #0b1220 40%);
    }
    header {
      background: linear-gradient(180deg, #ffffff, #f7f9ff);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    [data-theme="dark"] header { background: linear-gradient(180deg, #0f172a, #0b1327); }
    h1 {
      margin: 0;
      font-size: 1.7rem;
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .language-switch,
    .tab-switch {
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .language-switch button,
    .tab-switch button {
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
      box-shadow: var(--shadow-1);
    }
    .language-switch button.active,
    .tab-switch button.active {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      border-color: var(--primary);
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 48px;
      display: grid;
      gap: 20px;
    }
    .module {
      display: none;
      gap: 20px;
    }
    .module.active {
      display: grid;
    }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px 16px;
      box-shadow: var(--shadow-2);
      position: relative;
      overflow: hidden;
    }
    .stat-card:before { content: ''; position: absolute; inset: 0; border-radius: 14px; pointer-events: none; background: linear-gradient(180deg, rgba(255,255,255,0.4), rgba(255,255,255,0)); }
    .stat-accent-blue { border-top: 4px solid #3b82f6; }
    .stat-accent-green { border-top: 4px solid #16a34a; }
    .stat-accent-orange { border-top: 4px solid #f59e0b; }
    .stat-accent-red { border-top: 4px solid #ef4444; }
    .stat-icon { position: absolute; right: 12px; top: 12px; width: 36px; height: 36px; border-radius: 9px; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow: var(--shadow-1); }
    .stat-icon.blue { background: linear-gradient(135deg, #60a5fa, #2563eb); }
    .stat-icon.green { background: linear-gradient(135deg, #34d399, #16a34a); }
    .stat-icon.orange { background: linear-gradient(135deg, #fdba74, #f59e0b); }
    .stat-icon.red { background: linear-gradient(135deg, #f87171, #ef4444); }
    .stat-icon.brand { background: linear-gradient(135deg, var(--primary), var(--accent)); }
    .stat-card .label {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .stat-card .value { font-size: 1.7rem; font-weight: 700; }
    .stat-card .note {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 6px;
      display: block;
    }
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow-1);
    }
    .panel-title { margin: 0 0 12px; font-size: 1.05rem; font-weight: 700; color: #0f172a; letter-spacing: 0.2px; }
    .section-title { margin: 4px 4px 0; font-size: 1.1rem; font-weight: 700; color: #111827; opacity: 0.9; }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    input[type="search"],
    input[type="date"],
    input[type="number"],
    input[type="file"],
    select,
    textarea {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 9px 11px;
      font-size: 0.95rem;
      background: #fff;
      min-width: 200px;
      box-sizing: border-box;
    }
    input[type="search"] {
      flex: 1;
    }
    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      color: #fff;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button.primary:hover { filter: brightness(1.05); }
    button.primary:focus { box-shadow: var(--ring); outline: none; }
    button.secondary {
      border: 1px solid var(--border);
      background: #fff;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      border-radius: 12px;
      overflow: hidden;
    }
    thead { background: var(--surface-alt); position: sticky; top: 0; z-index: 1; }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 12px;
      text-align: left;
      vertical-align: top;
    }
    tbody tr:hover { background: rgba(37, 99, 235, 0.08); }
    tbody tr:nth-child(even) {
      background: rgba(37, 99, 235, 0.035);
    }
    .muted {
      color: var(--muted);
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      gap: 4px;
    }
    .tag.in { background: rgba(21, 128, 61, 0.12); color: var(--good); }
    .tag.out { background: rgba(185, 28, 28, 0.14); color: var(--bad); }
    .tag.pending { background: rgba(192, 86, 33, 0.14); color: var(--warn); }
    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.9rem;
      border: 1px solid var(--border);
      background: #fff;
    }
    .pill-warn { background: rgba(192,86,33,0.08); color: var(--warn); border-color: rgba(192,86,33,0.25); }
    .pill-good { background: rgba(21,128,61,0.08); color: var(--good); border-color: rgba(21,128,61,0.25); }
    .pill-info { background: rgba(37,99,235,0.08); color: var(--primary); border-color: rgba(37,99,235,0.25); }
    .actions button {
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: inline-block;
      box-shadow: var(--shadow-1);
    }
    .entry-panel {
      display: grid;
      gap: 16px;
    }
    .entry-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .entry-tabs button {
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      flex: 1 1 160px;
      box-shadow: var(--shadow-1);
    }
    .entry-tabs button.active {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      border-color: var(--accent);
    }
    .entry-form {
      display: none;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      background: var(--surface);
    }
    .entry-form.active {
      display: grid;
      gap: 14px;
    }
    .field-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
    }
    label span {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }
    textarea {
      min-height: 90px;
      resize: vertical;
    }
    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }
    .entry-message {
      font-size: 0.85rem;
      min-height: 1.2em;
    }
    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; }
      .filters { flex-direction: column; align-items: stretch; }
      input[type="search"] { width: 100%; }
      .tab-switch button { flex: 1 1 140px; }
      .entry-tabs button { flex: 1 1 48%; }
    }
    @media (max-width: 480px) {
      .entry-tabs button { flex: 1 1 100%; }
      .field-grid { grid-template-columns: 1fr; }
      .stat-grid { grid-template-columns: 1fr; }
      .stat-icon { display: none; }
      th, td { padding: 10px; }
    }

    /* Mobile bottom actions */
    .mobile-actions {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: none;
      gap: 8px;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index: 1000;
    }
    .mobile-actions > button { flex: 1; }
    @media (max-width: 580px) {
      .mobile-actions { display: flex; }
    }
  </style>
</head>
<body>
  <header>
    <h1 data-i18n="appTitle"></h1>
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <div class="tab-switch">
        <button type="button" class="active" data-tab="sales" data-i18n="tabSales"></button>
        <button type="button" data-tab="cash" data-i18n="tabCash"></button>
      </div>
      <div class="language-switch">
        <button type="button" data-lang="en" class="active" data-i18n="languageEnglish"></button>
        <button type="button" data-lang="ar" data-i18n="languageArabic"></button>
      </div>
      <label style="display:inline-flex;align-items:center;gap:6px;">
        <span class="muted" data-i18n="brandLabel"></span>
        <select id="brand-select">
          <option value="blue" data-i18n="brandBlue"></option>
          <option value="emerald" data-i18n="brandEmerald"></option>
          <option value="purple" data-i18n="brandPurple"></option>
          <option value="amber" data-i18n="brandAmber"></option>
        </select>
      </label>
      <button type="button" id="theme-toggle" class="secondary" title="Toggle theme">
        <span id="theme-toggle-label">Dark</span>
      </button>
      <button type="button" id="global-refresh-btn" class="secondary" data-i18n="refreshButton"></button>
    </div>
  </header>
  <main>
    <section id="sales-module" class="module active">
      <h2 class="section-title" data-i18n="salesOverview"></h2>
      <section class="stat-grid">
        <article class="stat-card stat-accent-blue">
          <div class="stat-icon brand" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17l6-6 4 4 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <span class="label" data-i18n="salesStatTotalSales"></span>
          <span class="value" id="sales-stat-total-sales">0.000</span>
          <span class="note" id="sales-stat-net-income" data-i18n-template="salesStatNetIncome"></span>
        </article>
        <article class="stat-card stat-accent-green">
          <div class="stat-icon green" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="6" width="20" height="12" rx="2" ry="2" stroke="currentColor" stroke-width="2"/><rect x="4" y="8" width="4" height="4" fill="currentColor"/></svg>
          </div>
          <span class="label" data-i18n="salesStatKnetSales"></span>
          <span class="value" id="sales-stat-knet-sales">0.000</span>
          <span class="note" id="sales-stat-knet-pending" data-i18n-template="salesStatKnetPending"></span>
        </article>
        <article class="stat-card stat-accent-orange">
          <div class="stat-icon orange" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2"/><path d="M7 12h10" stroke="currentColor" stroke-width="2"/></svg>
          </div>
          <span class="label" data-i18n="salesStatCashSales"></span>
          <span class="value" id="sales-stat-cash-sales">0.000</span>
          <span class="note muted" data-i18n="salesStatCashHint"></span>
        </article>
        <article class="stat-card stat-accent-red">
          <div class="stat-icon red" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 7H4" stroke="currentColor" stroke-width="2"/><path d="M10 11v6" stroke="currentColor" stroke-width="2"/><path d="M14 11v6" stroke="currentColor" stroke-width="2"/></svg>
          </div>
          <span class="label" data-i18n="salesStatExpenses"></span>
          <span class="value" id="sales-stat-expenses">0.000</span>
          <span class="note" id="sales-stat-overdue" data-i18n-template="salesStatOverdue"></span>
        </article>
      </section>

      <section class="panel filters">
        <input type="search" id="sales-search-input" data-i18n-placeholder="salesSearchPlaceholder">
        <label>
          <span class="muted" data-i18n="exportFrom"></span>
          <input type="date" id="sales-from-date">
        </label>
        <label>
          <span class="muted" data-i18n="exportTo"></span>
          <input type="date" id="sales-to-date">
        </label>
        <label>
          <input type="checkbox" id="sales-pending-toggle">
          <span data-i18n="salesFilterPending"></span>
        </label>
        <button type="button" class="primary" id="sales-refresh-btn" data-i18n="refreshButton"></button>
        <button type="button" class="secondary" id="sales-export-btn" data-i18n="exportButton"></button>
      </section>

      <section class="panel">
        <h3 class="panel-title" data-i18n="salesRecords"></h3>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th data-i18n="salesColDate"></th>
                <th data-i18n="salesColTotal"></th>
                <th data-i18n="salesColKnet"></th>
                <th data-i18n="salesColCash"></th>
                <th data-i18n="salesColExpenses"></th>
                <th data-i18n="salesColNet"></th>
                <th data-i18n="salesColKnetStatus"></th>
                <th data-i18n="salesColReceipt"></th>
                <th data-i18n="salesColNotes"></th>
                <th data-i18n="salesColActions"></th>
              </tr>
            </thead>
            <tbody id="sales-records-body"></tbody>
          </table>
        </div>
        <p class="muted" id="sales-empty-state" data-i18n="salesEmptyState"></p>
      </section>

      <section class="panel entry-panel">
        <div class="entry-tabs" role="tablist">
          <button type="button" class="entry-tab active" data-sales-entry-tab="cash" data-i18n="salesEntryCashTab"></button>
          <button type="button" class="entry-tab" data-sales-entry-tab="knet" data-i18n="salesEntryKnetTab"></button>
          <button type="button" class="entry-tab" data-sales-entry-tab="expense" data-i18n="salesEntryExpenseTab"></button>
          <button type="button" class="entry-tab" data-sales-entry-tab="received" data-i18n="salesEntryReceivedTab"></button>
        </div>

        <form id="sales-form-cash" class="entry-form active" data-sales-entry="cash">
          <div class="field-grid">
            <label>
              <span data-i18n="salesFormDate"></span>
              <input type="date" id="sales-cash-date" required>
            </label>
            <label>
              <span data-i18n="salesFormCashSales"></span>
              <input type="number" id="sales-cash-amount" step="0.001" min="0" required>
            </label>
          </div>
          <label>
            <span data-i18n="salesFormNotes"></span>
            <textarea id="sales-cash-notes"></textarea>
          </label>
          <div class="actions-row">
            <button type="button" class="secondary" data-reset="cash" data-i18n="resetButton"></button>
            <button type="submit" class="primary" data-i18n="saveButton"></button>
          </div>
          <p class="muted entry-message" id="sales-message-cash"></p>
        </form>

        <form id="sales-form-knet" class="entry-form" data-sales-entry="knet">
          <div class="field-grid">
            <label>
              <span data-i18n="salesFormDate"></span>
              <input type="date" id="sales-knet-date" required>
            </label>
            <label>
              <span data-i18n="salesFormTotalSales"></span>
              <input type="number" id="sales-knet-total" step="0.001" min="0">
              <span class="badge muted" data-i18n="salesFormTotalHint"></span>
            </label>
            <label>
              <span data-i18n="salesFormKnetSales"></span>
              <input type="number" id="sales-knet-amount" step="0.001" min="0" required>
              <span class="badge muted" data-i18n="salesFormKnetHint"></span>
            </label>
            <label>
              <span data-i18n="salesFormExpectedDate"></span>
              <input type="date" id="sales-knet-expected">
              <span class="badge muted" data-i18n="salesFormExpectedHint"></span>
            </label>
            <label>
              <span data-i18n="salesFormReceivedDate"></span>
              <input type="date" id="sales-knet-received">
              <span class="badge muted" data-i18n="salesFormReceivedHint"></span>
            </label>
            <label>
              <span data-i18n="salesFormReceipt"></span>
              <input type="file" id="sales-knet-receipt" accept="image/*">
              <span class="badge muted" data-i18n="salesFormReceiptHint"></span>
            </label>
          </div>
          <label>
            <input type="checkbox" id="sales-knet-mark">
            <span data-i18n="salesFormMarkReceived"></span>
          </label>
          <label>
            <span data-i18n="salesFormNotes"></span>
            <textarea id="sales-knet-notes"></textarea>
          </label>
          <div class="actions-row">
            <button type="button" class="secondary" data-reset="knet" data-i18n="resetButton"></button>
            <button type="submit" class="primary" data-i18n="saveButton"></button>
          </div>
          <p class="muted entry-message" id="sales-message-knet"></p>
        </form>

        <form id="sales-form-expense" class="entry-form" data-sales-entry="expense">
          <div class="field-grid">
            <label>
              <span data-i18n="salesFormDate"></span>
              <input type="date" id="sales-expense-date" required>
            </label>
            <label>
              <span data-i18n="salesFormExpenses"></span>
              <input type="number" id="sales-expense-amount" step="0.001" min="0" required>
            </label>
          </div>
          <label>
            <span data-i18n="salesFormExpenseNotes"></span>
            <textarea id="sales-expense-notes"></textarea>
          </label>
          <div class="actions-row">
            <button type="button" class="secondary" data-reset="expense" data-i18n="resetButton"></button>
            <button type="submit" class="primary" data-i18n="saveButton"></button>
          </div>
          <p class="muted entry-message" id="sales-message-expense"></p>
        </form>

        <form id="sales-form-received" class="entry-form" data-sales-entry="received">
          <div class="field-grid">
            <label>
              <span data-i18n="salesReceivedPending"></span>
              <div id="sales-received-pending" class="pill pill-warn">0.000</div>
            </label>
            <label>
              <span data-i18n="salesReceivedAmount"></span>
              <input type="number" id="sales-received-amount" step="0.001" min="0">
            </label>
            <label>
              <span data-i18n="salesFormReceivedDate"></span>
              <input type="date" id="sales-received-date">
            </label>
          </div>
          <p class="muted" data-i18n="salesReceivedHelp"></p>
          <div class="actions-row">
            <button type="submit" class="primary" data-i18n="salesMarkReceivedButton"></button>
          </div>
          <p class="muted entry-message" id="sales-message-received"></p>
        </form>
      </section>
    </section>

    <section id="cash-module" class="module">
      <h2 class="section-title" data-i18n="cashOverview"></h2>
      <section class="stat-grid">
        <article class="stat-card stat-accent-green">
          <div class="stat-icon green" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14" stroke="currentColor" stroke-width="2"/><path d="M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
          </div>
          <span class="label" data-i18n="cashStatTotalIn"></span>
          <span class="value" id="cash-stat-total-in">0.000</span>
          <span class="note" id="cash-stat-pending" data-i18n-template="cashStatPendingKnet"></span>
        </article>
        <article class="stat-card stat-accent-red">
          <div class="stat-icon red" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12h14" stroke="currentColor" stroke-width="2"/></svg>
          </div>
          <span class="label" data-i18n="cashStatTotalOut"></span>
          <span class="value" id="cash-stat-total-out">0.000</span>
          <span class="note" id="cash-stat-profit" data-i18n-template="cashStatProfitTransfer"></span>
        </article>
        <article class="stat-card stat-accent-blue">
          <div class="stat-icon brand" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="6" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2"/></svg>
          </div>
          <span class="label" data-i18n="cashStatInHand"></span>
          <span class="value" id="cash-stat-in-hand">0.000</span>
          <span class="note muted" data-i18n="cashStatHint"></span>
        </article>
      </section>

      <section class="panel filters">
        <input type="search" id="cash-search-input" data-i18n-placeholder="cashSearchPlaceholder">
        <label>
          <input type="checkbox" id="cash-pending-toggle">
          <span data-i18n="cashFilterPending"></span>
        </label>
        <button type="button" class="primary" id="cash-refresh-btn" data-i18n="refreshButton"></button>
        <button type="button" class="secondary" id="cash-export-btn" data-i18n="exportButton"></button>
      </section>

      <section class="panel">
        <h3 class="panel-title" data-i18n="cashRecords"></h3>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th data-i18n="cashColDate"></th>
                <th data-i18n="cashColDirection"></th>
                <th data-i18n="cashColCategory"></th>
                <th data-i18n="cashColAmount"></th>
                <th data-i18n="cashColStatus"></th>
                <th data-i18n="cashColKnet"></th>
                <th data-i18n="cashColProfit"></th>
                <th data-i18n="cashColNotes"></th>
                <th data-i18n="cashColActions"></th>
              </tr>
            </thead>
            <tbody id="cash-records-body"></tbody>
          </table>
        </div>
        <p class="muted" id="cash-empty-state" data-i18n="cashEmptyState"></p>
      </section>

      <section class="panel">
        <h2 data-i18n="cashFormTitle"></h2>
        <form id="cash-entry-form">
          <div class="field-grid">
            <label>
              <span data-i18n="cashFormDate"></span>
              <input type="date" id="cash-form-date" name="entryDate" required>
            </label>
            <label>
              <span data-i18n="cashFormDirection"></span>
              <select id="cash-form-direction" name="direction">
                <option value="IN" data-i18n="directionIn"></option>
                <option value="OUT" data-i18n="directionOut"></option>
              </select>
            </label>
            <label>
              <span data-i18n="cashFormCategory"></span>
              <select id="cash-form-category" name="category"></select>
            </label>
            <label>
              <span data-i18n="cashFormAmount"></span>
              <input type="number" id="cash-form-amount" name="amount" step="0.001" min="0" required>
            </label>
            <label class="cash-knet-only">
              <span data-i18n="cashFormExpectedDate"></span>
              <input type="date" id="cash-form-expected" name="knetExpectedDate">
            </label>
            <label class="cash-knet-only">
              <span data-i18n="cashFormReceivedDate"></span>
              <input type="date" id="cash-form-received" name="knetReceivedDate">
            </label>
          </div>
          <label class="cash-knet-only">
            <input type="checkbox" id="cash-form-mark-received" name="markReceived">
            <span data-i18n="cashFormMarkReceived"></span>
          </label>
          <label>
            <span data-i18n="cashFormDescription"></span>
            <textarea id="cash-form-description" name="description"></textarea>
          </label>
          <label>
            <span data-i18n="cashFormNotes"></span>
            <textarea id="cash-form-notes" name="notes"></textarea>
          </label>
          <div class="actions-row">
            <button type="button" class="secondary" id="cash-reset-btn" data-i18n="resetButton"></button>
            <button type="submit" class="primary" id="cash-submit-btn" data-i18n="saveButton"></button>
          </div>
          <p class="muted entry-message" id="cash-form-message"></p>
        </form>
      </section>
    </section>
  </main>
  <!-- Mobile footer actions -->
  <div class="mobile-actions">
    <button type="button" id="mobile-refresh-btn" class="secondary" data-i18n="refreshButton"></button>
    <button type="button" id="mobile-export-btn" class="primary" data-i18n="exportButton"></button>
  </div>
  <div id="export-modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.45); align-items:center; justify-content:center; padding: 16px;">
    <div style="background: var(--surface); color: var(--text); border:1px solid var(--border); border-radius: 14px; width: min(520px, 96vw); box-shadow: var(--shadow-2);">
      <div style="padding:16px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px;">
        <h3 class="panel-title" id="export-modal-title">Export Report</h3>
        <button type="button" id="export-close" class="secondary">×</button>
      </div>
      <form id="export-form" style="padding:18px; display:grid; gap:12px;">
        <div class="field-grid">
          <label>
            <span data-i18n="exportDataset"></span>
            <select id="export-dataset">
              <option value="sales" data-i18n="datasetSales"></option>
              <option value="cash" data-i18n="datasetCash"></option>
              <option value="both" data-i18n="datasetBoth"></option>
            </select>
          </label>
          <label>
            <span data-i18n="exportRange"></span>
            <select id="export-range">
              <option value="thisMonth" data-i18n="rangeThisMonth"></option>
              <option value="lastMonth" data-i18n="rangeLastMonth"></option>
              <option value="custom" data-i18n="rangeCustom"></option>
            </select>
          </label>
          <label>
            <span data-i18n="exportFrom"></span>
            <input type="date" id="export-from">
          </label>
          <label>
            <span data-i18n="exportTo"></span>
            <input type="date" id="export-to">
          </label>
          <label>
            <span data-i18n="exportFormat"></span>
            <select id="export-format">
              <option value="xlsx" data-i18n="exportExcel"></option>
              <option value="pdf" data-i18n="exportPdf"></option>
            </select>
          </label>
        </div>
        <div class="actions-row">
          <button type="button" class="secondary" id="export-cancel" data-i18n="cancelButton"></button>
          <button type="submit" class="primary" id="export-submit" data-i18n="exportGenerate"></button>
        </div>
        <p class="muted" id="export-message"></p>
        <div id="export-result" style="display:none; padding:12px; border:1px dashed var(--border); border-radius:10px;">
          <p class="muted" data-i18n="exportReady"></p>
          <p><a id="export-link" href="#" target="_blank" rel="noopener"></a></p>
        </div>
      </form>
    </div>
  </div>
  <script>
  (function () {
    'use strict';

    const MAX_RECEIPT_BYTES = 5 * 1024 * 1024;
    const CASH_CATEGORIES = {
      IN: [
        { value: 'CashSale', labelKey: 'cashCategoryCashSale' },
        { value: 'KnetSale', labelKey: 'cashCategoryKnetSale' },
        { value: 'Deposit', labelKey: 'cashCategoryDeposit' },
        { value: 'OtherIncome', labelKey: 'cashCategoryOtherIncome' }
      ],
      OUT: [
        { value: 'Expense', labelKey: 'cashCategoryExpense' },
        { value: 'CashOut', labelKey: 'cashCategoryCashOut' }
      ]
    };

    const translations = {
      en: {
        appTitle: 'Sales & Cash Dashboard',
        tabSales: 'Sales',
        tabCash: 'Cash',
        languageEnglish: 'English',
        languageArabic: 'العربية',
        salesStatTotalSales: 'Total sales',
        salesStatNetIncome: 'Net income: {{value}}',
        salesStatKnetSales: 'KNET sales',
        salesStatKnetPending: 'Pending KNET: {{count}} / {{value}}',
        salesStatCashSales: 'Cash sales',
        salesStatCashHint: 'Cash collected the same day.',
        salesStatExpenses: 'Expenses',
        salesStatOverdue: 'Overdue KNET: {{count}}',
        salesSearchPlaceholder: 'Search by date, amount, or note...',
        salesFilterPending: 'Pending KNET only',
        refreshButton: 'Refresh',
        exportButton: 'Export',
        exportTitleSales: 'Export Sales Report',
        exportTitleCash: 'Export Cash Report',
        exportFrom: 'From date',
        exportTo: 'To date',
        exportFormat: 'Format',
        exportDataset: 'Dataset',
        datasetSales: 'Sales',
        datasetCash: 'Cash',
        datasetBoth: 'Both',
        exportRange: 'Quick range',
        rangeThisMonth: 'This Month',
        rangeLastMonth: 'Last Month',
        rangeCustom: 'Custom',
        exportExcel: 'Excel (.xlsx)',
        exportPdf: 'PDF (.pdf)',
        exportGenerate: 'Generate report',
        exportReady: 'Your report is ready. Click to open/download:',
        exportWorking: 'Generating…',
        cancelButton: 'Cancel',
        brandLabel: 'Brand',
        brandBlue: 'Blue',
        brandEmerald: 'Emerald',
        brandPurple: 'Purple',
        brandAmber: 'Amber',
        salesColDate: 'Date',
        salesColTotal: 'Total',
        salesColKnet: 'KNET',
        salesColCash: 'Cash',
        salesColExpenses: 'Expenses',
        salesColNet: 'Net',
        salesColKnetStatus: 'KNET status',
        salesColReceipt: 'Receipt',
        salesColNotes: 'Notes',
        salesColActions: 'Actions',
        salesEmptyState: 'No sales records yet.',
        salesEntryCashTab: 'Record cash sale',
        salesEntryKnetTab: 'Record KNET sale',
        salesEntryExpenseTab: 'Record expense',
        salesEntryReceivedTab: 'KNET received',
        salesFormDate: 'Date',
        salesFormCashSales: 'Cash amount',
        salesFormNotes: 'Notes',
        resetButton: 'Reset',
        saveButton: 'Save',
        salesFormTotalSales: 'Total sales',
        salesFormTotalHint: 'Optional - leave blank to auto-match the KNET amount.',
        salesFormKnetSales: 'KNET amount',
        salesFormKnetHint: 'Amount collected via KNET (this will be reimbursed).',
        salesFormExpectedDate: 'Expected deposit',
        salesFormExpectedHint: 'Defaults to 10 days after the sale.',
        salesFormReceivedDate: 'Received date',
        salesFormReceivedHint: 'Fill when deposit arrives.',
        salesFormReceipt: 'Receipt image',
        salesFormReceiptHint: 'Optional JPG/PNG up to 5 MB.',
        salesFormMarkReceived: 'Mark as received immediately',
        salesFormExpenses: 'Expense amount',
        salesFormExpenseNotes: 'Expense details',
        salesReceivedId: 'Sales record ID',
      salesReceivedHelp: 'Enter the amount received today. It will be applied oldest-first across all pending KNET.',
        salesMarkReceivedButton: 'Mark received',
        salesReceivedPending: 'Pending amount',
        salesReceivedAmount: 'Amount received today',
        salesPromptAmount: 'Enter amount received today',
        salesReceivedAmountError: 'Enter a valid amount not exceeding pending.',
        pendingLabel: 'pending',
        successSaved: 'Saved successfully.',
        successMarked: 'Marked as received.',
        errorGeneric: 'Something went wrong. Please try again.',
        errorRuntimeUnavailable: 'Google Apps Script runtime is unavailable.',
        salesErrorAmountRequired: 'Amount is required.',
        salesErrorIdRequired: 'Record ID is required.',
        salesErrorReceiptTooLarge: 'Receipt image exceeds 5 MB.',
        salesReceiptView: 'View receipt',
        salesReceiptNone: 'No receipt',
        confirmMarkReceived: 'Mark this KNET payment as received?',
        promptReceivedDate: 'Received date (YYYY-MM-DD). Leave blank for today.',
        knetNotApplicable: 'No KNET sale',
        knetStatusLabel: 'Status',
        knetPendingGeneric: 'Pending',
        knetDueIn: 'Due in {{days}} day(s)',
        knetDueToday: 'Due today',
        knetOverdue: 'Overdue by {{days}} day(s)',
        knetReceived: 'Received',
        knetReceivedOnTime: 'Received on time',
        knetReceivedEarly: 'Received {{days}} day(s) early',
        knetReceivedLate: 'Received {{days}} day(s) late',
        expectedLabel: 'Expected',
        receivedLabel: 'Received',
        salesActionMark: 'Mark received',
        cashStatTotalIn: 'Money in',
        cashStatPendingKnet: 'Pending KNET: {{count}} / {{value}}',
        cashStatTotalOut: 'Money out',
        cashStatProfitTransfer: 'Transferred to profit: {{count}} / {{value}}',
        cashStatInHand: 'Cash in hand',
        cashStatHint: 'Money available after pending KNET and expenses.',
        cashSearchPlaceholder: 'Search by date, category, or note...',
        cashFilterPending: 'Pending KNET only',
        cashColDate: 'Date',
        cashColDirection: 'Direction',
        cashColCategory: 'Category',
        cashColAmount: 'Amount',
        cashColStatus: 'Status',
        cashColKnet: 'KNET',
        cashColProfit: 'Profit transfer',
        cashColNotes: 'Notes',
        cashColActions: 'Actions',
        cashEmptyState: 'No cash entries yet.',
        cashFormTitle: 'Record cash movement',
        cashFormDate: 'Date',
        cashFormDirection: 'Direction',
        directionIn: 'Money in',
        directionOut: 'Money out',
        cashFormCategory: 'Category',
        cashFormAmount: 'Amount',
        cashFormExpectedDate: 'Expected KNET deposit',
        cashFormReceivedDate: 'Received date',
        cashFormMarkReceived: 'Mark KNET as received',
        cashFormDescription: 'Description',
        cashFormNotes: 'Notes',
        cashActionMark: 'Mark received',
        cashActionTransfer: 'Transfer to profits',
        cashErrorAmountRequired: 'Amount is required.',
        confirmTransfer: 'Transfer this amount to profits?',
        confirmReceived: 'Mark this KNET entry as received?',
        promptTransferDate: 'Transfer date (YYYY-MM-DD). Leave blank for today.',
        cashStatusPending: 'Pending',
        cashStatusReceived: 'Received',
        cashStatusPosted: 'Posted',
        cashStatusTransferred: 'Transferred',
        cashKnetNone: 'Not a KNET entry',
        cashProfitNotTransferred: 'Not transferred',
        cashProfitTransferred: 'Transferred on {{date}}',
        cashCategoryCashSale: 'Cash sale',
        cashCategoryKnetSale: 'KNET sale',
        cashCategoryDeposit: 'Bank deposit',
        cashCategoryOtherIncome: 'Other income',
        cashCategoryExpense: 'Expense',
        cashCategoryCashOut: 'Cash withdrawal'
      },
      ar: {
        appTitle: 'لوحة المبيعات والنقد',
        tabSales: 'المبيعات',
        tabCash: 'النقد',
        languageEnglish: 'English',
        languageArabic: 'العربية',
        salesStatTotalSales: 'إجمالي المبيعات',
        salesStatNetIncome: 'صافي الدخل: {{value}}',
        salesStatKnetSales: 'مبيعات كي نت',
        salesStatKnetPending: 'كي نت معلّقة: {{count}} / {{value}}',
        salesStatCashSales: 'مبيعات نقدية',
        salesStatCashHint: 'النقد المحصل في نفس اليوم.',
        salesStatExpenses: 'المصروفات',
        salesStatOverdue: 'كي نت متأخرة: {{count}}',
        salesSearchPlaceholder: 'ابحث بالتاريخ أو المبلغ أو الملاحظات...',
        salesFilterPending: 'عرض العمليات المعلقة فقط',
        refreshButton: 'تحديث',
        exportButton: 'تصدير',
        exportTitleSales: 'تصدير تقرير المبيعات',
        exportTitleCash: 'تصدير تقرير النقد',
        exportFrom: 'من تاريخ',
        exportTo: 'إلى تاريخ',
        exportFormat: 'الصيغة',
        exportDataset: 'المجموعة',
        datasetSales: 'المبيعات',
        datasetCash: 'النقد',
        datasetBoth: 'كلاهما',
        exportRange: 'مدى سريع',
        rangeThisMonth: 'هذا الشهر',
        rangeLastMonth: 'الشهر الماضي',
        rangeCustom: 'مخصص',
        exportExcel: 'إكسل (.xlsx)',
        exportPdf: 'PDF (.pdf)',
        exportGenerate: 'إنشاء التقرير',
        exportReady: 'التقرير جاهز. اضغط للفتح/التنزيل:',
        exportWorking: 'جارٍ الإنشاء…',
        cancelButton: 'إلغاء',
        brandLabel: 'العلامة',
        brandBlue: 'أزرق',
        brandEmerald: 'زمردي',
        brandPurple: 'بنفسجي',
        brandAmber: 'عنبر',
        salesColDate: 'التاريخ',
        salesColTotal: 'الإجمالي',
        salesColKnet: 'كي نت',
        salesColCash: 'نقداً',
        salesColExpenses: 'مصروفات',
        salesColNet: 'الصافي',
        salesColKnetStatus: 'حالة كي نت',
        salesColReceipt: 'الإيصال',
        salesColNotes: 'ملاحظات',
        salesColActions: 'إجراءات',
        salesEmptyState: 'لا توجد سجلات مبيعات بعد.',
        salesEntryCashTab: 'تسجيل بيع نقدي',
        salesEntryKnetTab: 'تسجيل بيع كي نت',
        salesEntryExpenseTab: 'تسجيل مصروف',
        salesEntryReceivedTab: 'استلام كي نت',
        salesFormDate: 'التاريخ',
        salesFormCashSales: 'المبلغ النقدي',
        salesFormNotes: 'ملاحظات',
        resetButton: 'تفريغ',
        saveButton: 'حفظ',
        salesFormTotalSales: 'إجمالي المبيعات',
        salesFormTotalHint: 'اختياري - اتركه فارغاً ليطابق تلقائياً مبلغ كي نت.',
        salesFormKnetSales: 'مبلغ كي نت',
        salesFormKnetHint: 'هذا هو المبلغ المتوقع استلامه من كي نت.',
        salesFormExpectedDate: 'تاريخ الإيداع المتوقع',
        salesFormExpectedHint: 'يفترض بعد 10 أيام من تاريخ البيع.',
        salesFormReceivedDate: 'تاريخ الاستلام',
        salesFormReceivedHint: 'امله عند وصول الإيداع.',
        salesFormReceipt: 'صورة الإيصال',
        salesFormReceiptHint: 'اختياري: JPG/PNG حتى 5 ميجابايت.',
        salesFormMarkReceived: 'اعتبارها مستلمة فوراً',
        salesFormExpenses: 'قيمة المصروف',
        salesFormExpenseNotes: 'تفاصيل المصروف',
        salesReceivedId: 'معرّف سجل المبيعات',
      salesReceivedHelp: 'أدخل المبلغ المستلم اليوم. سيتم توزيعه على العمليات المعلّقة الأقدم أولاً.',
        salesMarkReceivedButton: 'تأكيد الاستلام',
        salesReceivedPending: 'المبلغ المعلّق',
        salesReceivedAmount: 'المبلغ المستلم اليوم',
        salesPromptAmount: 'أدخل المبلغ المستلم اليوم',
        salesReceivedAmountError: 'أدخل مبلغاً صحيحاً لا يتجاوز المبلغ المعلق.',
        pendingLabel: 'معلق',
        successSaved: 'تم الحفظ بنجاح.',
        successMarked: 'تم التأكيد على الاستلام.',
        errorGeneric: 'حدث خطأ، حاول مرة أخرى.',
        errorRuntimeUnavailable: 'خدمة Google Apps Script غير متاحة.',
        salesErrorAmountRequired: 'المبلغ مطلوب.',
        salesErrorIdRequired: 'مطلوب إدخال المعرّف.',
        salesErrorReceiptTooLarge: 'حجم الإيصال يتجاوز 5 ميجابايت.',
        salesReceiptView: 'عرض الإيصال',
        salesReceiptNone: 'لا يوجد إيصال',
        confirmMarkReceived: 'تأكيد استلام عملية كي نت؟',
        promptReceivedDate: 'تاريخ الاستلام (YYYY-MM-DD). اتركه فارغاً لليوم.',
        knetNotApplicable: 'لا توجد عملية كي نت',
        knetStatusLabel: 'الحالة',
        knetPendingGeneric: 'معلق',
        knetDueIn: 'يستحق خلال {{days}} يوم',
        knetDueToday: 'مستحق اليوم',
        knetOverdue: 'متأخر {{days}} يوم',
        knetReceived: 'تم الاستلام',
        knetReceivedOnTime: 'تم الاستلام في الوقت المحدد',
        knetReceivedEarly: 'تم الاستلام قبل الموعد بـ {{days}} يوم',
        knetReceivedLate: 'تم الاستلام بعد الموعد بـ {{days}} يوم',
        expectedLabel: 'المتوقع',
        receivedLabel: 'تاريخ الاستلام',
        salesActionMark: 'تأكيد الاستلام',
        cashStatTotalIn: 'المبالغ الواردة',
        cashStatPendingKnet: 'كي نت معلّقة: {{count}} / {{value}}',
        cashStatTotalOut: 'المبالغ الصادرة',
        cashStatProfitTransfer: 'حوّل للأرباح: {{count}} / {{value}}',
        cashStatInHand: 'النقد المتوفر',
        cashStatHint: 'الرصيد المتاح بعد استبعاد كي نت المعلقة والمصروفات.',
        cashSearchPlaceholder: 'ابحث بالتاريخ أو التصنيف أو الملاحظات...',
        cashFilterPending: 'عرض كي نت المعلقة فقط',
        cashColDate: 'التاريخ',
        cashColDirection: 'الاتجاه',
        cashColCategory: 'التصنيف',
        cashColAmount: 'المبلغ',
        cashColStatus: 'الحالة',
        cashColKnet: 'كي نت',
        cashColProfit: 'تحويل الأرباح',
        cashColNotes: 'ملاحظات',
        cashColActions: 'إجراءات',
        cashEmptyState: 'لا توجد سجلات نقدية بعد.',
        cashFormTitle: 'تسجيل حركة نقدية',
        cashFormDate: 'التاريخ',
        cashFormDirection: 'الاتجاه',
        directionIn: 'وارد',
        directionOut: 'صادر',
        cashFormCategory: 'التصنيف',
        cashFormAmount: 'المبلغ',
        cashFormExpectedDate: 'تاريخ إيداع كي نت المتوقع',
        cashFormReceivedDate: 'تاريخ استلام كي نت',
        cashFormMarkReceived: 'اعتبار كي نت مستلمة',
        cashFormDescription: 'الوصف',
        cashFormNotes: 'ملاحظات',
        cashActionMark: 'تأكيد الاستلام',
        cashActionTransfer: 'تحويل للأرباح',
        cashErrorAmountRequired: 'المبلغ مطلوب.',
        confirmTransfer: 'تحويل هذا المبلغ إلى الأرباح؟',
        confirmReceived: 'تأكيد استلام عملية كي نت؟',
        promptTransferDate: 'تاريخ التحويل (YYYY-MM-DD). اتركه لليوم.',
        cashStatusPending: 'معلق',
        cashStatusReceived: 'تم الاستلام',
        cashStatusPosted: 'مُسجل',
        cashStatusTransferred: 'محول',
        cashKnetNone: 'ليست عملية كي نت',
        cashProfitNotTransferred: 'لم يتم التحويل',
        cashProfitTransferred: 'حوّل بتاريخ {{date}}',
        cashCategoryCashSale: 'مبيعات نقدية',
        cashCategoryKnetSale: 'مبيعات كي نت',
        cashCategoryDeposit: 'إيداع بنكي',
        cashCategoryOtherIncome: 'دخل آخر',
        cashCategoryExpense: 'مصروف',
        cashCategoryCashOut: 'سحب نقدي'
      }
    };
    const state = {
      language: 'en',
      module: 'sales',
      sales: {
        rows: [],
        summary: createDefaultSalesSummary(),
        filters: { search: '', pendingOnly: false },
        loading: false
      },
      cash: {
        rows: [],
        summary: createDefaultCashSummary(),
        filters: { search: '', pendingOnly: false },
        loading: false
      }
    };

    const dom = {
      tabButtons: document.querySelectorAll('.tab-switch button'),
      modules: {
        sales: document.getElementById('sales-module'),
        cash: document.getElementById('cash-module')
      },
      languageButtons: document.querySelectorAll('.language-switch button'),
      themeToggle: document.getElementById('theme-toggle'),
      brandSelect: document.getElementById('brand-select'),
      mobile: {
        refreshBtn: document.getElementById('mobile-refresh-btn'),
        exportBtn: document.getElementById('mobile-export-btn')
      },
      export: {
        modal: document.getElementById('export-modal'),
        form: document.getElementById('export-form'),
        title: document.getElementById('export-modal-title'),
        from: document.getElementById('export-from'),
        to: document.getElementById('export-to'),
        format: document.getElementById('export-format'),
        dataset: document.getElementById('export-dataset'),
        range: document.getElementById('export-range'),
        submit: document.getElementById('export-submit'),
        cancel: document.getElementById('export-cancel'),
        close: document.getElementById('export-close'),
        message: document.getElementById('export-message'),
        result: document.getElementById('export-result'),
        link: document.getElementById('export-link')
      },
      sales: {
        stats: {
          totalSales: document.getElementById('sales-stat-total-sales'),
          netIncome: document.getElementById('sales-stat-net-income'),
          knetSales: document.getElementById('sales-stat-knet-sales'),
          knetPending: document.getElementById('sales-stat-knet-pending'),
          cashSales: document.getElementById('sales-stat-cash-sales'),
          expenses: document.getElementById('sales-stat-expenses'),
          overdue: document.getElementById('sales-stat-overdue')
        },
        search: document.getElementById('sales-search-input'),
        fromDate: document.getElementById('sales-from-date'),
        toDate: document.getElementById('sales-to-date'),
        pendingToggle: document.getElementById('sales-pending-toggle'),
        refreshBtn: document.getElementById('sales-refresh-btn'),
        tableBody: document.getElementById('sales-records-body'),
        empty: document.getElementById('sales-empty-state'),
        entryTabs: document.querySelectorAll('[data-sales-entry-tab]'),
        entryForms: {
          cash: document.getElementById('sales-form-cash'),
          knet: document.getElementById('sales-form-knet'),
          expense: document.getElementById('sales-form-expense'),
          received: document.getElementById('sales-form-received')
      },
      messages: {
        cash: document.getElementById('sales-message-cash'),
        knet: document.getElementById('sales-message-knet'),
        expense: document.getElementById('sales-message-expense'),
        received: document.getElementById('sales-message-received')
      },
      entryPanel: document.querySelector('.entry-panel'),
      inputs: {
        cashDate: document.getElementById('sales-cash-date'),
        cashAmount: document.getElementById('sales-cash-amount'),
          cashNotes: document.getElementById('sales-cash-notes'),
          knetDate: document.getElementById('sales-knet-date'),
          knetTotal: document.getElementById('sales-knet-total'),
          knetAmount: document.getElementById('sales-knet-amount'),
          knetExpected: document.getElementById('sales-knet-expected'),
          knetReceived: document.getElementById('sales-knet-received'),
          knetMark: document.getElementById('sales-knet-mark'),
          knetNotes: document.getElementById('sales-knet-notes'),
          knetReceipt: document.getElementById('sales-knet-receipt'),
          expenseDate: document.getElementById('sales-expense-date'),
          expenseAmount: document.getElementById('sales-expense-amount'),
          expenseNotes: document.getElementById('sales-expense-notes'),
        receivedDate: document.getElementById('sales-received-date'),
        receivedAmount: document.getElementById('sales-received-amount'),
        receivedPending: document.getElementById('sales-received-pending')
      }
    },
      cash: {
        stats: {
          totalIn: document.getElementById('cash-stat-total-in'),
          pending: document.getElementById('cash-stat-pending'),
          totalOut: document.getElementById('cash-stat-total-out'),
          profit: document.getElementById('cash-stat-profit'),
          inHand: document.getElementById('cash-stat-in-hand')
        },
        search: document.getElementById('cash-search-input'),
        pendingToggle: document.getElementById('cash-pending-toggle'),
        refreshBtn: document.getElementById('cash-refresh-btn'),
        tableBody: document.getElementById('cash-records-body'),
        empty: document.getElementById('cash-empty-state'),
        form: document.getElementById('cash-entry-form'),
        message: document.getElementById('cash-form-message'),
        date: document.getElementById('cash-form-date'),
        direction: document.getElementById('cash-form-direction'),
        category: document.getElementById('cash-form-category'),
        amount: document.getElementById('cash-form-amount'),
        expected: document.getElementById('cash-form-expected'),
        received: document.getElementById('cash-form-received'),
        markReceived: document.getElementById('cash-form-mark-received'),
        description: document.getElementById('cash-form-description'),
        notes: document.getElementById('cash-form-notes'),
        resetBtn: document.getElementById('cash-reset-btn'),
        submitBtn: document.getElementById('cash-submit-btn'),
      knetFields: document.querySelectorAll('.cash-knet-only')
    }
  };
  let exportDataset = 'sales';
    let salesRefreshTimer = null;
    let cashRefreshTimer = null;

    function createDefaultSalesSummary() {
      return {
        totalSales: 0,
        totalKnetSales: 0,
        totalCashSales: 0,
        totalExpenses: 0,
        netIncome: 0,
        pendingKnetAmount: 0,
        pendingKnetCount: 0,
        overdueKnetCount: 0,
        receivedKnetAmount: 0
      };
    }

    function createDefaultCashSummary() {
      return {
        totalIn: 0,
        totalOut: 0,
        cashInHand: 0,
        pendingKnetAmount: 0,
        pendingKnetCount: 0,
        overdueKnetCount: 0,
        profitTransferredAmount: 0,
        profitTransferredCount: 0
      };
    }
    function t(key) {
      const pack = translations[state.language] || translations.en;
      return (pack && pack[key]) || translations.en[key] || key;
    }
    function formatTemplate(key, values) {
      let output = t(key);
      return output.replace(/\{\{(\w+)\}\}/g, function (match, token) {
        if (!values || values[token] == null) {
          return match;
        }
        return String(values[token]);
      });
    }
    function escapeHtml(value) {
      return String(value == null ? '' : value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/\r?\n/g, '<br>');
    }
    function escapeAttr(value) {
      return String(value == null ? '' : value)
        .replace(/&/g, '&amp;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
    function formatMoney(value) {
      const number = Number(value || 0);
      const locale = state.language === 'ar' ? 'ar' : 'en';
      return number.toLocaleString(locale, { minimumFractionDigits: 3, maximumFractionDigits: 3 });
    }
    function formatDate(iso) {
      if (!iso) return '--';
      const date = new Date(iso + 'T00:00:00');
      if (isNaN(date.getTime())) return iso;
      const locale = state.language === 'ar' ? 'ar' : 'en';
      return date.toLocaleDateString(locale, { year: 'numeric', month: 'short', day: 'numeric' });
    }
    function daysBetweenIso_(fromIso, toIso) {
      if (!fromIso || !toIso) return 0;
      const a = new Date(fromIso + 'T00:00:00');
      const b = new Date(toIso + 'T00:00:00');
      if (isNaN(a.getTime()) || isNaN(b.getTime())) return 0;
      const MS_PER_DAY = 24 * 60 * 60 * 1000;
      return Math.round((b.getTime() - a.getTime()) / MS_PER_DAY);
    }
    function todayIso() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }
    function readNumberInput(input) {
      if (!input) return 0;
      const value = Number(input.value);
      return isFinite(value) ? value : 0;
    }
    function roundMoney(value) {
      const num = Number(value);
      if (!isFinite(num)) return 0;
      return Math.round(num * 1000) / 1000;
    }
    /**
     * Ensures the relationship between total, KNET, and cash portions stays consistent.
     * The UI may omit or mis-order amounts, so we reconcile everything in one place.
     */
    function normalizeTenderBreakdown(totalInput, knetInput) {
      const knet = Math.max(roundMoney(knetInput), 0);
      const totalCandidate = Math.max(roundMoney(totalInput), 0);
      const effectiveTotal = knet > 0 ? Math.max(knet, totalCandidate) : totalCandidate;
      const cashPortion = Math.max(effectiveTotal - knet, 0);
      return {
        totalSales: roundMoney(effectiveTotal),
        knetSales: knet,
        cashSales: roundMoney(cashPortion)
      };
    }
    function ensureRuntime() {
      return typeof google !== 'undefined' && google.script && google.script.run;
    }
    function setActiveModule(module) {
      state.module = module;
      Object.keys(dom.modules).forEach(function (name) {
        const isActive = name === module;
        if (dom.modules[name]) {
          dom.modules[name].classList.toggle('active', isActive);
        }
      });
      dom.tabButtons.forEach(function (button) {
        const target = button.getAttribute('data-tab');
        button.classList.toggle('active', target === module);
      });
    }
    function applyTranslations() {
      document.documentElement.lang = state.language;
      document.body.dir = state.language === 'ar' ? 'rtl' : 'ltr';

      document.querySelectorAll('[data-i18n]').forEach(function (el) {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });

      document.querySelectorAll('[data-i18n-placeholder]').forEach(function (el) {
        const key = el.getAttribute('data-i18n-placeholder');
        el.setAttribute('placeholder', t(key));
      });

      dom.languageButtons.forEach(function (button) {
        const lang = button.getAttribute('data-lang');
        button.classList.toggle('active', lang === state.language);
      });

      populateCashCategories();
      renderSalesStats();
      renderSalesTable();
      renderCashStats();
      renderCashTable();
      updateSalesReceivedUI();
    }

    function applyTheme(theme) {
      const root = document.documentElement;
      const next = theme === 'dark' ? 'dark' : 'light';
      if (next === 'dark') {
        root.setAttribute('data-theme', 'dark');
      } else {
        root.removeAttribute('data-theme');
      }
      try { localStorage.setItem('theme', next); } catch (e) {}
      const label = document.getElementById('theme-toggle-label');
      if (label) label.textContent = next === 'dark' ? 'Light' : 'Dark';
    }

    function applyBrand(preset) {
      const p = String(preset || 'blue');
      const rootStyle = document.documentElement.style;
      let primary = '#2563eb', accent = '#1d4ed8';
      if (p === 'emerald') { primary = '#10b981'; accent = '#059669'; }
      else if (p === 'purple') { primary = '#8b5cf6'; accent = '#7c3aed'; }
      else if (p === 'amber') { primary = '#f59e0b'; accent = '#d97706'; }
      rootStyle.setProperty('--primary', primary);
      rootStyle.setProperty('--accent', accent);
      try { localStorage.setItem('brandPreset', p); } catch (e) {}
      if (dom.brandSelect) dom.brandSelect.value = p;
    }
    function updateSalesReceivedUI() {
      if (!dom.sales.inputs.receivedPending) return;
      const totalPending = Number(state.sales.summary && state.sales.summary.pendingKnetAmount || 0);
      const pending = totalPending;
      dom.sales.inputs.receivedPending.textContent = formatMoney(pending);
      if (dom.sales.inputs.receivedAmount) {
        dom.sales.inputs.receivedAmount.setAttribute('max', String(pending));
        if (!dom.sales.inputs.receivedAmount.value) {
          dom.sales.inputs.receivedAmount.value = pending ? String(pending) : '';
        }
      }
    }
    function setSalesEntryTab(tab) {
      dom.sales.entryTabs.forEach(function (button) {
        const key = button.getAttribute('data-sales-entry-tab');
        button.classList.toggle('active', key === tab);
      });
      Object.keys(dom.sales.entryForms).forEach(function (name) {
        const form = dom.sales.entryForms[name];
        const value = form ? form.getAttribute('data-sales-entry') : '';
        if (form) {
          form.classList.toggle('active', value === tab);
        }
      });
    }
    function setSalesMessage(type, message, isError) {
      const target = dom.sales.messages[type];
      if (!target) return;
      target.textContent = message || '';
      if (message) {
        target.style.color = isError ? '#b91c1c' : '#15803d';
      } else {
        target.style.color = 'var(--muted)';
      }
    }
    function setCashMessage(message, isError) {
      if (!dom.cash.message) return;
      dom.cash.message.textContent = message || '';
      if (message) {
        dom.cash.message.style.color = isError ? '#b91c1c' : '#15803d';
      } else {
        dom.cash.message.style.color = 'var(--muted)';
      }
    }
    function setFormDisabled(form, disabled) {
      if (!form) return;
      Array.prototype.forEach.call(form.querySelectorAll('input, select, textarea, button'), function (el) {
        el.disabled = !!disabled;
      });
    }

    function renderSalesStats() {
      const s = state.sales.summary;
      if (dom.sales.stats.totalSales) dom.sales.stats.totalSales.textContent = formatMoney(s.totalSales);
      if (dom.sales.stats.netIncome) dom.sales.stats.netIncome.textContent = formatTemplate('salesStatNetIncome', { value: formatMoney(s.netIncome) });
      if (dom.sales.stats.knetSales) dom.sales.stats.knetSales.textContent = formatMoney(s.totalKnetSales);
      if (dom.sales.stats.knetPending) dom.sales.stats.knetPending.textContent = formatTemplate('salesStatKnetPending', { count: s.pendingKnetCount, value: formatMoney(s.pendingKnetAmount) });
      if (dom.sales.stats.cashSales) dom.sales.stats.cashSales.textContent = formatMoney(s.totalCashSales);
      if (dom.sales.stats.expenses) dom.sales.stats.expenses.textContent = formatMoney(s.totalExpenses);
      if (dom.sales.stats.overdue) dom.sales.stats.overdue.textContent = formatTemplate('salesStatOverdue', { count: s.overdueKnetCount });
    }

    function renderSalesTable() {
      const rows = state.sales.rows || [];
      if (!rows.length) {
        if (dom.sales.tableBody) dom.sales.tableBody.innerHTML = '';
        if (dom.sales.empty) dom.sales.empty.style.display = '';
        return;
      }
      if (dom.sales.empty) dom.sales.empty.style.display = 'none';
      const html = rows.map(renderSalesRow).join('');
      if (dom.sales.tableBody) dom.sales.tableBody.innerHTML = html;
    }

    function renderSalesRow(row) {
      const knetInfo = renderKnet(row);
      const receiptInfo = row.receiptUrl ? '<a target="_blank" href="' + escapeAttr(row.receiptUrl) + '">' + escapeHtml(t('salesReceiptView')) + '</a>' : '<span class="muted">' + escapeHtml(t('salesReceiptNone')) + '</span>';
      const notes = row.expenseNotes || row.notes ? escapeHtml(row.expenseNotes || row.notes) : '<span class="muted">--</span>';
      const actions = renderSalesActions(row);
      return [
        '<tr>',
        '<td>' + escapeHtml(formatDate(row.reportDate)) + '</td>',
        '<td>' + escapeHtml(formatMoney(row.totalSales)) + '</td>',
        '<td>' + escapeHtml(formatMoney(row.knetSales)) + '</td>',
        '<td>' + escapeHtml(formatMoney(row.cashSales)) + '</td>',
        '<td>' + escapeHtml(formatMoney(row.expenses)) + '</td>',
        '<td>' + escapeHtml(formatMoney(row.netSales)) + '</td>',
        '<td>' + knetInfo + '</td>',
        '<td>' + receiptInfo + '</td>',
        '<td>' + notes + '</td>',
        '<td class="actions">' + actions + '</td>',
        '</tr>'
      ].join('');
    }

    function renderKnet(row) {
      if (row.knetSales <= 0) {
        return '<span class="muted">' + escapeHtml(t('knetNotApplicable')) + '</span>';
      }
      const status = '<span class="tag ' + (row.knetStatus === 'Received' ? 'in' : (row.knetIsOverdue ? 'out' : 'pending')) + '">' + escapeHtml(describeKnetStatus(row)) + '</span>';
      const parts = [status];
      if (row.knetExpectedDate) {
        parts.push('<div>' + escapeHtml(t('expectedLabel')) + ': ' + escapeHtml(formatDate(row.knetExpectedDate)) + '</div>');
      }
      if (row.knetReceivedDate) {
        parts.push('<div>' + escapeHtml(t('receivedLabel')) + ': ' + escapeHtml(formatDate(row.knetReceivedDate)) + '</div>');
      }
      if (row.knetStatus === 'Pending') {
        const pending = Math.max(Number(row.knetSales || 0) - Number(row.knetReceivedAmount || 0), 0);
        parts.push('<div class="pill pill-warn">' + escapeHtml(formatMoney(pending)) + ' ' + escapeHtml(t('pendingLabel')) + '</div>');
      }
      return parts.join('');
    }

    function describeKnetStatus(row) {
      const expected = row.knetExpectedDate;
      const received = row.knetReceivedDate;
      if (received) {
        const days = daysBetweenIso_(expected, received);
        if (days < 0) return formatTemplate('knetReceivedEarly', { days: Math.abs(days) });
        if (days === 0) return t('knetReceivedOnTime');
        return formatTemplate('knetReceivedLate', { days: days });
      }
      if (!expected) return t('knetPendingGeneric');
      const daysTo = daysBetweenIso_(todayIso(), expected);
      if (daysTo < 0) return formatTemplate('knetOverdue', { days: Math.abs(daysTo) });
      if (daysTo === 0) return t('knetDueToday');
      return formatTemplate('knetDueIn', { days: daysTo });
    }

    function renderSalesActions(row) {
      if (row.knetSales > 0 && row.knetStatus === 'Pending') {
        return '<button type="button" data-action="sales-mark" data-id="' + escapeAttr(row.id) + '">' + escapeHtml(t('salesActionMark')) + '</button>';
      }
      return '<span class="muted">--</span>';
    }

    function renderCashStats() {
      const s = state.cash.summary;
      if (dom.cash.stats.totalIn) dom.cash.stats.totalIn.textContent = formatMoney(s.totalIn);
      if (dom.cash.stats.pending) dom.cash.stats.pending.textContent = formatTemplate('cashStatPendingKnet', { count: s.pendingKnetCount, value: formatMoney(s.pendingKnetAmount) });
      if (dom.cash.stats.totalOut) dom.cash.stats.totalOut.textContent = formatMoney(s.totalOut);
      if (dom.cash.stats.profit) dom.cash.stats.profit.textContent = formatTemplate('cashStatProfitTransfer', { count: s.profitTransferredCount, value: formatMoney(s.profitTransferredAmount) });
      if (dom.cash.stats.inHand) dom.cash.stats.inHand.textContent = formatMoney(s.cashInHand);
    }

    function renderCashTable() {
      const rows = state.cash.rows || [];
      if (!rows.length) {
        dom.cash.tableBody.innerHTML = '';
        dom.cash.empty.style.display = '';
        return;
      }
      dom.cash.empty.style.display = 'none';
      const html = rows.map(renderCashRow).join('');
      dom.cash.tableBody.innerHTML = html;
    }

    function renderCashRow(row) {
      const directionTag = '<span class="tag ' + (row.direction === 'IN' ? 'in' : 'out') + '">' +
        escapeHtml(row.direction === 'IN' ? t('directionIn') : t('directionOut')) + '</span>';
      const statusTag = '<span class="tag ' + statusClass(row.status) + '">' + escapeHtml(describeCashStatus(row.status)) + '</span>';
      const knetInfo = renderCashKnet(row);
      const profitInfo = renderCashProfit(row);
      const notes = row.notes ? escapeHtml(row.notes) : '<span class="muted">--</span>';
      const actions = renderCashActions(row);
      return [
        '<tr>',
        '<td>' + escapeHtml(formatDate(row.entryDate)) + '</td>',
        '<td>' + directionTag + '</td>',
        '<td>' + escapeHtml(describeCashCategory(row.category)) + '</td>',
        '<td>' + escapeHtml(formatMoney(row.amount)) + '</td>',
        '<td>' + statusTag + '</td>',
        '<td>' + knetInfo + '</td>',
        '<td>' + profitInfo + '</td>',
        '<td>' + notes + '</td>',
        '<td class="actions">' + actions + '</td>',
        '</tr>'
      ].join('');
    }

    function statusClass(status) {
      if (status === 'Received') return 'in';
      if (status === 'Transferred') return 'out';
      return 'pending';
    }

    function describeCashStatus(status) {
      switch (status) {
        case 'Pending': return t('cashStatusPending');
        case 'Received': return t('cashStatusReceived');
        case 'Transferred': return t('cashStatusTransferred');
        default: return t('cashStatusPosted');
      }
    }

    function renderCashKnet(row) {
      if (row.category !== 'KnetSale') {
        return '<span class="muted">' + escapeHtml(t('cashKnetNone')) + '</span>';
      }
      const parts = [];
      parts.push('<div>' + escapeHtml(describeKnetStatus(row)) + '</div>');
      if (row.knetExpectedDate) {
        parts.push('<div>' + escapeHtml(t('expectedLabel')) + ': ' + escapeHtml(formatDate(row.knetExpectedDate)) + '</div>');
      }
      if (row.knetReceivedDate) {
        parts.push('<div>' + escapeHtml(t('receivedLabel')) + ': ' + escapeHtml(formatDate(row.knetReceivedDate)) + '</div>');
      }
      return parts.join('');
    }

    function renderCashProfit(row) {
      if (!row.isIncome) {
        return '<span class="muted">--</span>';
      }
      if (row.profitTransferDate) {
        return escapeHtml(formatTemplate('cashProfitTransferred', { date: formatDate(row.profitTransferDate) }));
      }
      return '<span class="muted">' + escapeHtml(t('cashProfitNotTransferred')) + '</span>';
    }

    function renderCashActions(row) {
      const actions = [];
      if (row.category === 'KnetSale' && row.status === 'Pending') {
        actions.push('<button type="button" data-action="cash-mark" data-id="' + escapeAttr(row.id) + '">' +
          escapeHtml(t('cashActionMark')) + '</button>');
      }
      if (row.isIncome && row.status === 'Received' && !row.profitTransferDate) {
        actions.push('<button type="button" data-action="cash-transfer" data-id="' + escapeAttr(row.id) + '">' +
          escapeHtml(t('cashActionTransfer')) + '</button>');
      }
      return actions.length ? actions.join('') : '<span class="muted">--</span>';
    }

    function describeCashCategory(category) {
      switch (category) {
        case 'CashSale': return t('cashCategoryCashSale');
        case 'KnetSale': return t('cashCategoryKnetSale');
        case 'Deposit': return t('cashCategoryDeposit');
        case 'OtherIncome': return t('cashCategoryOtherIncome');
        case 'CashOut': return t('cashCategoryCashOut');
        default: return t('cashCategoryExpense');
      }
    }

    function populateCashCategories() {
      if (!dom.cash.direction || !dom.cash.category) return;
      const direction = dom.cash.direction.value === 'OUT' ? 'OUT' : 'IN';
      const previous = dom.cash.category.value;
      const options = CASH_CATEGORIES[direction] || [];
      dom.cash.category.innerHTML = options.map(function (opt) {
        return '<option value="' + opt.value + '">' + escapeHtml(t(opt.labelKey)) + '</option>';
      }).join('');
      const match = options.some(function (opt) { return opt.value === previous; });
      dom.cash.category.value = match ? previous : (options[0] ? options[0].value : '');
      updateCashKnetVisibility();
    }

    function updateCashKnetVisibility() {
      if (!dom.cash.direction || !dom.cash.category) return;
      const isKnet = dom.cash.direction.value === 'IN' && dom.cash.category.value === 'KnetSale';
      dom.cash.knetFields.forEach(function (el) {
        el.style.display = isKnet ? '' : 'none';
      });
      if (!isKnet && dom.cash.markReceived) {
        dom.cash.expected.value = '';
        dom.cash.received.value = '';
        dom.cash.markReceived.checked = false;
      }
    }

    function readFileAsBase64(file) {
      return new Promise(function (resolve, reject) {
        const reader = new FileReader();
        reader.onload = function () {
          const result = String(reader.result || '');
          resolve(result.indexOf(',') === -1 ? result : result.split(',').pop());
        };
        reader.onerror = function (err) {
          reject(err);
        };
        reader.readAsDataURL(file);
      });
    }

    function refreshSales() {
      if (!ensureRuntime()) {
        ['cash', 'knet', 'expense', 'received'].forEach(function (type) {
          setSalesMessage(type, t('errorRuntimeUnavailable'), true);
        });
        return;
      }
      state.sales.loading = true;
      if (dom.sales.refreshBtn) dom.sales.refreshBtn.disabled = true;
      const query = {
        search: state.sales.filters.search,
        pendingOnly: state.sales.filters.pendingOnly,
        fromDate: dom.sales.fromDate && dom.sales.fromDate.value ? dom.sales.fromDate.value : todayIso(),
        toDate: dom.sales.toDate && dom.sales.toDate.value ? dom.sales.toDate.value : todayIso()
      };
      google.script.run.withSuccessHandler(function (res) {
        state.sales.loading = false;
        if (dom.sales.refreshBtn) dom.sales.refreshBtn.disabled = false;
        if (res && res.ok) {
          state.sales.summary = Object.assign(createDefaultSalesSummary(), res.summary || {});
          state.sales.rows = Array.isArray(res.rows) ? res.rows : [];
          renderSalesStats();
          renderSalesTable();
          updateSalesReceivedUI();
        } else {
          alert(String((res && res.error) || t('errorGeneric')));
        }
      }).withFailureHandler(function (err) {
        state.sales.loading = false;
        if (dom.sales.refreshBtn) dom.sales.refreshBtn.disabled = false;
        alert(String((err && err.message) || t('errorGeneric')));
      }).getSalesDashboardData(query);
    }

    function refreshCash() {
      if (!ensureRuntime()) {
        setCashMessage(t('errorRuntimeUnavailable'), true);
        return;
      }
      state.cash.loading = true;
      if (dom.cash.refreshBtn) dom.cash.refreshBtn.disabled = true;
      const query = {
        search: state.cash.filters.search,
        showPendingOnly: state.cash.filters.pendingOnly
      };
      google.script.run.withSuccessHandler(function (res) {
        state.cash.loading = false;
        if (dom.cash.refreshBtn) dom.cash.refreshBtn.disabled = false;
        if (res && res.ok) {
          state.cash.summary = Object.assign(createDefaultCashSummary(), res.summary || {});
          state.cash.rows = Array.isArray(res.rows) ? res.rows : [];
          renderCashStats();
          renderCashTable();
        } else {
          alert(String((res && res.error) || t('errorGeneric')));
        }
      }).withFailureHandler(function (err) {
        state.cash.loading = false;
        if (dom.cash.refreshBtn) dom.cash.refreshBtn.disabled = false;
        alert(String((err && err.message) || t('errorGeneric')));
      }).getCashDashboardData(query);
    }

    function scheduleSalesRefresh(delay) {
      if (salesRefreshTimer) {
        clearTimeout(salesRefreshTimer);
      }
      salesRefreshTimer = setTimeout(refreshSales, isFinite(delay) ? delay : 250);
    }

    function scheduleCashRefresh(delay) {
      if (cashRefreshTimer) {
        clearTimeout(cashRefreshTimer);
      }
      cashRefreshTimer = setTimeout(refreshCash, isFinite(delay) ? delay : 250);
    }

    function refreshAll() {
      const btn = document.getElementById('global-refresh-btn');
      if (btn) btn.disabled = true;
      refreshSales();
      refreshCash();
      let waited = 0;
      const step = 150;
      const limit = 5000; // 5s fallback
      const timer = setInterval(function () {
        waited += step;
        if (!state.sales.loading && !state.cash.loading) {
          clearInterval(timer);
          if (btn) btn.disabled = false;
        } else if (waited >= limit) {
          clearInterval(timer);
          if (btn) btn.disabled = false;
        }
      }, step);
    }

    function handleSalesCashSubmit(event) {
      event.preventDefault();
      const amount = roundMoney(readNumberInput(dom.sales.inputs.cashAmount));
      if (!(amount > 0)) {
        setSalesMessage('cash', t('salesErrorAmountRequired'), true);
        return;
      }
      const payload = {
        reportDate: (dom.sales.inputs.cashDate && dom.sales.inputs.cashDate.value) || todayIso(),
        totalSales: amount,
        cashSales: amount,
        knetSales: 0,
        expenses: 0,
        notes: dom.sales.inputs.cashNotes ? dom.sales.inputs.cashNotes.value || '' : ''
      };
      submitSalesEntry('cash', payload);
    }

    function getKnetFormValues() {
      // Collect raw form field values so normalization logic stays centralized.
      return {
        reportDate: (dom.sales.inputs.knetDate && dom.sales.inputs.knetDate.value) || '',
        totalAmount: readNumberInput(dom.sales.inputs.knetTotal),
        knetAmount: readNumberInput(dom.sales.inputs.knetAmount),
        expectedDate: dom.sales.inputs.knetExpected ? dom.sales.inputs.knetExpected.value || '' : '',
        receivedDate: dom.sales.inputs.knetReceived ? dom.sales.inputs.knetReceived.value || '' : '',
        markReceived: dom.sales.inputs.knetMark ? dom.sales.inputs.knetMark.checked : false,
        notes: dom.sales.inputs.knetNotes ? dom.sales.inputs.knetNotes.value || '' : ''
      };
    }

    function handleSalesKnetSubmit(event) {
      event.preventDefault();
      const formValues = getKnetFormValues();
      const amounts = normalizeTenderBreakdown(formValues.totalAmount, formValues.knetAmount);
      if (!(amounts.knetSales > 0)) {
        setSalesMessage('knet', t('salesErrorAmountRequired'), true);
        return;
      }
      const payload = {
        reportDate: formValues.reportDate || todayIso(),
        totalSales: amounts.totalSales,
        knetSales: amounts.knetSales,
        cashSales: amounts.cashSales,
        expenses: 0,
        knetExpectedDate: formValues.expectedDate,
        knetReceivedDate: formValues.receivedDate,
        markReceived: formValues.markReceived,
        notes: formValues.notes
      };
      const fileInput = dom.sales.inputs.knetReceipt;
      const file = fileInput && fileInput.files && fileInput.files[0];
      if (file) {
        if (file.size > MAX_RECEIPT_BYTES) {
          setSalesMessage('knet', t('salesErrorReceiptTooLarge'), true);
          return;
        }
        readFileAsBase64(file).then(function (base64) {
          payload.receipt = {
            name: file.name || 'receipt',
            type: file.type || 'image/jpeg',
            base64: String(base64 || '')
          };
          submitSalesEntry('knet', payload);
        }).catch(function () {
          submitSalesEntry('knet', payload);
        });
      } else {
        submitSalesEntry('knet', payload);
      }
    }

    function handleSalesExpenseSubmit(event) {
      event.preventDefault();
      const amount = roundMoney(readNumberInput(dom.sales.inputs.expenseAmount));
      if (!(amount > 0)) {
        setSalesMessage('expense', t('salesErrorAmountRequired'), true);
        return;
      }
      const payload = {
        reportDate: (dom.sales.inputs.expenseDate && dom.sales.inputs.expenseDate.value) || todayIso(),
        totalSales: 0,
        knetSales: 0,
        cashSales: 0,
        expenses: amount,
        expenseNotes: dom.sales.inputs.expenseNotes ? dom.sales.inputs.expenseNotes.value || '' : ''
      };
      submitSalesEntry('expense', payload);
    }

    function handleSalesReceivedSubmit(event) {
      event.preventDefault();
      if (!ensureRuntime()) {
        setSalesMessage('received', t('errorRuntimeUnavailable'), true);
        return;
      }
      const totalPending = Number(state.sales.summary && state.sales.summary.pendingKnetAmount || 0);
      const pending = totalPending;
      const amount = roundMoney(readNumberInput(dom.sales.inputs.receivedAmount));
      if (!(amount > 0) || (pending > 0 && amount > pending)) {
        setSalesMessage('received', t('salesReceivedAmountError'), true);
        return;
      }
      setSalesMessage('received', '', false);
      const form = dom.sales.entryForms.received;
      setFormDisabled(form, true);
      var call = google.script.run.withSuccessHandler(function (res) {
        setFormDisabled(form, false);
        if (res && res.ok) {
          if (form) form.reset();
          setSalesMessage('received', t('successMarked'), false);
          scheduleSalesRefresh(100);
        } else {
          setSalesMessage('received', String((res && res.error) || t('errorGeneric')), true);
        }
      }).withFailureHandler(function (err) {
        setFormDisabled(form, false);
        setSalesMessage('received', String((err && err.message) || t('errorGeneric')), true);
      });
      const receivedDate = dom.sales.inputs.receivedDate ? dom.sales.inputs.receivedDate.value || '' : '';
      call.receiveKnetBulk({ amount: amount, receivedDate: receivedDate });
    }

    function submitSalesEntry(type, payload) {
      if (!ensureRuntime()) {
        setSalesMessage(type, t('errorRuntimeUnavailable'), true);
        return;
      }
      setSalesMessage(type, '', false);
      const form = dom.sales.entryForms[type];
      setFormDisabled(form, true);
      google.script.run.withSuccessHandler(function (res) {
        setFormDisabled(form, false);
        if (res && res.ok) {
          if (form) form.reset();
          setSalesDefaults(type);
          setSalesMessage(type, t('successSaved'), false);
          scheduleSalesRefresh(100);
        } else {
          setSalesMessage(type, String((res && res.error) || t('errorGeneric')), true);
        }
      }).withFailureHandler(function (err) {
        setFormDisabled(form, false);
        setSalesMessage(type, String((err && err.message) || t('errorGeneric')), true);
      }).recordSalesEntry(payload);
    }

    function handleSalesTableActions(event) {
      const button = event.target.closest('button[data-action]');
      if (!button) return;
      const action = button.getAttribute('data-action');
      const id = button.getAttribute('data-id');
      if (!id) return;
      if (action === 'sales-mark') {
        const row = (state.sales.rows || []).find(function (r) { return String(r.id) === id; });
        const pending = row ? Math.max(Number(row.knetSales || 0) - Number(row.knetReceivedAmount || 0), 0) : 0;
        const amtStr = window.prompt(t('salesPromptAmount'), pending > 0 ? String(pending) : '0');
        if (amtStr === null) return;
        const amt = Number(amtStr);
        if (!(amt > 0) || (pending > 0 && amt > pending)) {
          alert(t('salesReceivedAmountError'));
          return;
        }
        const suggestion = todayIso();
        const answer = window.prompt(t('promptReceivedDate'), suggestion);
        if (answer === null) {
          return;
        }
        button.disabled = true;
        if (!ensureRuntime()) {
          button.disabled = false;
          alert(t('errorRuntimeUnavailable'));
          return;
        }
        google.script.run.withSuccessHandler(function (res) {
          button.disabled = false;
          if (res && res.ok) {
            scheduleSalesRefresh(100);
          } else {
            alert(String((res && res.error) || t('errorGeneric')));
          }
        }).withFailureHandler(function (err) {
          button.disabled = false;
          alert(String((err && err.message) || t('errorGeneric')));
        }).markKnetReceived({
          id: id,
          amount: amt,
          receivedDate: answer || ''
        });
      }
    }

    function handleCashSubmit(event) {
      event.preventDefault();
      const amount = roundMoney(readNumberInput(dom.cash.amount));
      if (!(amount > 0)) {
        setCashMessage(t('cashErrorAmountRequired'), true);
        return;
      }
      const payload = {
        entryDate: (dom.cash.date && dom.cash.date.value) || todayIso(),
        direction: dom.cash.direction ? dom.cash.direction.value || 'IN' : 'IN',
        category: dom.cash.category ? dom.cash.category.value || '' : '',
        amount: amount,
        knetExpectedDate: dom.cash.expected ? dom.cash.expected.value || '' : '',
        knetReceivedDate: dom.cash.received ? dom.cash.received.value || '' : '',
        markReceived: dom.cash.markReceived ? dom.cash.markReceived.checked : false,
        description: dom.cash.description ? dom.cash.description.value || '' : '',
        notes: dom.cash.notes ? dom.cash.notes.value || '' : ''
      };
      if (!ensureRuntime()) {
        setCashMessage(t('errorRuntimeUnavailable'), true);
        return;
      }
      setCashMessage('', false);
      setFormDisabled(dom.cash.form, true);
      google.script.run.withSuccessHandler(function (res) {
        setFormDisabled(dom.cash.form, false);
        if (res && res.ok) {
          if (dom.cash.form) dom.cash.form.reset();
          setCashDefaults();
          setCashMessage(t('successSaved'), false);
          scheduleCashRefresh(100);
        } else {
          setCashMessage(String((res && res.error) || t('errorGeneric')), true);
        }
      }).withFailureHandler(function (err) {
        setFormDisabled(dom.cash.form, false);
        setCashMessage(String((err && err.message) || t('errorGeneric')), true);
      }).recordCashEntry(payload);
    }

    function handleCashTableActions(event) {
      const button = event.target.closest('button[data-action]');
      if (!button) return;
      const id = button.getAttribute('data-id');
      if (!id) return;
      const action = button.getAttribute('data-action');
      if (!ensureRuntime()) {
        alert(t('errorRuntimeUnavailable'));
        return;
      }
      if (action === 'cash-mark') {
        if (!window.confirm(t('confirmReceived'))) return;
        const suggestion = todayIso();
        const answer = window.prompt(t('promptReceivedDate'), suggestion);
        if (answer === null) return;
        button.disabled = true;
        google.script.run.withSuccessHandler(function (res) {
          button.disabled = false;
          if (res && res.ok) {
            scheduleCashRefresh(100);
          } else {
            alert(String((res && res.error) || t('errorGeneric')));
          }
        }).withFailureHandler(function (err) {
          button.disabled = false;
          alert(String((err && err.message) || t('errorGeneric')));
        }).markCashKnetReceived({
          id: id,
          receivedDate: answer || ''
        });
      } else if (action === 'cash-transfer') {
        if (!window.confirm(t('confirmTransfer'))) return;
        const suggestion = todayIso();
        const answer = window.prompt(t('promptTransferDate'), suggestion);
        if (answer === null) return;
        button.disabled = true;
        google.script.run.withSuccessHandler(function (res) {
          button.disabled = false;
          if (res && res.ok) {
            scheduleCashRefresh(100);
          } else {
            alert(String((res && res.error) || t('errorGeneric')));
          }
        }).withFailureHandler(function (err) {
          button.disabled = false;
          alert(String((err && err.message) || t('errorGeneric')));
        }).transferCashToProfit({
          id: id,
          transferDate: answer || ''
        });
      }
    }

    function setSalesDefaults(type) {
      if (type === 'cash' && dom.sales.inputs.cashDate) {
        dom.sales.inputs.cashDate.value = todayIso();
      }
      if (type === 'knet') {
        if (dom.sales.inputs.knetDate) dom.sales.inputs.knetDate.value = todayIso();
        if (dom.sales.inputs.knetMark) dom.sales.inputs.knetMark.checked = false;
        if (dom.sales.inputs.knetExpected) dom.sales.inputs.knetExpected.value = '';
        if (dom.sales.inputs.knetReceived) dom.sales.inputs.knetReceived.value = '';
      }
      if (type === 'expense' && dom.sales.inputs.expenseDate) {
        dom.sales.inputs.expenseDate.value = todayIso();
      }
    }

    function setCashDefaults() {
      if (dom.cash.date) dom.cash.date.value = todayIso();
      if (dom.cash.direction) dom.cash.direction.value = 'IN';
      populateCashCategories();
    }

    function bindEvents() {
      dom.tabButtons.forEach(function (button) {
        button.addEventListener('click', function () {
          const target = button.getAttribute('data-tab') || 'sales';
          setActiveModule(target);
        });
      });

      dom.languageButtons.forEach(function (button) {
        button.addEventListener('click', function () {
          const lang = button.getAttribute('data-lang');
          if (!lang || !translations[lang] || lang === state.language) return;
          state.language = lang;
          applyTranslations();
        });
      });

      if (dom.themeToggle) {
        dom.themeToggle.addEventListener('click', function () {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          applyTheme(isDark ? 'light' : 'dark');
        });
      }
      if (dom.brandSelect) {
        dom.brandSelect.addEventListener('change', function () {
          applyBrand(dom.brandSelect.value);
        });
      }

      dom.sales.entryTabs.forEach(function (button) {
        button.addEventListener('click', function () {
          const tab = button.getAttribute('data-sales-entry-tab');
          if (!tab) return;
          setSalesEntryTab(tab);
        });
      });
      if (dom.sales.entryForms.cash) {
        dom.sales.entryForms.cash.addEventListener('submit', handleSalesCashSubmit);
      }
      if (dom.sales.entryForms.knet) {
        dom.sales.entryForms.knet.addEventListener('submit', handleSalesKnetSubmit);
      }
      if (dom.sales.entryForms.expense) {
        dom.sales.entryForms.expense.addEventListener('submit', handleSalesExpenseSubmit);
      }
      if (dom.sales.entryForms.received) {
        dom.sales.entryForms.received.addEventListener('submit', handleSalesReceivedSubmit);
      }
      // ID field removed; always show global pending in KNET receive form

      if (dom.sales.entryPanel) {
        dom.sales.entryPanel.addEventListener('click', function (event) {
          const resetType = event.target && event.target.getAttribute('data-reset');
          if (!resetType || !dom.sales.entryForms[resetType]) return;
          event.preventDefault();
          dom.sales.entryForms[resetType].reset();
          setSalesDefaults(resetType);
          setSalesMessage(resetType, '', false);
        });
      }

      if (dom.sales.inputs.knetMark && dom.sales.inputs.knetReceived) {
        dom.sales.inputs.knetMark.addEventListener('change', function () {
          if (dom.sales.inputs.knetMark.checked && !dom.sales.inputs.knetReceived.value) {
            dom.sales.inputs.knetReceived.value = todayIso();
          }
        });
      }

      if (dom.sales.tableBody) {
        dom.sales.tableBody.addEventListener('click', handleSalesTableActions);
      }

      if (dom.sales.search) {
        dom.sales.search.addEventListener('input', function (event) {
          state.sales.filters.search = event.target.value.trim();
          scheduleSalesRefresh();
        });
      }
      if (dom.sales.fromDate) {
        dom.sales.fromDate.addEventListener('change', function () {
          scheduleSalesRefresh(100);
        });
      }
      if (dom.sales.toDate) {
        dom.sales.toDate.addEventListener('change', function () {
          scheduleSalesRefresh(100);
        });
      }
      if (dom.sales.pendingToggle) {
        dom.sales.pendingToggle.addEventListener('change', function (event) {
          state.sales.filters.pendingOnly = event.target.checked;
          scheduleSalesRefresh();
        });
      }
      if (dom.sales.refreshBtn) {
        dom.sales.refreshBtn.addEventListener('click', function () {
          refreshSales();
        });
      }
      var salesExport = document.getElementById('sales-export-btn');
      if (salesExport) {
        salesExport.addEventListener('click', function () { openExportModal('sales'); });
      }

      if (dom.cash.form) {
        dom.cash.form.addEventListener('submit', handleCashSubmit);
      }
      if (dom.cash.resetBtn) {
        dom.cash.resetBtn.addEventListener('click', function (event) {
          event.preventDefault();
          dom.cash.form.reset();
          setCashDefaults();
          setCashMessage('', false);
        });
      }
      if (dom.cash.tableBody) {
        dom.cash.tableBody.addEventListener('click', handleCashTableActions);
      }

      if (dom.cash.search) {
        dom.cash.search.addEventListener('input', function (event) {
          state.cash.filters.search = event.target.value.trim();
          scheduleCashRefresh();
        });
      }
      if (dom.cash.pendingToggle) {
        dom.cash.pendingToggle.addEventListener('change', function (event) {
          state.cash.filters.pendingOnly = event.target.checked;
          scheduleCashRefresh();
        });
      }
      if (dom.cash.refreshBtn) {
        dom.cash.refreshBtn.addEventListener('click', function () {
          refreshCash();
        });
      }
      if (dom.mobile.refreshBtn) {
        dom.mobile.refreshBtn.addEventListener('click', function () {
          if (state.module === 'cash') refreshCash(); else refreshSales();
        });
      }
      if (dom.mobile.exportBtn) {
        dom.mobile.exportBtn.addEventListener('click', function () {
          openExportModal(state.module === 'cash' ? 'cash' : 'sales');
        });
      }
      var cashExport = document.getElementById('cash-export-btn');
      if (cashExport) {
        cashExport.addEventListener('click', function () { openExportModal('cash'); });
      }
      var globalBtn = document.getElementById('global-refresh-btn');
      if (globalBtn) {
        globalBtn.addEventListener('click', refreshAll);
      }
      if (dom.cash.direction) {
        dom.cash.direction.addEventListener('change', populateCashCategories);
      }
      if (dom.cash.category) {
        dom.cash.category.addEventListener('change', updateCashKnetVisibility);
      }
      if (dom.cash.markReceived && dom.cash.received) {
        dom.cash.markReceived.addEventListener('change', function () {
          if (dom.cash.markReceived.checked && !dom.cash.received.value) {
            dom.cash.received.value = todayIso();
          }
        });
      }

      if (dom.export.cancel) dom.export.cancel.addEventListener('click', closeExportModal);
      if (dom.export.close) dom.export.close.addEventListener('click', closeExportModal);
      if (dom.export.modal) dom.export.modal.addEventListener('click', function (e) {
        if (e.target === dom.export.modal) closeExportModal();
      });
      if (dom.export.form) {
        dom.export.form.addEventListener('submit', handleExportSubmit);
      }
      if (dom.export.range) {
        dom.export.range.addEventListener('change', applyExportRangePreset);
      }
    }

    function initDefaults() {
      if (dom.sales.inputs.cashDate) dom.sales.inputs.cashDate.value = todayIso();
      if (dom.sales.inputs.knetDate) dom.sales.inputs.knetDate.value = todayIso();
      if (dom.sales.inputs.expenseDate) dom.sales.inputs.expenseDate.value = todayIso();
      if (dom.sales.fromDate) dom.sales.fromDate.value = todayIso();
      if (dom.sales.toDate) dom.sales.toDate.value = todayIso();
      if (dom.cash.date) dom.cash.date.value = todayIso();
      populateCashCategories();
      setSalesEntryTab('cash');
      setActiveModule('sales');
      // Apply saved theme + brand
      try {
        const savedTheme = localStorage.getItem('theme') || '';
        if (savedTheme) applyTheme(savedTheme);
        const savedBrand = localStorage.getItem('brandPreset') || '';
        if (savedBrand) applyBrand(savedBrand);
      } catch (e) {}
    }

    function openExportModal(dataset) {
      exportDataset = dataset === 'cash' ? 'cash' : 'sales';
      if (dom.export.title) {
        dom.export.title.textContent = exportDataset === 'cash' ? t('exportTitleCash') : t('exportTitleSales');
      }
      if (dom.export.dataset) dom.export.dataset.value = exportDataset;
      if (dom.export.result) dom.export.result.style.display = 'none';
      if (dom.export.message) dom.export.message.textContent = '';
      if (dom.export.from) dom.export.from.value = '';
      if (dom.export.to) dom.export.to.value = todayIso();
      if (dom.export.format) dom.export.format.value = 'xlsx';
      if (dom.export.range) dom.export.range.value = 'thisMonth', applyExportRangePreset();
      if (dom.export.modal) dom.export.modal.style.display = 'flex';
    }

    function closeExportModal() {
      if (dom.export.modal) dom.export.modal.style.display = 'none';
    }

    function handleExportSubmit(e) {
      e.preventDefault();
      if (!ensureRuntime()) {
        if (dom.export.message) dom.export.message.textContent = t('errorRuntimeUnavailable');
        return;
      }
      const fromDate = dom.export.from ? dom.export.from.value || '' : '';
      const toDate = dom.export.to ? dom.export.to.value || '' : '';
      const format = dom.export.format ? dom.export.format.value || 'xlsx' : 'xlsx';
      const dataset = dom.export.dataset ? dom.export.dataset.value || 'sales' : exportDataset;
      if (dom.export.submit) dom.export.submit.disabled = true;
      if (dom.export.message) dom.export.message.textContent = t('exportWorking');
      const run = google.script.run.withSuccessHandler(function (res) {
        if (dom.export.submit) dom.export.submit.disabled = false;
        if (res && res.ok) {
          if (dom.export.link) {
            dom.export.link.href = res.exportUrl || res.url;
            dom.export.link.textContent = res.name + ' (' + (res.format || format).toUpperCase() + ')';
          }
          if (dom.export.result) dom.export.result.style.display = '';
          if (dom.export.message) dom.export.message.textContent = '';
        } else {
          if (dom.export.message) dom.export.message.textContent = String((res && res.error) || t('errorGeneric'));
        }
      }).withFailureHandler(function (err) {
        if (dom.export.submit) dom.export.submit.disabled = false;
        if (dom.export.message) dom.export.message.textContent = String((err && err.message) || t('errorGeneric'));
      });
      if (dataset === 'both') {
        run.exportBothReport({ fromDate: fromDate, toDate: toDate, format: format });
      } else if (dataset === 'cash') {
        run.exportCashReport({ fromDate: fromDate, toDate: toDate, format: format });
      } else {
        run.exportSalesReport({ fromDate: fromDate, toDate: toDate, format: format });
      }

    }

    function applyExportRangePreset() {
      if (!dom.export.range) return;
      const preset = dom.export.range.value || 'thisMonth';
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      function fmt(d) {
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return yy + '-' + mm + '-' + dd;
      }
      if (preset === 'thisMonth') {
        const from = new Date(y, m, 1);
        const to = new Date(y, m + 1, 0);
        if (dom.export.from) dom.export.from.value = fmt(from);
        if (dom.export.to) dom.export.to.value = fmt(to);
      } else if (preset === 'lastMonth') {
        const from = new Date(y, m - 1, 1);
        const to = new Date(y, m, 0);
        if (dom.export.from) dom.export.from.value = fmt(from);
        if (dom.export.to) dom.export.to.value = fmt(to);
      } else {
        // custom: leave as-is
      }
    }

    function init() {
      bindEvents();
      initDefaults();
      applyTranslations();
      refreshSales();
      refreshCash();
    }

    init();
  })();
  </script>
</body>
</html>
