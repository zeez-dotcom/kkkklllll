<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laundry POS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #0f172a;
      --muted: #627597;
      --surface: #ffffff;
      --accent: #4f46e5;
      --accent-2: #0ea5e9;
      --border: #e2e8f0;
      --success: #0ea35f;
      --warning: #f59e0b;
      --danger: #ef4444;
      --card-shadow: 0 15px 40px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', 'Inter', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0 0 48px;
      background: radial-gradient(circle at 20% 20%, rgba(14, 165, 233, 0.15), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(79, 70, 229, 0.16), transparent 32%),
                  #f7f9fc;
      color: var(--ink);
    }

    header {
      padding: 32px 24px 12px;
    }

    .hero {
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.12), rgba(14, 165, 233, 0.16));
      border: 1px solid rgba(99, 102, 241, 0.25);
      border-radius: 24px;
      padding: 28px;
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 18px;
      box-shadow: var(--card-shadow);
    }

    .app-logo {
      max-height: 52px;
      width: auto;
      object-fit: contain;
    }

    .hero h1 {
      margin: 8px 0 6px;
      font-size: 28px;
      letter-spacing: -0.02em;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
    }

    .eyebrow {
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.2em;
      color: #4f46e5;
      font-weight: 700;
      margin: 0;
    }

    .chip-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    .chip {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      color: var(--ink);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .chip svg {
      width: 16px;
      height: 16px;
      color: var(--accent);
    }

    .controls {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      align-items: flex-start;
    }

    .btn {
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.08s ease, box-shadow 0.2s ease;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5, #0ea5e9);
      color: #fff;
      box-shadow: 0 12px 30px rgba(79, 70, 229, 0.35);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.85);
      color: var(--ink);
      border: 1px solid var(--border);
    }

    .container {
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 18px;
    }

    .card {
      background: var(--surface);
      border-radius: 18px;
      padding: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
    }

    .card h3 {
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h3 small {
      color: var(--muted);
      font-size: 12px;
      font-weight: 500;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.08), rgba(14, 165, 233, 0.08));
      border: 1px solid rgba(15, 23, 42, 0.05);
      border-radius: 14px;
      padding: 14px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 13px;
    }

    .stat-value {
      font-size: 26px;
      margin: 4px 0 2px;
      letter-spacing: -0.01em;
    }

    .stat-sub {
      color: var(--muted);
      font-size: 12px;
    }

    form label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
      background: #f9fafb;
    }

    textarea {
      min-height: 72px;
      resize: vertical;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .item-row {
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      background: #fbfcfe;
    }

    .item-row-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }

    .pill {
      background: #eef2ff;
      color: #4338ca;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 10px 8px;
      text-align: left;
    }

    th {
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--muted);
    }

    tr:hover td {
      background: #f8fafc;
    }

    .order-items {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tag {
      background: #e0f2fe;
      color: #0f172a;
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
    }

    .status.PENDING { background: #fff7ed; color: #c2410c; }
    .status.IN_PROGRESS { background: #eff6ff; color: #1d4ed8; }
    .status.READY { background: #ecfdf3; color: #15803d; }
    .status.DELIVERED { background: #f3f4f6; color: #0f172a; }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .muted {
      color: var(--muted);
    }

    .price-board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .price-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: #f8fafc;
    }

    .price-card h4 {
      margin: 0 0 6px;
    }

    .price-card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #fff;
    }

    .price-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 4px 0;
    }

    .badge {
      background: #eef2ff;
      color: #4338ca;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
    }

    .toast {
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0;
      border: 1px solid var(--border);
      display: none;
    }

    .toast.success { background: #ecfdf3; border-color: #bbf7d0; color: #15803d; }
    .toast.error { background: #fef2f2; border-color: #fecdd3; color: #b91c1c; }

    .catalog-row {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      background: #f9fafb;
    }

    .catalog-row .form-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .catalog-image {
      width: 100%;
      height: 140px;
      border: 1px dashed var(--border);
      border-radius: 10px;
      margin-top: 6px;
      object-fit: cover;
      background: #fff;
    }

    .catalog-row-footer {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .tabs {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      margin-top: 16px;
      background: #fff;
      box-shadow: var(--card-shadow);
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 10px 14px;
      font-weight: 700;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.12), rgba(14, 165, 233, 0.12));
      color: var(--ink);
    }

    .tab-panel {
      margin-top: 18px;
    }

    .hidden {
      display: none !important;
    }

    .receipt-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
    }

    .receipt-content {
      background: #fff;
      max-width: 900px;
      width: 100%;
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--card-shadow);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 14px;
    }

    .receipt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .receipt-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .receipt-items {
      margin-top: 6px;
      border-top: 1px solid var(--border);
    }

    .btn-small {
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
    }

    @media (max-width: 900px) {
      .hero {
        grid-template-columns: 1fr;
      }
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <div>
        <img class="app-logo" id="logoHero" src="<?= logoUrl ?>" alt="logo">
        <p class="eyebrow" data-i18n="eyebrow"></p>
        <h1 data-i18n="title"></h1>
        <p data-i18n="subtitle"></p>
        <div class="chip-row">
          <span class="chip">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path d="M12 3L2 9l10 6 10-6-10-6z" />
              <path d="M2 15l10 6 10-6" />
              <path d="M2 9l10 6 10-6" />
            </svg>
            <span data-i18n="chipRealtime"></span>
          </span>
          <span class="chip">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path d="M4 7h16M4 12h16M4 17h16" />
            </svg>
            <span data-i18n="chipPrice"></span>
          </span>
        </div>
      </div>
      <div class="controls">
        <button class="btn btn-ghost" id="languageToggle"></button>
        <button class="btn btn-primary" onclick="refreshOrders()" data-i18n="refresh"></button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab-btn active" id="tab-pos" onclick="switchTab('pos')" data-i18n="tabPos"></button>
      <button class="tab-btn" id="tab-catalog" onclick="switchTab('catalog')" data-i18n="tabCatalog"></button>
      <button class="tab-btn" id="tab-customers" onclick="switchTab('customers')" data-i18n="tabCustomers"></button>
    </div>
  </header>

  <main class="container">
    <section class="tab-panel" id="panel-pos">
      <section class="stats-grid" id="stats"></section>

      <section class="grid">
        <div class="card">
          <h3 data-i18n="newOrder"></h3>
          <div id="orderToast" class="toast"></div>
          <form id="orderForm" onsubmit="submitOrder(event)">
            <div class="form-grid">
              <div>
                <label data-i18n="customerSearch"></label>
                <input id="posCustomerSearch" type="search" placeholder="">
                <div class="muted" style="font-size:12px;" data-i18n="customerHint"></div>
                <div id="posCustomerResults" class="muted"></div>
              </div>
              <div>
                <label data-i18n="selectedCustomer"></label>
                <div class="pill" id="selectedCustomerDisplay">Walk-in</div>
                <button class="btn btn-ghost btn-small" type="button" onclick="clearSelectedCustomer()" data-i18n="walkInOption"></button>
              </div>
              <div>
                <label data-i18n="subscriptionCustomer"></label>
                <select id="posSubscriptionSelect"></select>
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="customerName" data-i18n="customer"></label>
                <input id="customerName" name="customerName" type="text" placeholder="" />
              </div>
              <div>
                <label for="customerNickname" data-i18n="customerNickname"></label>
                <input id="customerNickname" name="customerNickname" type="text" placeholder="" />
              </div>
              <div>
                <label for="phone" data-i18n="phone"></label>
                <input id="phone" name="phone" type="tel" placeholder="" />
              </div>
              <div>
                <label for="walkInDate" data-i18n="walkIn"></label>
                <input id="walkInDate" name="walkInDate" type="date" required />
              </div>
              <div>
                <label for="exitDate" data-i18n="exitDate"></label>
                <input id="exitDate" name="exitDate" type="date" required />
              </div>
            </div>

            <div id="itemsContainer"></div>
            <button class="btn btn-ghost" type="button" onclick="addItemRow()" data-i18n="addItem"></button>

            <div class="form-grid" style="margin-top: 10px;">
              <div>
                <label for="discount" data-i18n="discount"></label>
                <input id="discount" name="discount" type="number" min="0" step="0.001" value="0" />
              </div>
              <div>
                <label for="notes" data-i18n="notes"></label>
                <textarea id="notes" name="notes" placeholder=""></textarea>
              </div>
              <div>
                <label data-i18n="totals"></label>
                <div class="pill" id="totalsSummary">0.000</div>
                <small class="muted" data-i18n="totalsHint"></small>
              </div>
            </div>

            <div style="margin-top: 14px; display: flex; gap: 10px; align-items: center;">
              <button class="btn btn-primary" type="submit" id="submitBtn" data-i18n="saveOrder"></button>
              <span id="formStatus" class="muted"></span>
            </div>
          </form>
        </div>

        <div class="card">
          <h3 data-i18n="priceBoard"></h3>
          <p class="muted" data-i18n="priceBoardHint"></p>
          <div class="price-board" id="priceBoard"></div>
        </div>
      </section>

      <section class="card" style="margin-top: 16px;">
        <div class="toolbar">
          <input type="search" id="searchInput" placeholder="" data-i18n-placeholder="searchPlaceholder" />
          <select id="statusFilter"></select>
          <span class="muted" id="listMeta"></span>
        </div>
        <table>
          <thead>
            <tr>
              <th data-i18n="thOrder"></th>
              <th data-i18n="thDates"></th>
              <th data-i18n="thCustomer"></th>
              <th data-i18n="thItems"></th>
              <th data-i18n="thTotal"></th>
              <th data-i18n="thStatus"></th>
              <th data-i18n="thActions"></th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </section>

      <section class="grid">
        <div class="card">
          <h3 data-i18n="mgmtDashboard"></h3>
          <div id="mgmtDashboard"></div>
        </div>
        <div class="card">
          <h3 data-i18n="reportingDashboard"></h3>
          <div id="reportingDashboard"></div>
        </div>
      </section>
    </section>

    <section class="tab-panel hidden" id="panel-catalog">
      <section class="card">
        <h3 data-i18n="catalogTitle"></h3>
        <p class="muted" data-i18n="catalogHint"></p>
        <div id="catalogToast" class="toast"></div>
        <div class="form-grid">
          <div>
            <label data-i18n="logoLabel"></label>
            <input type="url" id="logoInput" value="">
            <small class="muted" data-i18n="logoHint"></small>
          </div>
          <div>
            <label data-i18n="imageLabel"></label>
            <img class="catalog-image app-logo" id="logoPreview" src="" alt="">
          </div>
        </div>
        <div id="catalogRows"></div>
        <button class="btn btn-ghost" type="button" onclick="addCatalogRow()" data-i18n="addCatalog"></button>
        <div class="catalog-row-footer">
          <button class="btn btn-primary" type="button" onclick="saveCatalog()" data-i18n="saveCatalog"></button>
          <span class="muted" id="catalogStatus"></span>
        </div>
      </section>
    </section>

    <section class="tab-panel hidden" id="panel-customers">
      <section class="card">
        <h3 data-i18n="customerDashboard"></h3>
        <div class="form-grid">
          <div>
            <label data-i18n="customerSearch"></label>
            <input type="search" id="customerSearchInput" placeholder="">
            <button class="btn btn-primary btn-small" type="button" onclick="runCustomerSearch()" data-i18n="search"></button>
            <div id="customerResults" class="muted"></div>
          </div>
          <div>
            <label data-i18n="newCustomer"></label>
            <input type="text" id="newCustomerName" placeholder="">
            <input type="text" id="newCustomerNickname" placeholder="">
            <input type="tel" id="newCustomerPhone" placeholder="">
            <button class="btn btn-ghost btn-small" type="button" onclick="createCustomer()" data-i18n="saveCustomer"></button>
            <div id="customerCreateStatus" class="muted"></div>
          </div>
        </div>
        <div id="customerList"></div>
      </section>

      <section class="card">
        <h3 data-i18n="subscriptionTitle"></h3>
        <p class="muted" data-i18n="subscriptionHint"></p>
        <div id="subscriptionToast" class="toast"></div>
        <div class="form-grid">
          <div>
            <label data-i18n="subscriptionCustomer"></label>
            <select id="subscriptionCustomerSelect"></select>
          </div>
          <div>
            <label data-i18n="subscriptionPackage"></label>
            <input type="text" id="subscriptionPackageName" placeholder="">
          </div>
          <div>
            <label data-i18n="productLabel"></label>
            <select id="subscriptionProduct"></select>
          </div>
          <div>
            <label data-i18n="serviceLabel"></label>
            <select id="subscriptionService"></select>
          </div>
          <div>
            <label data-i18n="freeAllowance"></label>
            <input type="number" min="0" step="1" id="subscriptionAllowance">
          </div>
          <div>
            <label data-i18n="startDate"></label>
            <input type="date" id="subscriptionStart">
          </div>
          <div>
            <label data-i18n="endDate"></label>
            <input type="date" id="subscriptionEnd">
          </div>
          <div>
            <label data-i18n="activeLabel"></label>
            <input type="checkbox" id="subscriptionActive" checked>
          </div>
        </div>
        <div class="catalog-row-footer">
          <button class="btn btn-primary" type="button" onclick="createSubscription()" data-i18n="saveSubscription"></button>
          <span class="muted" id="subscriptionStatus"></span>
        </div>
        <div id="subscriptionList"></div>
      </section>
    </section>
  </main>

  <div class="receipt-modal" id="receiptModal">
    <div class="receipt-content" id="receiptContent">
      <div style="grid-column: 1 / -1;">
        <img class="app-logo" id="logoReceipt" src="<?= logoUrl ?>" alt="logo">
      </div>
      <div style="grid-column: 1 / -1; margin-bottom: 6px;" class="receipt-header">
        <strong data-i18n="receiptTitle"></strong>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost btn-small" type="button" onclick="printReceipt()" data-i18n="print"></button>
          <button class="btn btn-ghost btn-small" type="button" onclick="closeReceipt()" data-i18n="close"></button>
        </div>
      </div>
      <div id="receiptEnglish"></div>
      <div id="receiptArabic" dir="rtl"></div>
    </div>
  </div>

  <script>
    // Local mock to avoid runtime errors during static previews outside Apps Script.
    if (typeof google === "undefined") {
      window.google = {
        script: {
          run: {
            withSuccessHandler(cb) { this._success = cb; return this; },
            withFailureHandler(cb) { this._failure = cb; return this; },
            getOrders() { this._failure && this._failure({ message: "Available in Apps Script deployment." }); return this; },
            getCatalog() { this._failure && this._failure({ message: "Available in Apps Script deployment." }); return this; },
            saveCatalog() { this._failure && this._failure({ message: "Available in Apps Script deployment." }); return this; },
            getCustomers() { this._failure && this._failure({ message: "Available in Apps Script deployment." }); return this; },
            saveCustomer() { this._failure && this._failure({ message: "Available in Apps Script deployment." }); return this; },
            getSubscriptions() { this._failure && this._failure({ message: "Available in Apps Script deployment." }); return this; },
            saveSubscription() { this._failure && this._failure({ message: "Available in Apps Script deployment." }); return this; },
            recordOrder() { this._failure && this._failure({ message: "Available in Apps Script deployment." }); return this; },
          },
        },
      };
    }

    // Inject server data without extra parsing so quotes in labels don't break the page.
    const initialPriceBook = <?!= priceBook ?>;
    const initialLogo = <?!= JSON.stringify(logoUrl) ?>;
    const currency = <?!= JSON.stringify(currency) ?>;
    const orderStatuses = <?!= statuses ?>;

    const translations = {
      en: {
        eyebrow: "Laundry POS",
        title: "Freshen. Press. Deliver.",
        subtitle: "Track walk-ins, services, and exit dates with a point of sale tuned for laundry counters.",
        chipRealtime: "Realtime sheet sync",
        chipPrice: "Service-aware pricing",
        productLabel: "Item",
        productKey: "Product key",
        serviceLabel: "Service",
        serviceCode: "Service code",
        qtyLabel: "Quantity",
        priceLabel: "Unit price",
        lineTotal: "Line total",
        refresh: "Refresh",
        newOrder: "Create a new order",
        customer: "Customer name",
        customerNickname: "Nickname",
        phone: "Phone",
        walkIn: "Walk-in date",
        exitDate: "Exit / pickup date",
        addItem: "+ Add service line",
        discount: "Discount",
        notes: "Notes",
        totals: "Totals",
        totalsHint: "Subtotal, discount, and total will update as you adjust items.",
        saveOrder: "Save order",
        priceBoard: "Price board",
        priceBoardHint: "Services and default prices pulled from the price book. Adjust prices per line if needed.",
        thOrder: "Order",
        thDates: "Dates",
        thCustomer: "Customer",
        thItems: "Items",
        thTotal: "Total",
        thStatus: "Status",
        thActions: "Actions",
        viewReceipt: "Receipt",
        print: "Print",
        subscriptionTag: "Subscription",
        mgmtDashboard: "Order management dashboard",
        reportingDashboard: "Reporting dashboard",
        receiptTitle: "Receipt",
        receiptOrder: "Order #",
        receiptCustomer: "Customer",
        receiptDates: "Dates",
        receiptItems: "Items",
        receiptSubtotal: "Subtotal",
        receiptDiscount: "Discount",
        receiptTotal: "Total",
        receiptStatus: "Status",
        receiptNotes: "Notes",
        receiptWalkIn: "Walk-in",
        receiptExit: "Exit",
        close: "Close",
        searchPlaceholder: "Search by order number, customer, or phone",
        avgTicket: "Average ticket",
        topCustomer: "Top customer",
        last7: "Last 7 days revenue",
        walkInLabel: "Walk-in",
        exitLabel: "Exit",
        revenue: "Total revenue",
        totalOrders: "Total orders",
        statusBreakdown: "By status",
        filterStatus: "Filter by status",
        listMetaNone: "No orders yet",
        listMetaSome: "orders shown",
        orderSaved: "Order saved",
        orderFailed: "Could not save order",
        languageToggle: "العربية",
        catalogTitle: "Catalog editor",
        catalogHint: "Manage items, services, prices, and image URLs directly from the Catalog sheet.",
        addCatalog: "+ Add catalog line",
        saveCatalog: "Save catalog",
        catalogSaved: "Catalog saved",
        catalogFailed: "Could not save catalog",
        imageLabel: "Image URL",
        activeLabel: "Active",
        tabPos: "POS / Orders",
        tabCatalog: "Catalog",
        logoLabel: "Logo URL",
        logoHint: "Shown on receipts and headers.",
        tabCustomers: "Customers",
        customerDashboard: "Customer dashboard",
        customerSearch: "Search customers (name, nickname, phone)",
        customerHint: "Choose an existing customer or leave as walk-in.",
        selectedCustomer: "Selected customer",
        walkInOption: "Set to walk-in",
        newCustomer: "Add customer",
        saveCustomer: "Save customer",
        search: "Search",
        subscriptionTitle: "Subscriptions",
        subscriptionHint: "Create packages with free allowances for specific product/services.",
        subscriptionCustomer: "Customer",
        subscriptionPackage: "Package name",
        freeAllowance: "Free allowance",
        startDate: "Start date",
        endDate: "End date",
        saveSubscription: "Save subscription",
      },
      ar: {
        eyebrow: "نظام مغسلة",
        title: "تنظيف. كي. تسليم.",
        subtitle: "تتبع الطلبات والخدمات وتواريخ التسليم لنقطة بيع المغسلة.",
        chipRealtime: "مزامنة فورية مع الشيت",
        chipPrice: "تسعير حسب الخدمة",
        productLabel: "العنصر",
        productKey: "مفتاح العنصر",
        serviceLabel: "الخدمة",
        serviceCode: "كود الخدمة",
        qtyLabel: "الكمية",
        priceLabel: "سعر الوحدة",
        lineTotal: "إجمالي العنصر",
        refresh: "تحديث",
        newOrder: "إنشاء طلب جديد",
        customer: "اسم العميل",
        customerNickname: "اللقب",
        phone: "الهاتف",
        walkIn: "تاريخ الدخول",
        exitDate: "تاريخ الخروج / الاستلام",
        addItem: "+ إضافة خدمة",
        discount: "خصم",
        notes: "ملاحظات",
        totals: "الإجمالي",
        totalsHint: "يتم تحديث الإجمالي والخصم تلقائياً حسب العناصر.",
        saveOrder: "حفظ الطلب",
        priceBoard: "قائمة الأسعار",
        priceBoardHint: "الخدمات والأسعار الافتراضية من دليل الأسعار. يمكن تعديل السعر لكل عنصر.",
        thOrder: "الطلب",
        thDates: "التواريخ",
        thCustomer: "العميل",
        thItems: "العناصر",
        thTotal: "الإجمالي",
        thStatus: "الحالة",
        thActions: "إجراءات",
        viewReceipt: "إيصال",
        print: "طباعة",
        subscriptionTag: "اشتراك",
        mgmtDashboard: "لوحة إدارة الطلبات",
        reportingDashboard: "لوحة التقارير",
        receiptTitle: "الإيصال",
        receiptOrder: "رقم الطلب",
        receiptCustomer: "العميل",
        receiptDates: "التواريخ",
        receiptItems: "العناصر",
        receiptSubtotal: "الإجمالي الفرعي",
        receiptDiscount: "الخصم",
        receiptTotal: "الإجمالي",
        receiptStatus: "الحالة",
        receiptNotes: "ملاحظات",
        receiptWalkIn: "دخول",
        receiptExit: "خروج",
        close: "إغلاق",
        searchPlaceholder: "بحث برقم الطلب أو اسم العميل أو الهاتف",
        avgTicket: "متوسط الفاتورة",
        topCustomer: "أفضل عميل",
        last7: "إيراد آخر 7 أيام",
        walkInLabel: "دخول",
        exitLabel: "خروج",
        revenue: "إجمالي الإيراد",
        totalOrders: "إجمالي الطلبات",
        statusBreakdown: "حسب الحالة",
        filterStatus: "تصفية الحالة",
        listMetaNone: "لا توجد طلبات",
        listMetaSome: "طلبات معروضة",
        orderSaved: "تم حفظ الطلب",
        orderFailed: "تعذر حفظ الطلب",
        languageToggle: "English",
        catalogTitle: "إدارة الكتالوج",
        catalogHint: "تحكم في العناصر والخدمات والأسعار وروابط الصور مباشرة من الشيت (Catalog).",
        addCatalog: "+ إضافة سطر كتالوج",
        saveCatalog: "حفظ الكتالوج",
        catalogSaved: "تم حفظ الكتالوج",
        catalogFailed: "تعذر حفظ الكتالوج",
        imageLabel: "رابط الصورة",
        activeLabel: "نشط",
        tabPos: "نقطة البيع / الطلبات",
        tabCatalog: "الكتالوج",
        logoLabel: "رابط الشعار",
        logoHint: "يظهر في الترويسات والإيصالات.",
        tabCustomers: "العملاء",
        customerDashboard: "لوحة العملاء",
        customerSearch: "بحث العملاء (اسم، لقب، هاتف)",
        customerHint: "اختر عميلاً أو اتركه زبوناً جديداً.",
        selectedCustomer: "العميل المختار",
        walkInOption: "تعيين كـ زبون جديد",
        newCustomer: "إضافة عميل",
        saveCustomer: "حفظ العميل",
        search: "بحث",
        subscriptionTitle: "الاشتراكات",
        subscriptionHint: "إنشاء باقات بخدمات مجانية محددة للمنتج/الخدمة.",
        subscriptionCustomer: "العميل",
        subscriptionPackage: "اسم الباقة",
        freeAllowance: "عدد الخدمات المجانية",
        startDate: "تاريخ البداية",
        endDate: "تاريخ النهاية",
        saveSubscription: "حفظ الاشتراك",
      },
    };

    // Status copy stays in JS to keep the sheet footprint smaller.
    const statusLabels = {
      PENDING: { en: "Pending", ar: "معلق" },
      IN_PROGRESS: { en: "In progress", ar: "قيد التنفيذ" },
      READY: { en: "Ready", ar: "جاهز" },
      DELIVERED: { en: "Delivered", ar: "تم التسليم" },
    };

    // Minimal client state; priceBook and catalog mirror the sheet.
  const state = {
    lang: "en",
    activeTab: "pos",
    orders: [],
    stats: { totalOrders: 0, byStatus: {}, totalRevenue: 0 },
    priceBook: initialPriceBook,
    catalog: [],
    logoUrl: initialLogo,
    customers: [],
    subscriptions: [],
    selectedCustomer: null,
    selectedSubscription: null,
  };

    document.addEventListener("DOMContentLoaded", () => {
      applyTranslations();
      updateLogo(initialLogo);
      hydratePriceBoard();
      populateSubscriptionProductSelect();
      initStatusFilter();
      addItemRow();
      updateDateDefaults();
      renderCatalogRows();
      fetchCatalog();
      fetchCustomers();
      fetchSubscriptions();
      refreshOrders();
      switchTab("pos");
      document.getElementById("searchInput").addEventListener("input", renderOrders);
      document.getElementById("discount").addEventListener("input", updateTotals);
      document.getElementById("languageToggle").addEventListener("click", toggleLanguage);
      document.getElementById("receiptModal").addEventListener("click", (e) => {
        if (e.target.id === "receiptModal") closeReceipt();
      });
      document.getElementById("posCustomerSearch").addEventListener("input", (e) => renderPosCustomerResults(e.target.value));
    });

    function applyTranslations() {
      const map = translations[state.lang];
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (map[key]) el.textContent = map[key];
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        if (map[key]) el.placeholder = map[key];
      });
      const toggle = document.getElementById("languageToggle");
      if (toggle) toggle.textContent = map.languageToggle;
      document.documentElement.lang = state.lang;
      document.documentElement.dir = state.lang === "ar" ? "rtl" : "ltr";
    }

    function refreshItemLanguage() {
      document.querySelectorAll(".item-row .removeLine").forEach(btn => {
        btn.textContent = state.lang === "ar" ? "حذف" : "Remove";
      });
      document.querySelectorAll(".catalog-row .removeCatalogRow").forEach(btn => {
        btn.textContent = state.lang === "ar" ? "حذف" : "Remove";
      });
    }

    function toggleLanguage() {
      state.lang = state.lang === "en" ? "ar" : "en";
      applyTranslations();
      hydratePriceBoard();
      refreshItemLanguage();
      rebuildItemRows();
      initStatusFilter();
      renderCatalogRows(collectCatalogEntries(true));
      renderOrders();
      renderStats();
    }

    function switchTab(tab) {
      state.activeTab = tab;
      document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
      const tabBtn = document.getElementById(`tab-${tab}`);
      if (tabBtn) tabBtn.classList.add("active");
      document.getElementById("panel-pos").classList.toggle("hidden", tab !== "pos");
      document.getElementById("panel-catalog").classList.toggle("hidden", tab !== "catalog");
      document.getElementById("panel-customers").classList.toggle("hidden", tab !== "customers");
    }

    function t(key) {
      return translations[state.lang][key] || key;
    }

    function statusText(code) {
      return statusLabels[code] ? statusLabels[code][state.lang] : code;
    }

    // Pull latest catalog from the sheet and refresh price book + UI.
    function fetchCatalog() {
      setCatalogStatus(state.lang === "ar" ? "جارٍ التحميل..." : "Loading...");
      google.script.run
        .withSuccessHandler(data => {
          state.catalog = (data && data.catalog) || [];
          if (data && data.priceBook) {
            updatePriceBook(data.priceBook);
          }
          if (data && data.logoUrl) {
            updateLogo(data.logoUrl);
          }
          renderCatalogRows();
          setCatalogStatus("");
        })
        .withFailureHandler(err => {
          setCatalogStatus(err.message || t("catalogFailed"));
        })
        .getCatalog();
    }

    function fetchCustomers(query) {
      google.script.run
        .withSuccessHandler(list => {
          state.customers = Array.isArray(list) ? list : [];
          renderCustomerList();
          renderPosCustomerResults(document.getElementById("posCustomerSearch").value);
          populateSubscriptionCustomerSelect();
          updatePosSubscriptionSelect();
        })
        .withFailureHandler(err => console.log(err))
        .getCustomers(query || "");
    }

    function fetchSubscriptions() {
      google.script.run
        .withSuccessHandler(list => {
          state.subscriptions = Array.isArray(list) ? list : [];
          renderSubscriptionList();
          populateSubscriptionCustomerSelect();
          updatePosSubscriptionSelect();
        })
        .withFailureHandler(err => console.log(err))
        .getSubscriptions();
    }

    function updatePriceBook(book) {
      state.priceBook = book || {};
      hydratePriceBoard();
      rebuildItemRows();
      renderOrders();
      populateSubscriptionProductSelect();
    }

    function updateLogo(url) {
      state.logoUrl = url || state.logoUrl;
      const logoEls = document.querySelectorAll(".app-logo");
      logoEls.forEach(el => {
        if (state.logoUrl) {
          el.src = state.logoUrl;
          el.style.display = "block";
        } else {
          el.style.display = "none";
        }
      });
      const preview = document.getElementById("logoPreview");
      if (preview) updateCatalogImagePreview(preview, state.logoUrl);
    }

    function runCustomerSearch() {
      const q = document.getElementById("customerSearchInput").value;
      fetchCustomers(q);
    }

    function createCustomer() {
      const payload = {
        name: document.getElementById("newCustomerName").value,
        nickname: document.getElementById("newCustomerNickname").value,
        phone: document.getElementById("newCustomerPhone").value,
      };
      google.script.run
        .withSuccessHandler(c => {
          state.customers.push(c);
          document.getElementById("customerCreateStatus").textContent = t("orderSaved");
          renderCustomerList();
          populateSubscriptionCustomerSelect();
          renderPosCustomerResults(document.getElementById("posCustomerSearch").value);
        })
        .withFailureHandler(err => {
          document.getElementById("customerCreateStatus").textContent = err.message || t("orderFailed");
        })
        .saveCustomer(payload);
    }

    function renderCustomerList() {
      const container = document.getElementById("customerList");
      if (!container) return;
      if (!state.customers.length) {
        container.innerHTML = `<div class="muted">${t("listMetaNone")}</div>`;
        return;
      }
      container.innerHTML = state.customers
        .map(c => `<div class="receipt-row"><span>${c.name || ""} (${c.nickname || ""})</span><span>${c.phone || ""}</span></div>`)
        .join("");
    }

    function renderPosCustomerResults(query) {
      const target = document.getElementById("posCustomerResults");
      if (!target) return;
      const q = (query || "").toLowerCase();
      const matches = state.customers.filter(c => {
        const blob = [c.name, c.nickname, c.phone].join(" ").toLowerCase();
        return blob.includes(q);
      }).slice(0, 5);
      target.innerHTML = matches.map(c => `<button class="btn btn-ghost btn-small" type="button" onclick="selectCustomer('${c.customer_id}')">${c.name || c.phone || "Customer"}</button>`).join("");
    }

    function selectCustomer(customerId) {
      const customer = state.customers.find(c => String(c.customer_id) === String(customerId));
      state.selectedCustomer = customer || null;
      document.getElementById("selectedCustomerDisplay").textContent = customer
        ? `${customer.name || ""} • ${customer.phone || ""}`
        : "Walk-in";
      if (customer) {
        document.getElementById("customerName").value = customer.name || "";
        document.getElementById("customerNickname").value = customer.nickname || "";
        document.getElementById("phone").value = customer.phone || "";
      }
      updatePosSubscriptionSelect();
    }

    function clearSelectedCustomer() {
      state.selectedCustomer = null;
      state.selectedSubscription = null;
      document.getElementById("selectedCustomerDisplay").textContent = "Walk-in";
      updatePosSubscriptionSelect();
    }

    function createSubscription() {
      const select = document.getElementById("subscriptionCustomerSelect");
      const payload = {
        customer_id: select.value,
        customer_name: select.options[select.selectedIndex]?.text || "",
        package_name: document.getElementById("subscriptionPackageName").value,
        product_key: document.getElementById("subscriptionProduct").value,
        service_code: document.getElementById("subscriptionService").value,
        free_allowance: Number(document.getElementById("subscriptionAllowance").value) || 0,
        start_date: document.getElementById("subscriptionStart").value,
        end_date: document.getElementById("subscriptionEnd").value,
        active: document.getElementById("subscriptionActive").checked,
      };
      google.script.run
        .withSuccessHandler(list => {
          state.subscriptions = Array.isArray(list) ? list : [];
          renderSubscriptionList();
          updatePosSubscriptionSelect();
          document.getElementById("subscriptionStatus").textContent = t("catalogSaved");
        })
        .withFailureHandler(err => {
          document.getElementById("subscriptionStatus").textContent = err.message || t("catalogFailed");
        })
        .saveSubscription(payload);
    }

    function renderSubscriptionList() {
      const container = document.getElementById("subscriptionList");
      if (!container) return;
      if (!state.subscriptions.length) {
        container.innerHTML = `<div class="muted">${t("listMetaNone")}</div>`;
        return;
      }
      container.innerHTML = state.subscriptions
        .map(sub => `<div class="receipt-row"><span>${sub.package_name || ""} • ${sub.customer_name || ""}</span><span>${sub.remaining_free || 0}/${sub.free_allowance || 0}</span></div>`)
        .join("");
    }

    function populateSubscriptionCustomerSelect() {
      const select = document.getElementById("subscriptionCustomerSelect");
      if (!select) return;
      select.innerHTML = state.customers.map(c => `<option value="${c.customer_id}">${c.name || c.phone || c.customer_id}</option>`).join("");
    }

    function updatePosSubscriptionSelect() {
      const select = document.getElementById("posSubscriptionSelect");
      if (!select) return;
      const customerId = state.selectedCustomer ? state.selectedCustomer.customer_id : null;
      const subs = customerId ? state.subscriptions.filter(sub => String(sub.customer_id) === String(customerId)) : [];
      select.innerHTML = `<option value="">${state.lang === "ar" ? "بدون" : "None"}</option>` + subs.map(sub =>
        `<option value="${sub.subscription_id}">${sub.package_name || sub.service_code || ""} (${sub.remaining_free || 0}/${sub.free_allowance || 0})</option>`
      ).join("");
      select.onchange = () => {
        const val = select.value;
        state.selectedSubscription = subs.find(sub => String(sub.subscription_id) === String(val)) || null;
      };
    }

    // Rebuild item rows after a price book change so selectors stay in sync.
    function rebuildItemRows() {
      const existing = Array.from(document.querySelectorAll(".item-row")).map(row => ({
        productType: row.querySelector(".productSelect")?.value,
        serviceCode: row.querySelector(".serviceSelect")?.value,
        quantity: Number(row.querySelector(".qtyInput")?.value) || 1,
        unitPrice: Number(row.querySelector(".priceInput")?.value) || "",
      }));
      const container = document.getElementById("itemsContainer");
      container.innerHTML = "";
      if (!existing.length) {
        addItemRow();
        return;
      }
      existing.forEach(item => addItemRow(item));
      updateTotals();
    }

    // Repaint catalog editor rows from state or given list.
    function renderCatalogRows(entries) {
      const container = document.getElementById("catalogRows");
      container.innerHTML = "";
      const source = entries && entries.length ? entries : (state.catalog && state.catalog.length ? state.catalog : []);
      const logoInput = document.getElementById("logoInput");
      if (logoInput) {
        logoInput.value = state.logoUrl || "";
        logoInput.oninput = () => {
          updateLogo(logoInput.value);
          const preview = document.getElementById("logoPreview");
          if (preview) updateCatalogImagePreview(preview, logoInput.value);
        };
        const preview = document.getElementById("logoPreview");
        if (preview) updateCatalogImagePreview(preview, state.logoUrl);
      }
      if (!source.length) {
        addCatalogRow();
        return;
      }
      source.forEach(entry => addCatalogRow(entry));
    }

    function populateSubscriptionProductSelect() {
      const productSelect = document.getElementById("subscriptionProduct");
      const serviceSelect = document.getElementById("subscriptionService");
      if (!productSelect || !serviceSelect) return;
      const book = state.priceBook || {};
      productSelect.innerHTML = Object.keys(book).map(key => {
        const product = book[key];
        return `<option value="${key}">${state.lang === "ar" ? product.labelAr : product.label}</option>`;
      }).join("");
      const syncServices = () => {
        const key = productSelect.value;
        const product = book[key] || {};
        serviceSelect.innerHTML = Object.keys(product.services || {}).map(code => {
          const svc = product.services[code];
          return `<option value="${code}">${state.lang === "ar" ? svc.labelAr : svc.label}</option>`;
        }).join("");
      };
      productSelect.onchange = syncServices;
      syncServices();
    }

    function addCatalogRow(prefill = {}) {
      const container = document.getElementById("catalogRows");
      const row = document.createElement("div");
      row.className = "catalog-row";
      row.innerHTML = `
        <div class="form-grid">
          <div>
            <label>${t("productKey")}</label>
            <input type="text" class="catalog-product-key" value="${prefill.product_key || ""}">
          </div>
          <div>
            <label>${t("productLabel")} (EN)</label>
            <input type="text" class="catalog-product-label-en" value="${prefill.product_label_en || ""}">
          </div>
          <div>
            <label>${t("productLabel")} (AR)</label>
            <input type="text" class="catalog-product-label-ar" value="${prefill.product_label_ar || ""}">
          </div>
          <div>
            <label>${t("serviceCode")}</label>
            <input type="text" class="catalog-service-code" value="${prefill.service_code || ""}">
          </div>
          <div>
            <label>${t("serviceLabel")} (EN)</label>
            <input type="text" class="catalog-service-label-en" value="${prefill.service_label_en || ""}">
          </div>
          <div>
            <label>${t("serviceLabel")} (AR)</label>
            <input type="text" class="catalog-service-label-ar" value="${prefill.service_label_ar || ""}">
          </div>
          <div>
            <label>${t("priceLabel")}</label>
            <input type="number" min="0" step="0.001" class="catalog-price" value="${prefill.price != null ? prefill.price : ""}">
          </div>
          <div>
            <label>${t("imageLabel")}</label>
            <input type="url" class="catalog-image-input" value="${prefill.image_url || ""}">
            <img class="catalog-image" src="${prefill.image_url || ""}" alt="">
          </div>
          <div>
            <label>${t("activeLabel")}</label>
            <input type="checkbox" class="catalog-active" ${prefill.active === false ? "" : "checked"}>
          </div>
        </div>
        <div class="catalog-row-footer">
          <button class="btn btn-ghost removeCatalogRow" type="button">${state.lang === "ar" ? "حذف" : "Remove"}</button>
        </div>
      `;

      const imgInput = row.querySelector(".catalog-image-input");
      const img = row.querySelector(".catalog-image");
      img.onerror = () => img.style.display = "none";
      const updatePreview = () => updateCatalogImagePreview(img, imgInput.value);
      imgInput.addEventListener("input", updatePreview);
      updatePreview();

      row.querySelector(".removeCatalogRow").addEventListener("click", () => {
        row.remove();
      });

      container.appendChild(row);
    }

    function collectCatalogEntries(skipEmpty) {
      const rows = Array.from(document.querySelectorAll(".catalog-row"));
      const entries = rows.map(row => ({
        product_key: (row.querySelector(".catalog-product-key")?.value || "").trim(),
        product_label_en: (row.querySelector(".catalog-product-label-en")?.value || "").trim(),
        product_label_ar: (row.querySelector(".catalog-product-label-ar")?.value || "").trim(),
        service_code: (row.querySelector(".catalog-service-code")?.value || "").trim().toUpperCase(),
        service_label_en: (row.querySelector(".catalog-service-label-en")?.value || "").trim(),
        service_label_ar: (row.querySelector(".catalog-service-label-ar")?.value || "").trim(),
        price: Number(row.querySelector(".catalog-price")?.value) || 0,
        image_url: (row.querySelector(".catalog-image-input")?.value || "").trim(),
        active: !!row.querySelector(".catalog-active")?.checked,
      }));
      return skipEmpty ? entries.filter(e => e.product_key || e.service_code || e.price) : entries;
    }

    function saveCatalog() {
      const entries = collectCatalogEntries().filter(entry => entry.product_key && entry.service_code);
      if (!entries.length) {
        showCatalogToast(t("catalogFailed"), true);
        return;
      }
      setCatalogStatus(state.lang === "ar" ? "جارٍ الحفظ..." : "Saving...");
      const logoUrl = document.getElementById("logoInput")?.value || state.logoUrl || "";
      google.script.run
        .withSuccessHandler(data => {
          state.catalog = data && data.catalog ? data.catalog : entries;
          if (data && data.priceBook) {
            updatePriceBook(data.priceBook);
          }
          if (data && data.logoUrl) {
            updateLogo(data.logoUrl);
          }
          showCatalogToast(t("catalogSaved"), false);
          renderCatalogRows();
          setCatalogStatus("");
        })
        .withFailureHandler(err => {
          showCatalogToast(`${t("catalogFailed")}: ${err.message}`, true);
          setCatalogStatus("");
        })
        .saveCatalog({ entries, logoUrl });
    }

    function setCatalogStatus(message) {
      const target = document.getElementById("catalogStatus");
      if (target) target.textContent = message || "";
    }

    function showCatalogToast(message, isError) {
      const toast = document.getElementById("catalogToast");
      toast.textContent = message;
      toast.className = `toast ${isError ? "error" : "success"}`;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 4000);
    }

    function updateCatalogImagePreview(imgEl, url) {
      if (!imgEl) return;
      if (!url) {
        imgEl.style.display = "none";
        return;
      }
      imgEl.src = url;
      imgEl.style.display = "block";
    }

    function hydratePriceBoard() {
      const board = document.getElementById("priceBoard");
      board.innerHTML = "";
      const book = state.priceBook || {};
      Object.keys(book).forEach(productKey => {
        const product = book[productKey];
        const card = document.createElement("div");
        card.className = "price-card";
        const productLabel = state.lang === "ar" ? product.labelAr : product.label;
        const img = product.imageUrl ? `<img src="${product.imageUrl}" alt="${productLabel}" onerror="this.style.display='none'">` : "";
        card.innerHTML = `${img}<h4>${productLabel}</h4>`;
        Object.keys(product.services || {}).forEach(serviceKey => {
          const svc = product.services[serviceKey];
          const label = state.lang === "ar" ? svc.labelAr : svc.label;
          const price = Number(svc.price || 0).toFixed(3);
          const row = document.createElement("div");
          row.className = "price-row";
          row.innerHTML = `<span>${label}</span><span class="badge">${currency} ${price}</span>`;
          card.appendChild(row);
        });
        board.appendChild(card);
      });
    }

    function initStatusFilter() {
      const select = document.getElementById("statusFilter");
      select.innerHTML = "";
      const anyOption = document.createElement("option");
      anyOption.value = "";
      anyOption.textContent = t("filterStatus");
      select.appendChild(anyOption);
      Object.keys(orderStatuses).forEach(key => {
        const opt = document.createElement("option");
        opt.value = orderStatuses[key];
        opt.textContent = statusText(orderStatuses[key]);
        select.appendChild(opt);
      });
      select.onchange = renderOrders;
    }

    function updateDateDefaults() {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById("walkInDate").value = today;
      document.getElementById("exitDate").value = today;
    }

    function addItemRow(prefill = {}) {
      const container = document.getElementById("itemsContainer");
      const row = document.createElement("div");
      row.className = "item-row";
      row.innerHTML = `
        <div class="form-grid">
          <div>
            <label data-i18n="productLabel">${t("productLabel") || "Product"}</label>
            <select class="productSelect"></select>
          </div>
          <div>
            <label data-i18n="serviceLabel">${t("serviceLabel") || "Service"}</label>
            <select class="serviceSelect"></select>
          </div>
          <div>
            <label data-i18n="qtyLabel">${t("qtyLabel") || "Qty"}</label>
            <input type="number" min="1" step="1" class="qtyInput" value="${prefill.quantity || 1}">
          </div>
          <div>
            <label data-i18n="priceLabel">${t("priceLabel") || "Unit price"}</label>
            <input type="number" min="0" step="0.001" class="priceInput" value="${prefill.unitPrice || ""}">
          </div>
        </div>
        <div class="item-row-actions">
          <span class="muted" data-i18n="lineTotal">${t("lineTotal") || "Line total"}</span>
          <div class="pill lineTotal">0.000</div>
          <button class="btn btn-ghost removeLine" type="button">${state.lang === "ar" ? "حذف" : "Remove"}</button>
        </div>
      `;

      container.appendChild(row);
      populateProductOptions(row.querySelector(".productSelect"), prefill.productType);
      populateServiceOptions(row, prefill.serviceCode);
      updateLineRow(row, prefill.unitPrice);

      row.querySelector(".productSelect").addEventListener("change", () => {
        populateServiceOptions(row);
        updateLineRow(row);
      });
      row.querySelector(".serviceSelect").addEventListener("change", () => updateLineRow(row));
      row.querySelector(".qtyInput").addEventListener("input", () => updateLineRow(row));
      row.querySelector(".priceInput").addEventListener("input", () => updateLineRow(row, null, true));
      row.querySelector(".removeLine").addEventListener("click", () => {
        row.remove();
        updateTotals();
      });

      updateTotals();
    }

    function populateProductOptions(select, selectedKey) {
      select.innerHTML = "";
      const book = state.priceBook || {};
      Object.keys(book).forEach(key => {
        const product = book[key];
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = state.lang === "ar" ? product.labelAr : product.label;
        select.appendChild(opt);
      });
      if (selectedKey) select.value = selectedKey;
    }

    function populateServiceOptions(row, selectedKey) {
      const select = row.querySelector(".serviceSelect");
      const productKey = row.querySelector(".productSelect").value;
      const book = state.priceBook || {};
      const product = book[productKey] || book.custom || { services: {} };
      select.innerHTML = "";
      Object.keys(product.services || {}).forEach(key => {
        const service = product.services[key];
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = state.lang === "ar" ? service.labelAr : service.label;
        select.appendChild(opt);
      });
      if (selectedKey) select.value = selectedKey;
    }

    function lookupPrice(productKey, serviceKey) {
      const product = (state.priceBook || {})[productKey];
      const service = product && product.services ? product.services[serviceKey] : null;
      return service ? Number(service.price || 0) : 0;
    }

    function updateLineRow(row, presetPrice, manualInput) {
      const productKey = row.querySelector(".productSelect").value;
      const serviceKey = row.querySelector(".serviceSelect").value;
      const qty = Math.max(1, Number(row.querySelector(".qtyInput").value) || 1);
      const priceInput = row.querySelector(".priceInput");
      const derivedPrice = presetPrice != null ? presetPrice : lookupPrice(productKey, serviceKey);
      if (!manualInput) {
        priceInput.value = Number(priceInput.value || derivedPrice || 0).toFixed(3);
      }
      const unitPrice = Number(priceInput.value) || 0;
      priceInput.value = unitPrice.toFixed(3);
      const lineTotal = (unitPrice * qty).toFixed(3);
      row.querySelector(".lineTotal").textContent = `${currency} ${lineTotal}`;
      updateTotals();
    }

    function updateTotals() {
      const discount = Number(document.getElementById("discount").value) || 0;
      let subtotal = 0;
      document.querySelectorAll(".item-row").forEach(row => {
        const qty = Math.max(1, Number(row.querySelector(".qtyInput").value) || 1);
        const price = Number(row.querySelector(".priceInput").value) || 0;
        subtotal += qty * price;
      });
      const total = Math.max(0, subtotal - discount);
      const summary = document.getElementById("totalsSummary");
      summary.textContent = `${currency} ${subtotal.toFixed(3)} → ${currency} ${total.toFixed(3)}`;
    }

    function collectPayload() {
      const items = Array.from(document.querySelectorAll(".item-row")).map(row => ({
        productType: row.querySelector(".productSelect").value,
        serviceCode: row.querySelector(".serviceSelect").value,
        quantity: Number(row.querySelector(".qtyInput").value) || 1,
        unitPrice: Number(row.querySelector(".priceInput").value) || 0,
      })).filter(item => item.quantity > 0);

      const customer = state.selectedCustomer;
      const subscriptionId = state.selectedSubscription ? state.selectedSubscription.subscription_id : (document.getElementById("posSubscriptionSelect").value || "");

      return {
        customerName: document.getElementById("customerName").value,
        customerNickname: document.getElementById("customerNickname")?.value || "",
        phone: document.getElementById("phone").value,
        customerId: customer ? customer.customer_id : "",
        subscriptionId,
        walkInDate: document.getElementById("walkInDate").value,
        exitDate: document.getElementById("exitDate").value,
        discount: Number(document.getElementById("discount").value) || 0,
        notes: document.getElementById("notes").value,
        items,
      };
    }

    function submitOrder(evt) {
      evt.preventDefault();
      const payload = collectPayload();
      if (!payload.items.length) {
        showToast(t("orderFailed"), true);
        return;
      }

      setFormBusy(true);
      google.script.run
        .withSuccessHandler(res => {
          // Optimistic add so UI shows immediately even before refetch.
          const optimistic = {
            order_id: res.orderId || "",
            order_number: res.orderNumber || "",
            customer_name: payload.customerName || (state.selectedCustomer && state.selectedCustomer.name) || "",
            customer_nickname: payload.customerNickname || (state.selectedCustomer && state.selectedCustomer.nickname) || "",
            phone: payload.phone || (state.selectedCustomer && state.selectedCustomer.phone) || "",
            walk_in_date: payload.walkInDate,
            exit_date: payload.exitDate,
            total: Math.max(0, (payload.items || []).reduce((s, i) => s + (i.quantity * i.unitPrice), 0) - (payload.discount || 0)),
            subtotal: (payload.items || []).reduce((s, i) => s + (i.quantity * i.unitPrice), 0),
            discount: payload.discount || 0,
            status: orderStatuses.PENDING,
            items: payload.items.map(i => ({
              product_type: i.productType,
              service_code: i.serviceCode,
              quantity: i.quantity,
              unit_price: i.unitPrice,
              line_total: (i.quantity * i.unitPrice),
            })),
            subscription_id: payload.subscriptionId || "",
          };
          state.orders.unshift(optimistic);
          renderOrders();
          renderStats();
          showToast(`${t("orderSaved")} • ${res.orderNumber}`, false);
          setFormBusy(false);
          resetForm();
          refreshOrders();
        })
        .withFailureHandler(err => {
          showToast(`${t("orderFailed")}: ${err.message}`, true);
          setFormBusy(false);
        })
        .recordOrder(payload);
    }

    function setFormBusy(isBusy) {
      const btn = document.getElementById("submitBtn");
      btn.disabled = isBusy;
      btn.textContent = isBusy ? "..." : t("saveOrder");
    }

    function resetForm() {
      document.getElementById("orderForm").reset();
      document.getElementById("itemsContainer").innerHTML = "";
      addItemRow();
      updateDateDefaults();
      updateTotals();
    }

    function showToast(message, isError) {
      const toast = document.getElementById("orderToast");
      toast.textContent = message;
      toast.className = `toast ${isError ? "error" : "success"}`;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 4000);
    }

    function refreshOrders() {
      const meta = document.getElementById("listMeta");
      meta.textContent = state.lang === "ar" ? "..." : "Loading...";
      google.script.run
        .withSuccessHandler(data => {
          state.orders = data.orders || [];
          state.stats = data.stats || { totalOrders: 0, byStatus: {}, totalRevenue: 0 };
          if (data && data.priceBook) {
            updatePriceBook(data.priceBook);
          }
          if (data && data.logoUrl) {
            updateLogo(data.logoUrl);
          }
          if (data && data.customers) {
            state.customers = data.customers;
            renderCustomerList();
            populateSubscriptionCustomerSelect();
            renderPosCustomerResults(document.getElementById("posCustomerSearch").value);
          }
          if (data && data.subscriptions) {
            state.subscriptions = data.subscriptions;
            renderSubscriptionList();
            updatePosSubscriptionSelect();
          }
          renderOrders();
          renderStats();
        })
        .withFailureHandler(err => {
          meta.textContent = err.message || t("orderFailed");
        })
        .getOrders();
    }

    function renderStats() {
      const statsEl = document.getElementById("stats");
      statsEl.innerHTML = "";
      const cards = [
        { label: t("totalOrders"), value: state.stats.totalOrders || 0 },
        { label: t("revenue"), value: `${currency} ${(state.stats.totalRevenue || 0).toFixed(3)}` },
        { label: t("statusBreakdown"), value: "" },
      ];

      cards.forEach((card, idx) => {
        const div = document.createElement("div");
        div.className = "stat-card";
        div.innerHTML = `<div class="stat-label">${card.label}</div><div class="stat-value">${card.value}</div>`;
        if (idx === 2) {
          const statusWrap = document.createElement("div");
          Object.keys(orderStatuses).forEach(key => {
            const code = orderStatuses[key];
            const count = (state.stats.byStatus && state.stats.byStatus[code]) || 0;
            const row = document.createElement("div");
            row.className = "price-row";
            row.innerHTML = `<span>${statusText(code)}</span><span class="badge">${count}</span>`;
            statusWrap.appendChild(row);
          });
          div.appendChild(statusWrap);
        }
        statsEl.appendChild(div);
      });

      renderMgmtDashboard();
      renderReportingDashboard();
    }

    function renderMgmtDashboard() {
      const target = document.getElementById("mgmtDashboard");
      if (!target) return;
      const pending = state.stats.byStatus ? (state.stats.byStatus[orderStatuses.PENDING] || 0) : 0;
      const ready = state.stats.byStatus ? (state.stats.byStatus[orderStatuses.READY] || 0) : 0;
      const inProgress = state.stats.byStatus ? (state.stats.byStatus[orderStatuses.IN_PROGRESS] || 0) : 0;
      const delivered = state.stats.byStatus ? (state.stats.byStatus[orderStatuses.DELIVERED] || 0) : 0;
      target.innerHTML = `
        <div class="receipt-row"><span>${statusText(orderStatuses.PENDING)}</span><span>${pending}</span></div>
        <div class="receipt-row"><span>${statusText(orderStatuses.IN_PROGRESS)}</span><span>${inProgress}</span></div>
        <div class="receipt-row"><span>${statusText(orderStatuses.READY)}</span><span>${ready}</span></div>
        <div class="receipt-row"><span>${statusText(orderStatuses.DELIVERED)}</span><span>${delivered}</span></div>
      `;
    }

    function renderReportingDashboard() {
      const target = document.getElementById("reportingDashboard");
      if (!target) return;
      const orders = state.orders || [];
      const revenueLast7 = computeRevenueByDay(7);
      const avgTicket = orders.length ? (orders.reduce((s, o) => s + (Number(o.total) || 0), 0) / orders.length) : 0;
      const topCustomer = findTopCustomer();
      target.innerHTML = `
        <div class="receipt-row"><span>${t("revenue")}</span><span>${currency} ${(state.stats.totalRevenue || 0).toFixed(3)}</span></div>
        <div class="receipt-row"><span>${t("totalOrders")}</span><span>${orders.length}</span></div>
        <div class="receipt-row"><span>${t("avgTicket") || "Avg ticket"}</span><span>${currency} ${avgTicket.toFixed(3)}</span></div>
        <div class="receipt-row"><span>${t("topCustomer") || "Top customer"}</span><span>${topCustomer}</span></div>
        <div class="receipt-row"><span>${t("last7") || "Last 7 days"}</span><span>${currency} ${revenueLast7.toFixed(3)}</span></div>
      `;
    }

    function computeRevenueByDay(days) {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      return (state.orders || []).reduce((sum, order) => {
        const date = order.walk_in_date ? new Date(order.walk_in_date) : null;
        if (date && date >= cutoff) {
          sum += Number(order.total) || 0;
        }
        return sum;
      }, 0);
    }

    function findTopCustomer() {
      const map = {};
      (state.orders || []).forEach(o => {
        const name = o.customer_name || o.customer_nickname || o.phone || "Walk-in";
        map[name] = (map[name] || 0) + (Number(o.total) || 0);
      });
      const top = Object.entries(map).sort((a, b) => b[1] - a[1])[0];
      return top ? `${top[0]} (${currency} ${top[1].toFixed(3)})` : "-";
    }

    function renderOrders() {
      const tbody = document.getElementById("ordersTable");
      const query = document.getElementById("searchInput").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;

      const filtered = state.orders.filter(order => {
        const matchText = [order.order_number, order.customer_name, order.customer_nickname, order.phone].join(" ").toLowerCase();
        const matchesSearch = !query || matchText.includes(query);
        const matchesStatus = !status || order.status === status;
        return matchesSearch && matchesStatus;
      });

      tbody.innerHTML = "";
      filtered.forEach(order => {
        const statusCode = order.status || orderStatuses.PENDING;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${order.order_number || "-"}</strong></td>
          <td>
            <div><small class="muted">${t("walkInLabel")}</small> ${formatDate(order.walk_in_date)}</div>
            <div><small class="muted">${t("exitLabel")}</small> ${formatDate(order.exit_date)}</div>
          </td>
          <td>
            <div>${order.customer_name || "-"}</div>
            <div class="muted">${order.phone || ""}</div>
          </td>
          <td>${renderItems(order.items || [])}${order.subscription_id ? `<div class="muted">${t("subscriptionTag")}: ${order.subscription_id}</div>` : ""}</td>
          <td><strong>${currency} ${(Number(order.total) || 0).toFixed(3)}</strong></td>
          <td><span class="status ${statusCode}">${statusText(statusCode)}</span></td>
          <td><button class="btn btn-ghost btn-small" type="button" onclick="openReceipt('${order.order_id || ""}')">${t("viewReceipt")}</button></td>
        `;
        tbody.appendChild(tr);
      });

      const meta = document.getElementById("listMeta");
      meta.textContent = filtered.length
        ? `${filtered.length} ${t("listMetaSome")}`
        : t("listMetaNone");
    }

    function openReceipt(orderId) {
      const order = (state.orders || []).find(o => String(o.order_id) === String(orderId) || String(o.order_number) === String(orderId));
      if (!order) return;
      document.getElementById("receiptEnglish").innerHTML = buildReceiptSection(order, "en");
      document.getElementById("receiptArabic").innerHTML = buildReceiptSection(order, "ar");
      document.getElementById("receiptModal").style.display = "flex";
    }

    function closeReceipt() {
      document.getElementById("receiptModal").style.display = "none";
    }

    function printReceipt() {
      const win = window.open("", "_blank");
      if (!win) return;
      const logo = state.logoUrl ? `<img src="${state.logoUrl}" style="max-height:50px;object-fit:contain;">` : "";
      const html = `
        <html>
          <head>
            <title>${t("receiptTitle")}</title>
            <style>
              body { font-family: 'Space Grotesk', Arial, sans-serif; padding: 12px; }
              .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
              .receipt-section { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; }
              .receipt-row { display: flex; justify-content: space-between; border-bottom: 1px solid #e5e7eb; padding: 6px 0; font-size: 13px; }
              .receipt-row:last-child { border-bottom: none; }
              .receipt-items { margin-top: 6px; }
            </style>
          </head>
          <body>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div>${logo}</div>
              <strong>${t("receiptTitle")}</strong>
            </div>
            <div class="grid">
              ${document.getElementById("receiptEnglish").innerHTML}
              ${document.getElementById("receiptArabic").innerHTML}
            </div>
            <script>window.onload = function(){ window.print(); }<\/script>
          </body>
        </html>
      `;
      win.document.write(html);
      win.document.close();
    }

    function buildReceiptSection(order, lang) {
      const map = translations[lang] || translations.en;
      const lineItems = (order.items || []).map(item => {
        const labels = resolveItemLabels(item, lang);
        const qty = item.quantity || 1;
        const unit = Number(item.unit_price || 0).toFixed(3);
        const total = Number(item.line_total || (qty * unit)).toFixed(3);
        return `
          <div class="receipt-row">
            <span>${qty}× ${labels.product} • ${labels.service}</span>
            <span>${currency} ${total}</span>
          </div>
        `;
      }).join("") || `<div class="receipt-row"><span class="muted">-</span><span></span></div>`;

      const subtotal = Number(order.subtotal || 0).toFixed(3);
      const discount = Number(order.discount || 0).toFixed(3);
      const total = Number(order.total || 0).toFixed(3);
      const statusCopy = statusLabels[order.status || orderStatuses.PENDING]
        ? statusLabels[order.status || orderStatuses.PENDING][lang]
        : (order.status || orderStatuses.PENDING);

      return `
        <div class="receipt-section">
          <div class="receipt-row"><strong>${map.receiptOrder}</strong><span>${order.order_number || ""}</span></div>
          <div class="receipt-row"><strong>${map.receiptCustomer}</strong><span>${order.customer_name || ""}</span></div>
          <div class="receipt-row"><strong>${map.receiptDates}</strong><span>${map.receiptWalkIn}: ${formatDate(order.walk_in_date)} • ${map.receiptExit}: ${formatDate(order.exit_date)}</span></div>
          <div class="receipt-row"><strong>${map.receiptStatus}</strong><span>${statusCopy}</span></div>
          <div class="receipt-items">
            <div class="receipt-row"><strong>${map.receiptItems}</strong><span></span></div>
            ${lineItems}
          </div>
          <div class="receipt-row"><strong>${map.receiptSubtotal}</strong><span>${currency} ${subtotal}</span></div>
          <div class="receipt-row"><strong>${map.receiptDiscount}</strong><span>${currency} ${discount}</span></div>
          <div class="receipt-row"><strong>${map.receiptTotal}</strong><span>${currency} ${total}</span></div>
          <div class="receipt-row"><strong>${map.receiptNotes}</strong><span>${order.notes || ""}</span></div>
        </div>
      `;
    }

    function resolveItemLabels(item, lang) {
      const book = state.priceBook || {};
      const product = book[item.product_type] || {};
      const productLabel = product.label ? (lang === "ar" ? product.labelAr : product.label) : (lang === "ar" ? item.product_label_ar : item.product_label) || item.product_label || item.product_type || "";
      const service = (product.services && product.services[item.service_code]) || {};
      const serviceLabel = service.label ? (lang === "ar" ? service.labelAr : service.label) : (lang === "ar" ? item.service_label_ar : item.service_label) || item.service_label || item.service_code || "";
      return { product: productLabel, service: serviceLabel };
    }

    function renderItems(items) {
      if (!items.length) return `<span class="muted">-</span>`;
      return `<div class="order-items">${items.map(item => {
        const book = state.priceBook || {};
        const product = book[item.product_type] || book.custom || {};
        const productLabel = product ? (state.lang === "ar" ? product.labelAr : product.label) : (item.product_label || "");
        const service = (product && product.services && product.services[item.service_code]) || {};
        const serviceLabel = service.label ? (state.lang === "ar" ? service.labelAr : service.label) : (item.service_label || "");
        const qty = item.quantity || 1;
        const free = item.freeApplied ? ` (${item.freeApplied} ${state.lang === "ar" ? "مجانية" : "free"})` : "";
        return `<span class="tag">${qty}× ${productLabel} • ${serviceLabel}${free}</span>`;
      }).join("")}</div>`;
    }

    function formatDate(value) {
      const d = value ? new Date(value) : null;
      if (!d || isNaN(d.getTime())) return "-";
      return d.toLocaleDateString(state.lang === "ar" ? "ar" : "en", { year: "numeric", month: "short", day: "numeric" });
    }
  </script>
</body>
</html>
