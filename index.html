<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin Office Licenses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap: 12px; --radius: 10px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #f6f7fb; color: #1c1c1c; }
    header { background: #1f2937; color: white; padding: 14px 18px; }
    header h1 { margin: 0; font-size: 18px; }
    .container { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .card { background: white; border-radius: var(--radius); padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .grid { display: grid; gap: var(--gap); }
    .grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .stat { padding: 16px; border-radius: var(--radius); text-align: center; }
    .stat h2 { margin: 6px 0 0; font-size: 28px; }
    .tabs { display: flex; gap: 6px; margin-bottom: 10px; }
    .tab { padding: 10px 12px; border-radius: 8px; background: #e5e7eb; cursor: pointer; user-select: none; }
    .tab.active { background: #111827; color: white; }
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; }
    .grow { flex: 1; min-width: 240px; }
    input, textarea, select, button { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font: inherit; background: white; }
    button { cursor: pointer; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    tr:hover { background: #fafafa; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; }
    .status-Expired { background: #fee2e2; color: #991b1b; }
    .status-Upcoming { background: #fef3c7; color: #92400e; }
    .status-Active { background: #dcfce7; color: #166534; }
    .muted { color: #6b7280; font-size: 12px; }
    .link { color: #2563eb; text-decoration: none; }
    .link:hover { text-decoration: underline; }
    .hidden { display: none; }
    .preview { width: 100%; height: 70vh; border: 0; border-radius: 10px; background: #fafafa; }
    .loading { opacity: .7; pointer-events: none; }
  </style>
</head>
<body>
  <header><h1>Admin Office Licenses</h1></header>
  <div class="container">

    <div class="tabs" role="tablist" aria-label="Sections">
      <button type="button" class="tab active" data-tab="dashboard" role="tab" aria-selected="true">Dashboard</button>
      <button type="button" class="tab" data-tab="upload" role="tab" aria-selected="false">Upload</button>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="grid" style="gap:16px;">
      <div class="grid cols-3">
        <div class="card stat">
          <div class="muted">Expired</div>
          <h2 id="stat-expired">0</h2>
        </div>
        <div class="card stat">
          <div class="muted">Upcoming (≤ 30 days)</div>
          <h2 id="stat-upcoming">0</h2>
        </div>
        <div class="card stat">
          <div class="muted">Active</div>
          <h2 id="stat-active">0</h2>
        </div>
      </div>

      <div class="card">
        <div class="row" style="align-items:center; margin-bottom:10px;">
          <input id="search" class="grow" placeholder="Search by name, description, labels…" aria-label="Search" />
          <button type="button" id="btnRefresh" style="max-width:160px;" aria-busy="false">Refresh</button>
        </div>
        <div class="muted" id="result-count" role="status" aria-live="polite">0 result(s)</div>
        <div style="overflow:auto;">
          <table id="table" aria-label="Licenses table">
            <thead>
              <tr>
                <th>ID</th><th>Name</th><th>Description</th>
                <th>Expiry 1</th><th>Expiry 2</th>
                <th>Status</th><th>File</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="preview-card" class="card hidden" aria-live="polite">
        <div class="row" style="align-items:center;">
          <div class="grow"><strong id="preview-title">Preview</strong></div>
          <button type="button" id="btnClosePreview" style="max-width:120px;">Close</button>
        </div>
        <div id="preview-body">
          <iframe id="preview-frame" class="preview" title="File preview"></iframe>
        </div>
      </div>
    </section>

    <!-- UPLOAD -->
    <section id="upload" class="hidden">
      <div class="card">
        <form id="uploadForm">
          <div class="row">
            <div class="grow">
              <label>Name</label>
              <input name="name" required />
            </div>
            <div class="grow">
              <label>Description</label>
              <input name="description" />
            </div>
          </div>
          <div class="row">
            <div class="grow">
              <label>Expiry 1 Label</label>
              <input name="exp1Label" placeholder="e.g., License Expiry" />
            </div>
            <div class="grow">
              <label>Expiry 1 Date</label>
              <input type="date" name="exp1Date" />
            </div>
          </div>
          <div class="row">
            <div class="grow">
              <label>Expiry 2 Label</label>
              <input name="exp2Label" placeholder="e.g., Insurance Expiry" />
            </div>
            <div class="grow">
              <label>Expiry 2 Date</label>
              <input type="date" name="exp2Date" />
            </div>
          </div>
          <div class="row" style="align-items:flex-end;">
            <div class="grow">
              <label>Document (Image or PDF)</label>
              <input type="file" name="file" accept="image/*,application/pdf" />
              <div class="muted">Optional. Files up to ~5MB recommended.</div>
            </div>
            <div style="min-width:160px;">
              <button type="submit" id="btnUpload" aria-busy="false">Save</button>
            </div>
          </div>
        </form>
        <div id="uploadResult" class="muted" style="margin-top:10px;" role="status" aria-live="polite"></div>
      </div>
    </section>

  </div>

  <script>
  (function(){
    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>{
          x.classList.remove('active'); x.setAttribute('aria-selected','false');
        });
        t.classList.add('active'); t.setAttribute('aria-selected','true');
        const tab = t.dataset.tab;
        document.getElementById('dashboard').classList.toggle('hidden', tab!=='dashboard');
        document.getElementById('upload').classList.toggle('hidden', tab!=='upload');
      });
    });

    // Search / Refresh
    const searchEl = document.getElementById('search');
    const btnRefresh = document.getElementById('btnRefresh');
    searchEl.addEventListener('input', debounce(refresh, 250));
    btnRefresh.addEventListener('click', refresh);
    function debounce(fn, ms){ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a), ms); }; }

    function statusPill(status) {
      const base = 'pill status-';
      if (String(status||'').startsWith('Upcoming')) return `<span class="${base}Upcoming">${escapeHtml(status)}</span>`;
      if (status === 'Expired') return `<span class="${base}Expired">Expired</span>`;
      return `<span class="${base}Active">Active</span>`;
    }
    function escapeHtml(s) {
      return String(s ?? '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function escapeAttr(s) {
      return String(s ?? '')
        .replace(/&/g,'&amp;').replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;').replace(/</g,'&lt;');
    }
    function safeHref(url) {
      const value = String(url || '').trim();
      return /^https?:\/\//i.test(value) ? value : '';
    }
    function setLoading(el, isLoading){
      if (!el) return;
      const loading = !!isLoading;
      el.classList.toggle('loading', loading);
      if ('disabled' in el) el.disabled = loading;
      el.setAttribute('aria-busy', loading ? 'true' : 'false');
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#table tbody');
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted">No matching records.</td></tr>';
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const exp1 = `${escapeHtml(r.exp1Label)}${r.exp1Date ? ' ('+escapeHtml(r.exp1Date)+')' : ''}`;
        const exp2 = `${escapeHtml(r.exp2Label)}${r.exp2Date ? ' ('+escapeHtml(r.exp2Date)+')' : ''}`;
        const fileUrl = safeHref(r.fileUrl);
        const previewUrl = safeHref(r.filePreviewUrl);
        const previewTitle = r.fileName || r.name || 'Preview';
        const previewLink = previewUrl
          ? ` · <a class="link link-preview" role="button" href="#" data-preview-url="${escapeAttr(previewUrl)}" data-preview-title="${escapeAttr(previewTitle)}">Preview</a>`
          : '';
        const fileCell = fileUrl
          ? `<a class="link" href="${escapeAttr(fileUrl)}" target="_blank" rel="noopener">Open</a>${previewLink}`
          : '<span class="muted">—</span>';
        return `
          <tr>
            <td>${escapeHtml(r.id)}</td>
            <td>${escapeHtml(r.name)}</td>
            <td>${escapeHtml(r.description)}</td>
            <td>${exp1}</td>
            <td>${exp2}</td>
            <td>${statusPill(r.status)}</td>
            <td>${fileCell}</td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('.link-preview').forEach(link => {
        link.addEventListener('click', evt => {
          evt.preventDefault();
          preview(link.getAttribute('data-preview-url'), link.getAttribute('data-preview-title'));
        });
      });
    }

    function refresh() {
      const q = searchEl.value || '';
      setLoading(btnRefresh, true);
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error('Google Apps Script runtime is unavailable.');
        }
        google.script.run.withSuccessHandler(({rows, countsAll, countsFiltered})=>{
          document.getElementById('stat-expired').textContent = countsAll.expired;
          document.getElementById('stat-upcoming').textContent = countsAll.upcoming;
          document.getElementById('stat-active').textContent = countsAll.active;
          const resultsLabel = countsFiltered.total === countsAll.total
            ? `${countsFiltered.total} result(s)`
            : `${countsFiltered.total} result(s) of ${countsAll.total} total`;
          document.getElementById('result-count').textContent = resultsLabel;
          renderTable(rows);
          setLoading(btnRefresh, false);
        }).withFailureHandler(err=>{
          alert('Failed to load: ' + (err && err.message ? err.message : err));
          setLoading(btnRefresh, false);
          document.getElementById('result-count').textContent = 'Failed to load data.';
        }).getDashboardData(q);
      } catch(e) {
        console.error(e);
        setLoading(btnRefresh, false);
        document.getElementById('result-count').textContent = 'Unable to load data.';
      }
    }

    window.preview = function(url, title){
      const safeUrl = safeHref(url);
      if (!safeUrl) return;
      document.getElementById('preview-title').textContent = title || 'Preview';
      const frame = document.getElementById('preview-frame');
      frame.src = safeUrl;
      document.getElementById('preview-card').classList.remove('hidden');
      if (typeof frame.focus === 'function') {
        frame.focus();
      }
    };
    document.getElementById('btnClosePreview').addEventListener('click', ()=>{
      document.getElementById('preview-card').classList.add('hidden');
      document.getElementById('preview-frame').src = '';
    });

    // Upload (base64)
    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const btn = document.getElementById('btnUpload');
      const out = document.getElementById('uploadResult');
      setLoading(btn, true);
      out.textContent = 'Uploading…';

      try {
        const fd = new FormData(form);
        const obj = {};
        fd.forEach((v,k)=>{ obj[k] = v; });

        const fileInput = form.file;
        if (fileInput && fileInput.files && fileInput.files.length) {
          const file = fileInput.files[0];
          obj.fileName = file.name;
          obj.fileType = file.type || 'application/octet-stream';
          obj.fileB64 = await readAsBase64_(file);
        }

        google.script.run.withSuccessHandler(res=>{
          setLoading(btn, false);
          if (res && res.ok) {
            const openUrl = res.fileUrl ? safeHref(res.fileUrl) : '';
            const linkHtml = openUrl ? ` · <a class="link" target="_blank" rel="noopener" href="${escapeAttr(openUrl)}">Open file</a>` : '';
            out.innerHTML = `Saved. ID: ${escapeHtml(res.id)}${linkHtml}`;
            form.reset();
            refresh();
          } else {
            const message = res && res.error ? `Error: ${res.error}` : 'Error saving record.';
            out.textContent = message;
          }
        }).withFailureHandler(err=>{
          setLoading(btn, false);
          out.textContent = 'Failed: ' + (err && err.message ? err.message : err);
        }).uploadDocument(obj);
      } catch (err) {
        setLoading(btn, false);
        document.getElementById('uploadResult').textContent = 'Failed: ' + (err && err.message ? err.message : err);
      }
    });

    function readAsBase64_(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> {
          const s = String(fr.result || '');
          resolve(s.includes(',') ? s.substring(s.indexOf(',')+1) : s);
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // First load
    refresh();
  })();
  </script>
</body>
</html>
