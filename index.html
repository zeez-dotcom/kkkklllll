<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap: 12px; --radius: 10px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #f6f7fb; color: #1c1c1c; }
    header { background: #1f2937; color: white; padding: 14px 18px; }
    header h1 { margin: 0; font-size: 18px; }
    .container { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .card { background: white; border-radius: var(--radius); padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .grid { display: grid; gap: var(--gap); }
    .grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .stat { padding: 16px; border-radius: var(--radius); text-align: center; }
    .stat h2 { margin: 6px 0 0; font-size: 28px; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .tabs { display: flex; gap: 6px; }
    .tab { padding: 10px 12px; border-radius: 8px; background: #e5e7eb; cursor: pointer; user-select: none; }
    .tab.active { background: #111827; color: white; }
    .language-toggle { display: flex; align-items: center; gap: 6px; }
    .language-toggle label { font-size: 14px; color: #4b5563; }
    .language-toggle select { width: auto; min-width: 120px; }
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; }
    .grow { flex: 1; min-width: 240px; }
    input, textarea, select, button { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font: inherit; background: white; }
    button { cursor: pointer; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: start; vertical-align: top; }
    tr:hover { background: #fafafa; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; }
    .status-Expired { background: #fee2e2; color: #991b1b; }
    .status-Upcoming { background: #fef3c7; color: #92400e; }
    .status-Active { background: #dcfce7; color: #166534; }
    .muted { color: #6b7280; font-size: 12px; }
    .link { color: #2563eb; text-decoration: none; }
    .link:hover { text-decoration: underline; }
    .hidden { display: none; }
    .preview { width: 100%; height: 70vh; border: 0; border-radius: 10px; background: #fafafa; }
    .loading { opacity: .7; pointer-events: none; }
  </style>
</head>
<body>
  <header><h1 id="headerTitle"></h1></header>
  <div class="container">

    <div class="toolbar">
      <div class="tabs" role="tablist" aria-label="" id="tablist">
        <button type="button" class="tab active" data-tab="dashboard" role="tab" aria-selected="true" id="tabDashboard"></button>
        <button type="button" class="tab" data-tab="upload" role="tab" aria-selected="false" id="tabUpload"></button>
      </div>
      <div class="language-toggle">
        <label for="languageSelect" id="languageLabel"></label>
        <select id="languageSelect" aria-label="">
          <option value="en"></option>
          <option value="ar"></option>
        </select>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="grid" style="gap:16px;">
      <div class="grid cols-3">
        <div class="card stat">
          <div class="muted" id="statLabelExpired"></div>
          <h2 id="stat-expired">0</h2>
        </div>
        <div class="card stat">
          <div class="muted" id="statLabelUpcoming"></div>
          <h2 id="stat-upcoming">0</h2>
        </div>
        <div class="card stat">
          <div class="muted" id="statLabelActive"></div>
          <h2 id="stat-active">0</h2>
        </div>
      </div>

      <div class="card">
        <div class="row" style="align-items:center; margin-bottom:10px;">
          <input id="search" class="grow" placeholder="" aria-label="" />
          <button type="button" id="btnRefresh" style="max-width:160px;" aria-busy="false"></button>
        </div>
        <div class="muted" id="result-count" role="status" aria-live="polite"></div>
        <div style="overflow:auto;">
          <table id="table" aria-label="">
            <thead>
              <tr>
                <th id="thId"></th><th id="thName"></th><th id="thDescription"></th>
                <th id="thExpiry1"></th><th id="thExpiry2"></th>
                <th id="thStatus"></th><th id="thFile"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="preview-card" class="card hidden" aria-live="polite">
        <div class="row" style="align-items:center;">
          <div class="grow"><strong id="preview-title"></strong></div>
          <button type="button" id="btnClosePreview" style="max-width:120px;"></button>
        </div>
        <div id="preview-body">
          <iframe id="preview-frame" class="preview" title=""></iframe>
        </div>
      </div>
    </section>

    <!-- UPLOAD -->
    <section id="upload" class="hidden">
      <div class="card">
        <form id="uploadForm">
          <div class="row">
            <div class="grow">
              <label for="uploadName" id="labelName"></label>
              <input id="uploadName" name="name" required maxlength="200" />
            </div>
            <div class="grow">
              <label for="uploadDescription" id="labelDescription"></label>
              <input id="uploadDescription" name="description" maxlength="500" />
            </div>
          </div>
          <div class="row">
            <div class="grow">
              <label for="uploadNameAr" id="labelNameAr"></label>
              <input id="uploadNameAr" name="nameAr" lang="ar" dir="rtl" maxlength="200" />
            </div>
            <div class="grow">
              <label for="uploadDescriptionAr" id="labelDescriptionAr"></label>
              <input id="uploadDescriptionAr" name="descriptionAr" lang="ar" dir="rtl" maxlength="500" />
            </div>
          </div>
          <div class="row">
            <div class="grow">
              <label for="uploadExp1Label" id="labelExp1"></label>
              <input id="uploadExp1Label" name="exp1Label" placeholder="" maxlength="200" />
            </div>
            <div class="grow">
              <label for="uploadExp1Date" id="labelExp1Date"></label>
              <input id="uploadExp1Date" type="date" name="exp1Date" />
            </div>
          </div>
          <div class="row">
            <div class="grow">
              <label for="uploadExp2Label" id="labelExp2"></label>
              <input id="uploadExp2Label" name="exp2Label" placeholder="" maxlength="200" />
            </div>
            <div class="grow">
              <label for="uploadExp2Date" id="labelExp2Date"></label>
              <input id="uploadExp2Date" type="date" name="exp2Date" />
            </div>
          </div>
          <div class="row">
            <div class="grow">
              <label for="uploadExp1LabelAr" id="labelExp1Ar"></label>
              <input id="uploadExp1LabelAr" name="exp1LabelAr" placeholder="" lang="ar" dir="rtl" maxlength="200" />
            </div>
            <div class="grow">
              <label for="uploadExp2LabelAr" id="labelExp2Ar"></label>
              <input id="uploadExp2LabelAr" name="exp2LabelAr" placeholder="" lang="ar" dir="rtl" maxlength="200" />
            </div>
          </div>
          <div class="row" style="align-items:flex-end;">
            <div class="grow">
              <label for="uploadFile" id="labelDocument"></label>
              <input id="uploadFile" type="file" name="file" accept="image/*,application/pdf" />
              <div class="muted" id="documentHelp"></div>
            </div>
            <div style="min-width:160px;">
              <button type="submit" id="btnUpload" aria-busy="false"></button>
            </div>
          </div>
        </form>
        <div id="uploadResult" class="muted" style="margin-top:10px;" role="status" aria-live="polite"></div>
      </div>
    </section>

  </div>

  <script>
  (function(){
    const LANG_STORAGE_KEY = 'adminOfficeLicenses.lang';
    const translations = {
      en: {
        languageLabel: 'Language',
        languages: { en: 'English', ar: 'Arabic' },
        pageTitle: 'Admin Office Licenses',
        headerTitle: 'Admin Office Licenses',
        tablistLabel: 'Sections',
        tableAria: 'Licenses table',
        tabs: { dashboard: 'Dashboard', upload: 'Upload' },
        stats: { expired: 'Expired', upcoming: 'Upcoming (≤ 30 days)', active: 'Active' },
        searchPlaceholder: 'Search by name, description, labels…',
        searchAria: 'Search',
        refresh: 'Refresh',
        results: {
          countSingular: '{count} result',
          countPlural: '{count} result(s)',
          filteredSingular: '{count} result of {total} total',
          filteredPlural: '{count} result(s) of {total} total',
          failed: 'Failed to load data.',
          unable: 'Unable to load data.'
        },
        tableHeaders: {
          id: 'ID',
          name: 'Name',
          description: 'Description',
          exp1: 'Expiry 1',
          exp2: 'Expiry 2',
          status: 'Status',
          file: 'File'
        },
        preview: {
          title: 'Preview',
          defaultTitle: 'Preview',
          close: 'Close',
          iframeTitle: 'File preview'
        },
        noRecords: 'No matching records.',
        fileLinks: { open: 'Open', preview: 'Preview', none: '—' },
        uploadForm: {
          nameLabel: 'Name',
          nameLabelAr: 'Name (Arabic)',
          namePlaceholderAr: 'Optional Arabic name',
          descriptionLabel: 'Description',
          descriptionLabelAr: 'Description (Arabic)',
          descriptionPlaceholderAr: 'Optional Arabic description',
          exp1Label: 'Expiry 1 Label',
          exp1Placeholder: 'e.g., License Expiry',
          exp1LabelAr: 'Expiry 1 Label (Arabic)',
          exp1PlaceholderAr: 'Arabic label (optional)',
          exp1Date: 'Expiry 1 Date',
          exp2Label: 'Expiry 2 Label',
          exp2Placeholder: 'e.g., Insurance Expiry',
          exp2LabelAr: 'Expiry 2 Label (Arabic)',
          exp2PlaceholderAr: 'Arabic label (optional)',
          exp2Date: 'Expiry 2 Date',
          documentLabel: 'Document (Image or PDF)',
          documentHelp: 'Optional. Files up to ~5MB recommended.',
          submit: 'Save'
        },
        uploadStatus: {
          uploading: 'Uploading…',
          saved: 'Saved. ID: {id}',
          link: 'Open file',
          errorWithMessage: 'Error: {message}',
          generic: 'Error saving record.',
          failedWithMessage: 'Failed: {message}'
        },
        errors: {
          loadFail: 'Failed to load: {message}',
          runtimeUnavailable: 'Google Apps Script runtime is unavailable.'
        },
        status: {
          expired: 'Expired',
          active: 'Active',
          upcomingPrefix: 'Upcoming',
          upcomingExact: 'Upcoming (≤ 30 days)'
        }
      },
      ar: {
        languageLabel: 'اللغة',
        languages: { en: 'الإنجليزية', ar: 'العربية' },
        pageTitle: 'تراخيص مكتب الإدارة',
        headerTitle: 'تراخيص مكتب الإدارة',
        tablistLabel: 'الأقسام',
        tableAria: 'جدول التراخيص',
        tabs: { dashboard: 'لوحة المعلومات', upload: 'رفع' },
        stats: { expired: 'منتهي', upcoming: 'قادم (≤ 30 يوم)', active: 'ساري' },
        searchPlaceholder: 'ابحث بالاسم أو الوصف أو التصنيفات…',
        searchAria: 'بحث',
        refresh: 'تحديث',
        results: {
          countSingular: '{count} نتيجة',
          countPlural: '{count} نتيجة',
          filteredSingular: '{count} نتيجة من إجمالي {total}',
          filteredPlural: '{count} نتيجة من إجمالي {total}',
          failed: 'فشل تحميل البيانات.',
          unable: 'تعذر تحميل البيانات.'
        },
        tableHeaders: {
          id: 'المعرف',
          name: 'الاسم',
          description: 'الوصف',
          exp1: 'الانتهاء 1',
          exp2: 'الانتهاء 2',
          status: 'الحالة',
          file: 'الملف'
        },
        preview: {
          title: 'معاينة',
          defaultTitle: 'معاينة',
          close: 'إغلاق',
          iframeTitle: 'معاينة الملف'
        },
        noRecords: 'لا توجد سجلات مطابقة.',
        fileLinks: { open: 'فتح', preview: 'معاينة', none: '—' },
        uploadForm: {
          nameLabel: 'الاسم',
          nameLabelAr: 'الاسم (بالعربية)',
          namePlaceholderAr: 'اسم عربي اختياري',
          descriptionLabel: 'الوصف',
          descriptionLabelAr: 'الوصف (بالعربية)',
          descriptionPlaceholderAr: 'وصف عربي اختياري',
          exp1Label: 'تسمية الانتهاء 1',
          exp1Placeholder: 'مثال: انتهاء الترخيص',
          exp1LabelAr: 'تسمية الانتهاء 1 (بالعربية)',
          exp1PlaceholderAr: 'تسمية عربية اختيارية',
          exp1Date: 'تاريخ الانتهاء 1',
          exp2Label: 'تسمية الانتهاء 2',
          exp2Placeholder: 'مثال: انتهاء التأمين',
          exp2LabelAr: 'تسمية الانتهاء 2 (بالعربية)',
          exp2PlaceholderAr: 'تسمية عربية اختيارية',
          exp2Date: 'تاريخ الانتهاء 2',
          documentLabel: 'المستند (صورة أو PDF)',
          documentHelp: 'اختياري. يفضل ملفات حتى 5 ميجابايت تقريبًا.',
          submit: 'حفظ'
        },
        uploadStatus: {
          uploading: 'جارٍ الرفع…',
          saved: 'تم الحفظ. المعرّف: {id}',
          link: 'فتح الملف',
          errorWithMessage: 'خطأ: {message}',
          generic: 'حدث خطأ أثناء حفظ السجل.',
          failedWithMessage: 'فشل: {message}'
        },
        errors: {
          loadFail: 'فشل التحميل: {message}',
          runtimeUnavailable: 'بيئة Google Apps Script غير متاحة.'
        },
        status: {
          expired: 'منتهي',
          active: 'ساري',
          upcomingPrefix: 'قادم',
          upcomingExact: 'قادم (≤ 30 يوم)'
        }
      }
    };

    const languageSelect = document.getElementById('languageSelect');
    const headerTitle = document.getElementById('headerTitle');
    const tabDashboard = document.getElementById('tabDashboard');
    const tabUpload = document.getElementById('tabUpload');
    const tablist = document.getElementById('tablist');
    const statLabelExpired = document.getElementById('statLabelExpired');
    const statLabelUpcoming = document.getElementById('statLabelUpcoming');
    const statLabelActive = document.getElementById('statLabelActive');
    const searchEl = document.getElementById('search');
    const btnRefresh = document.getElementById('btnRefresh');
    const resultCountEl = document.getElementById('result-count');
    const table = document.getElementById('table');
    const previewCard = document.getElementById('preview-card');
    const previewTitle = document.getElementById('preview-title');
    const previewFrame = document.getElementById('preview-frame');
    const btnClosePreview = document.getElementById('btnClosePreview');
    const labelName = document.getElementById('labelName');
    const labelDescription = document.getElementById('labelDescription');
    const labelNameAr = document.getElementById('labelNameAr');
    const labelDescriptionAr = document.getElementById('labelDescriptionAr');
    const labelExp1 = document.getElementById('labelExp1');
    const labelExp1Date = document.getElementById('labelExp1Date');
    const labelExp2 = document.getElementById('labelExp2');
    const labelExp2Date = document.getElementById('labelExp2Date');
    const labelExp1Ar = document.getElementById('labelExp1Ar');
    const labelExp2Ar = document.getElementById('labelExp2Ar');
    const labelDocument = document.getElementById('labelDocument');
    const documentHelp = document.getElementById('documentHelp');
    const btnUpload = document.getElementById('btnUpload');
    const uploadResult = document.getElementById('uploadResult');
    const languageLabel = document.getElementById('languageLabel');
    const uploadForm = document.getElementById('uploadForm');

    const inputName = document.getElementById('uploadName');
    const inputDescription = document.getElementById('uploadDescription');
    const inputNameAr = document.getElementById('uploadNameAr');
    const inputDescriptionAr = document.getElementById('uploadDescriptionAr');
    const exp1LabelInputEn = document.getElementById('uploadExp1Label');
    const exp1LabelInputAr = document.getElementById('uploadExp1LabelAr');
    const exp2LabelInputEn = document.getElementById('uploadExp2Label');
    const exp2LabelInputAr = document.getElementById('uploadExp2LabelAr');

    let currentLang = localStorage.getItem(LANG_STORAGE_KEY) || 'en';
    if (!translations[currentLang]) currentLang = 'en';
    languageSelect.value = currentLang;

    const state = {
      rows: [],
      countsAll: { expired: 0, upcoming: 0, active: 0, total: 0 },
      countsFiltered: { total: 0 }
    };
    let hasLoaded = false;
    let lastUploadState = { type: 'idle', payload: null };
    let resultState = { type: 'count' };

    function t(path) {
      const langTable = translations[currentLang] || translations.en;
      const parts = path.split('.');
      let node = langTable;
      for (const part of parts) {
        if (node && Object.prototype.hasOwnProperty.call(node, part)) {
          node = node[part];
        } else {
          return path;
        }
      }
      return typeof node === 'string' ? node : path;
    }

    function format(str, params = {}) {
      return String(str).replace(/\{(\w+)\}/g, (_, key) => (
        params[key] != null ? params[key] : ''
      ));
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function escapeAttr(s) {
      return String(s ?? '')
        .replace(/&/g,'&amp;').replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;').replace(/</g,'&lt;');
    }
    function safeHref(url) {
      const value = String(url || '').trim();
      return /^https?:\/\//i.test(value) ? value : '';
    }

    function trimUploadTextFields() {
      [
        inputName,
        inputDescription,
        inputNameAr,
        inputDescriptionAr,
        exp1LabelInputEn,
        exp1LabelInputAr,
        exp2LabelInputEn,
        exp2LabelInputAr
      ].forEach(input => {
        if (!input) return;
        if (typeof input.value === 'string') {
          input.value = input.value.trim();
        }
      });
    }

    function applyTranslations() {
      const langTable = translations[currentLang] || translations.en;
      document.documentElement.lang = currentLang;
      document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
      document.title = langTable.pageTitle;
      headerTitle.textContent = langTable.headerTitle;
      tabDashboard.textContent = langTable.tabs.dashboard;
      tabUpload.textContent = langTable.tabs.upload;
      tablist.setAttribute('aria-label', langTable.tablistLabel);
      statLabelExpired.textContent = langTable.stats.expired;
      statLabelUpcoming.textContent = langTable.stats.upcoming;
      statLabelActive.textContent = langTable.stats.active;
      searchEl.placeholder = langTable.searchPlaceholder;
      searchEl.setAttribute('aria-label', langTable.searchAria);
      btnRefresh.textContent = langTable.refresh;
      renderResultState();
      table.setAttribute('aria-label', langTable.tableAria);
      document.getElementById('thId').textContent = langTable.tableHeaders.id;
      document.getElementById('thName').textContent = langTable.tableHeaders.name;
      document.getElementById('thDescription').textContent = langTable.tableHeaders.description;
      document.getElementById('thExpiry1').textContent = langTable.tableHeaders.exp1;
      document.getElementById('thExpiry2').textContent = langTable.tableHeaders.exp2;
      document.getElementById('thStatus').textContent = langTable.tableHeaders.status;
      document.getElementById('thFile').textContent = langTable.tableHeaders.file;
      previewTitle.textContent = previewCard.classList.contains('hidden') ? langTable.preview.title : previewTitle.textContent;
      previewFrame.title = langTable.preview.iframeTitle;
      btnClosePreview.textContent = langTable.preview.close;
      labelName.textContent = langTable.uploadForm.nameLabel;
      labelDescription.textContent = langTable.uploadForm.descriptionLabel;
      if (labelNameAr) labelNameAr.textContent = langTable.uploadForm.nameLabelAr;
      if (labelDescriptionAr) labelDescriptionAr.textContent = langTable.uploadForm.descriptionLabelAr;
      labelExp1.textContent = langTable.uploadForm.exp1Label;
      labelExp1Date.textContent = langTable.uploadForm.exp1Date;
      labelExp2.textContent = langTable.uploadForm.exp2Label;
      labelExp2Date.textContent = langTable.uploadForm.exp2Date;
      if (labelExp1Ar) labelExp1Ar.textContent = langTable.uploadForm.exp1LabelAr;
      if (labelExp2Ar) labelExp2Ar.textContent = langTable.uploadForm.exp2LabelAr;
      labelDocument.textContent = langTable.uploadForm.documentLabel;
      documentHelp.textContent = langTable.uploadForm.documentHelp;
      btnUpload.textContent = langTable.uploadForm.submit;
      exp1LabelInputEn.placeholder = langTable.uploadForm.exp1Placeholder;
      exp2LabelInputEn.placeholder = langTable.uploadForm.exp2Placeholder;
      if (inputNameAr) inputNameAr.placeholder = langTable.uploadForm.namePlaceholderAr;
      if (inputDescriptionAr) inputDescriptionAr.placeholder = langTable.uploadForm.descriptionPlaceholderAr;
      if (exp1LabelInputAr) exp1LabelInputAr.placeholder = langTable.uploadForm.exp1PlaceholderAr;
      if (exp2LabelInputAr) exp2LabelInputAr.placeholder = langTable.uploadForm.exp2PlaceholderAr;
      languageLabel.textContent = langTable.languageLabel;
      languageSelect.setAttribute('aria-label', langTable.languageLabel);
      Object.entries(langTable.languages).forEach(([value, label]) => {
        const option = languageSelect.querySelector(`option[value="${value}"]`);
        if (option) option.textContent = label;
      });
      renderUploadStatus();
      renderTable(state.rows);
      updateStatsDisplay();
      renderResultState();
    }

    function formatCountLabel() {
      const filtered = Number(state.countsFiltered && state.countsFiltered.total != null ? state.countsFiltered.total : state.rows.length);
      const total = Number(state.countsAll && state.countsAll.total != null ? state.countsAll.total : filtered);
      const same = filtered === total;
      const key = same
        ? (filtered === 1 ? 'results.countSingular' : 'results.countPlural')
        : (filtered === 1 ? 'results.filteredSingular' : 'results.filteredPlural');
      return format(t(key), { count: filtered, total });
    }

    function renderResultState() {
      if (resultState.type === 'failed') {
        resultCountEl.textContent = t('results.failed');
      } else if (resultState.type === 'unable') {
        resultCountEl.textContent = t('results.unable');
      } else {
        resultCountEl.textContent = formatCountLabel();
      }
    }

    function setResultState(type) {
      resultState = { type };
      renderResultState();
    }

    function updateStatsDisplay() {
      document.getElementById('stat-expired').textContent = Number(state.countsAll.expired || 0);
      document.getElementById('stat-upcoming').textContent = Number(state.countsAll.upcoming || 0);
      document.getElementById('stat-active').textContent = Number(state.countsAll.active || 0);
    }

    function setUploadStatus(type, payload) {
      lastUploadState = { type, payload };
      renderUploadStatus();
    }

    function renderUploadStatus() {
      switch (lastUploadState.type) {
        case 'uploading':
          uploadResult.textContent = t('uploadStatus.uploading');
          break;
        case 'saved': {
          const payload = lastUploadState.payload || {};
          const openUrl = safeHref(payload.fileUrl);
          const savedText = format(t('uploadStatus.saved'), { id: payload.id != null ? payload.id : '' });
          const linkHtml = openUrl
            ? ` · <a class="link" target="_blank" rel="noopener" href="${escapeAttr(openUrl)}">${escapeHtml(t('uploadStatus.link'))}</a>`
            : '';
          uploadResult.innerHTML = `${escapeHtml(savedText)}${linkHtml}`;
          break;
        }
        case 'error': {
          const messageRaw = lastUploadState.payload && lastUploadState.payload.message;
          const message = messageRaw != null ? String(messageRaw) : '';
          if (message) {
            uploadResult.textContent = format(t('uploadStatus.errorWithMessage'), { message });
          } else {
            uploadResult.textContent = t('uploadStatus.generic');
          }
          break;
        }
        case 'failed': {
          const messageRaw = lastUploadState.payload && lastUploadState.payload.message;
          const message = messageRaw != null ? String(messageRaw) : '';
          uploadResult.textContent = format(t('uploadStatus.failedWithMessage'), { message });
          break;
        }
        default:
          uploadResult.textContent = '';
      }
    }

    function setLoading(el, isLoading){
      if (!el) return;
      const loading = !!isLoading;
      el.classList.toggle('loading', loading);
      if ('disabled' in el) el.disabled = loading;
      el.setAttribute('aria-busy', loading ? 'true' : 'false');
    }

    function statusPill(status) {
      const base = 'pill status-';
      const raw = String(status || '');
      if (raw === 'Upcoming (≤ 30 days)') {
        return `<span class="${base}Upcoming">${escapeHtml(t('status.upcomingExact'))}</span>`;
      }
      if (raw.startsWith('Upcoming')) {
        const suffix = raw.substring('Upcoming'.length);
        const text = `${t('status.upcomingPrefix')}${suffix}`;
        return `<span class="${base}Upcoming">${escapeHtml(text.trim())}</span>`;
      }
      if (raw === 'Expired') {
        return `<span class="${base}Expired">${escapeHtml(t('status.expired'))}</span>`;
      }
      return `<span class="${base}Active">${escapeHtml(t('status.active'))}</span>`;
    }

    function getLocalizedField(row, key) {
      if (!row) return '';
      if (currentLang === 'ar') {
        const localizedKey = `${key}Ar`;
        if (row[localizedKey]) {
          return row[localizedKey];
        }
      }
      return row[key] || '';
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#table tbody');
      if (!hasLoaded && (!rows || !rows.length)) {
        tbody.innerHTML = '';
        return;
      }
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="muted">${escapeHtml(t('noRecords'))}</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const displayName = getLocalizedField(r, 'name');
        const displayDescription = getLocalizedField(r, 'description');
        const exp1Label = getLocalizedField(r, 'exp1Label');
        const exp2Label = getLocalizedField(r, 'exp2Label');
        const exp1 = `${escapeHtml(exp1Label)}${r.exp1Date ? ' ('+escapeHtml(r.exp1Date)+')' : ''}`;
        const exp2 = `${escapeHtml(exp2Label)}${r.exp2Date ? ' ('+escapeHtml(r.exp2Date)+')' : ''}`;
        const fileUrl = safeHref(r.fileUrl);
        const previewUrl = safeHref(r.filePreviewUrl);
        const previewTitleText = r.fileName || displayName || t('preview.defaultTitle');
        const previewLink = previewUrl
          ? ` · <a class="link link-preview" role="button" href="#" data-preview-url="${escapeAttr(previewUrl)}" data-preview-title="${escapeAttr(previewTitleText)}">${escapeHtml(t('fileLinks.preview'))}</a>`
          : '';
        const fileCell = fileUrl
          ? `<a class="link" href="${escapeAttr(fileUrl)}" target="_blank" rel="noopener">${escapeHtml(t('fileLinks.open'))}</a>${previewLink}`
          : `<span class="muted">${escapeHtml(t('fileLinks.none'))}</span>`;
        return `
          <tr>
            <td>${escapeHtml(r.id)}</td>
            <td>${escapeHtml(displayName)}</td>
            <td>${escapeHtml(displayDescription)}</td>
            <td>${exp1}</td>
            <td>${exp2}</td>
            <td>${statusPill(r.status)}</td>
            <td>${fileCell}</td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('.link-preview').forEach(link => {
        link.addEventListener('click', evt => {
          evt.preventDefault();
          preview(link.getAttribute('data-preview-url'), link.getAttribute('data-preview-title'));
        });
      });
    }

    function updateCounts(data) {
      const countsAll = data || {};
      state.countsAll.expired = Number(countsAll.expired || 0);
      state.countsAll.upcoming = Number(countsAll.upcoming || 0);
      state.countsAll.active = Number(countsAll.active || 0);
      if (countsAll.total != null) {
        state.countsAll.total = Number(countsAll.total);
      } else {
        state.countsAll.total = state.countsAll.expired + state.countsAll.upcoming + state.countsAll.active;
      }
      updateStatsDisplay();
    }

    function updateFilteredCounts(countsFiltered) {
      if (countsFiltered && countsFiltered.total != null) {
        state.countsFiltered.total = Number(countsFiltered.total);
      } else {
        state.countsFiltered.total = state.rows.length;
      }
      if (resultState.type === 'count') {
        renderResultState();
      }
    }

    function preview(url, title){
      const safeUrl = safeHref(url);
      if (!safeUrl) return;
      previewTitle.textContent = title || t('preview.defaultTitle');
      previewFrame.src = safeUrl;
      previewCard.classList.remove('hidden');
      if (typeof previewFrame.focus === 'function') {
        previewFrame.focus();
      }
    }
    window.preview = preview;
    btnClosePreview.addEventListener('click', ()=>{
      previewCard.classList.add('hidden');
      previewFrame.src = '';
      previewTitle.textContent = t('preview.title');
    });

    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>{
          x.classList.remove('active'); x.setAttribute('aria-selected','false');
        });
        t.classList.add('active'); t.setAttribute('aria-selected','true');
        const tab = t.dataset.tab;
        document.getElementById('dashboard').classList.toggle('hidden', tab!=='dashboard');
        document.getElementById('upload').classList.toggle('hidden', tab!=='upload');
      });
    });

    languageSelect.addEventListener('change', ()=>{
      const value = languageSelect.value;
      currentLang = translations[value] ? value : 'en';
      localStorage.setItem(LANG_STORAGE_KEY, currentLang);
      applyTranslations();
    });

    searchEl.addEventListener('input', debounce(refresh, 250));
    btnRefresh.addEventListener('click', refresh);

    function debounce(fn, ms){ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a), ms); }; }

    function refresh() {
      const q = searchEl.value || '';
      setLoading(btnRefresh, true);
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error(t('errors.runtimeUnavailable'));
        }
        google.script.run.withSuccessHandler(({rows, countsAll, countsFiltered})=>{
          state.rows = Array.isArray(rows) ? rows : [];
          updateCounts(countsAll);
          updateFilteredCounts(countsFiltered);
          hasLoaded = true;
          renderTable(state.rows);
          setResultState('count');
          setLoading(btnRefresh, false);
        }).withFailureHandler(err=>{
          setLoading(btnRefresh, false);
          const message = err && err.message ? err.message : err;
          alert(format(t('errors.loadFail'), { message: String(message || '') }));
          setResultState('failed');
        }).getDashboardData(q);
      } catch(e) {
        console.error(e);
        setLoading(btnRefresh, false);
        setResultState('unable');
      }
    }

    uploadForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      trimUploadTextFields();
      if (!uploadForm.reportValidity()) {
        return;
      }
      setUploadStatus('uploading');
      setLoading(btnUpload, true);

      try {
        const fd = new FormData(uploadForm);
        const obj = {};
        fd.forEach((v,k)=>{
          if (k === 'file') return;
          if (typeof v === 'string') {
            obj[k] = v.trim();
          } else {
            obj[k] = v;
          }
        });

        const fileInput = uploadForm.file;
        if (fileInput && fileInput.files && fileInput.files.length) {
          const file = fileInput.files[0];
          obj.fileName = file.name;
          obj.fileType = file.type || 'application/octet-stream';
          obj.fileB64 = await readAsBase64_(file);
        }

        google.script.run.withSuccessHandler(res=>{
          setLoading(btnUpload, false);
          if (res && res.ok) {
            const openUrl = res.fileUrl ? safeHref(res.fileUrl) : '';
            setUploadStatus('saved', { id: res.id, fileUrl: openUrl });
            uploadForm.reset();
            refresh();
          } else {
            const message = res && res.error ? res.error : '';
            setUploadStatus('error', { message: String(message || '') });
          }
        }).withFailureHandler(err=>{
          setLoading(btnUpload, false);
          const message = err && err.message ? err.message : err;
          setUploadStatus('failed', { message: String(message || '') });
        }).uploadDocument(obj);
      } catch (err) {
        setLoading(btnUpload, false);
        const message = err && err.message ? err.message : err;
        setUploadStatus('failed', { message: String(message || '') });
      }
    });

    function readAsBase64_(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> {
          const s = String(fr.result || '');
          resolve(s.includes(',') ? s.substring(s.indexOf(',')+1) : s);
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    applyTranslations();
    updateStatsDisplay();
    renderResultState();
    renderTable(state.rows);
    refresh();
  })();
  </script>
</body>
</html>
