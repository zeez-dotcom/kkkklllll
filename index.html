<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light;
      --bg: #f1f5f9;
      --surface: #ffffff;
      --surface-muted: rgba(255, 255, 255, 0.75);
      --shadow: 0 24px 60px rgba(15, 23, 42, 0.08);
      --border: #e2e8f0;
      --primary: #2563eb;
      --primary-strong: #1d4ed8;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.16);
      --success: #16a34a;
      --warning: #f97316;
      --danger: #dc2626;
      --text: #0f172a;
      --muted: #64748b;
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 10px;
      --transition: 150ms ease;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    a { color: inherit; }

    .app-header {
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.7), rgba(37, 99, 235, 0.95));
      color: #ffffff;
      padding: 32px 16px 88px;
    }

    .app-header::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(249, 115, 22, 0.35), transparent 55%);
      pointer-events: none;
    }

    .header-inner {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0;
    }

    .header-title h1 {
      margin: 0;
      font-size: inherit;
      font-weight: inherit;
    }

    .header-icon {
      display: grid;
      place-items: center;
      width: 56px;
      height: 56px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(15, 23, 42, 0.08));
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.25);
    }

    .header-icon svg {
      width: 28px;
      height: 28px;
      fill: currentColor;
      opacity: 0.9;
    }

    .language-toggle {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: rgba(15, 23, 42, 0.25);
      padding: 10px 14px;
      border-radius: 999px;
      backdrop-filter: blur(12px);
    }

    .language-toggle label {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .language-toggle select {
      appearance: none;
      min-width: 150px;
      padding: 8px 32px 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      background: rgba(15, 23, 42, 0.4) url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="white"%3E%3Cpath d="M6.293 7.293a1 1 0 011.414 0L10 9.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/%3E%3C/svg%3E') no-repeat right 12px center / 16px;
      color: #ffffff;
      font: inherit;
    }

    .language-toggle select:focus-visible {
      outline: 2px solid #ffffff;
      outline-offset: 2px;
    }

    .header-tabs {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 32px auto 0;
      display: flex;
      justify-content: flex-start;
    }

    .tabs {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px;
      background: rgba(15, 23, 42, 0.28);
      border-radius: 999px;
      backdrop-filter: blur(12px);
    }

    .tab {
      position: relative;
      cursor: pointer;
      user-select: none;
      border: 0;
      border-radius: 999px;
      padding: 10px 20px;
      background: transparent;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.95rem;
      font-weight: 500;
      transition: background var(--transition), color var(--transition), transform var(--transition);
    }

    .tab:hover {
      color: #ffffff;
      background: rgba(255, 255, 255, 0.12);
    }

    .tab.active {
      color: #1f2937;
      background: #ffffff;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
      transform: translateY(-1px);
    }

    .container {
      position: relative;
      max-width: 1200px;
      margin: -48px auto 48px;
      padding: 0 16px 48px;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 24px;
    }

    .stats-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      margin-bottom: 32px;
    }

    .stat-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 22px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.75), rgba(226, 232, 240, 0.6));
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    }

    .stat-icon {
      display: grid;
      place-items: center;
      width: 56px;
      height: 56px;
      border-radius: 18px;
      font-size: 1.5rem;
      color: #ffffff;
    }

    .stat-icon.expired { background: linear-gradient(135deg, rgba(220, 38, 38, 0.95), rgba(248, 113, 113, 0.9)); }
    .stat-icon.upcoming { background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(253, 230, 138, 0.9)); color: #7c2d12; }
    .stat-icon.active { background: linear-gradient(135deg, rgba(5, 150, 105, 0.95), rgba(16, 185, 129, 0.9)); }

    .stat-body { flex: 1; min-width: 0; }

    .stat-label {
      display: block;
      font-size: 0.95rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .stat-value {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .panel {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .panel-header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .search-group {
      position: relative;
      flex: 1;
      min-width: 240px;
    }

    .search-group input {
      width: 100%;
      padding: 14px 16px 14px 48px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      font: inherit;
      background: #ffffff;
      transition: border-color var(--transition), box-shadow var(--transition);
    }

    .search-group input:focus {
      outline: none;
      border-color: rgba(37, 99, 235, 0.7);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
    }

    .search-icon {
      position: absolute;
      inset-block: 0;
      inset-inline-start: 16px;
      display: grid;
      place-items: center;
      pointer-events: none;
      color: var(--muted);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: var(--radius-md);
      border: 0;
      cursor: pointer;
      font: inherit;
      font-weight: 600;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition), color var(--transition);
    }

    .btn svg { width: 18px; height: 18px; }

    .btn:focus-visible {
      outline: 3px solid rgba(37, 99, 235, 0.35);
      outline-offset: 2px;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.25);
    }

    .btn-primary:hover { background: var(--primary-strong); }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.05);
      color: var(--text);
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.12);
    }

    .btn-icon-only {
      padding: 10px;
      border-radius: 50%;
    }

    .btn-refresh::before,
    .btn-upload::before,
    .btn-close-preview::before {
      content: "";
      display: inline-block;
      width: 18px;
      height: 18px;
      margin-inline-end: 8px;
      background: currentColor;
    }

    .btn-refresh::before {
      mask: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"%3E%3Cpolyline points="1 4 1 10 7 10"/%3E%3Cpolyline points="23 20 23 14 17 14"/%3E%3Cpath d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/%3E%3C/svg%3E') no-repeat center / contain;
      -webkit-mask: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"%3E%3Cpolyline points="1 4 1 10 7 10"/%3E%3Cpolyline points="23 20 23 14 17 14"/%3E%3Cpath d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/%3E%3C/svg%3E') no-repeat center / contain;
    }

    .btn-upload::before {
      mask: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="black" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"%3E%3Cpath d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2"/%3E%3Cpolyline points="7 9 12 4 17 9"/%3E%3Cline x1="12" x2="12" y1="4" y2="16"/%3E%3C/svg%3E') no-repeat center / contain;
      -webkit-mask: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="black" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"%3E%3Cpath d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2"/%3E%3Cpolyline points="7 9 12 4 17 9"/%3E%3Cline x1="12" x2="12" y1="4" y2="16"/%3E%3C/svg%3E') no-repeat center / contain;
    }

    .btn-close-preview::before {
      mask: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="black" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"%3E%3Cline x1="6" y1="6" x2="18" y2="18"/%3E%3Cline x1="18" y1="6" x2="6" y2="18"/%3E%3C/svg%3E') no-repeat center / contain;
      -webkit-mask: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="black" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"%3E%3Cline x1="6" y1="6" x2="18" y2="18"/%3E%3Cline x1="18" y1="6" x2="6" y2="18"/%3E%3C/svg%3E') no-repeat center / contain;
    }

    .btn-close-preview {
      align-self: flex-start;
      color: var(--muted);
    }

    .btn-close-preview:hover {
      color: var(--text);
      background: rgba(15, 23, 42, 0.1);
    }

    .btn.loading::after {
      content: "";
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-top-color: rgba(255, 255, 255, 0.1);
      animation: spin 0.9s linear infinite;
      margin-inline-start: 10px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .muted { color: var(--muted); font-size: 0.9rem; }

    .link {
      color: var(--primary-strong);
      text-decoration: none;
      font-weight: 600;
    }

    .link:hover { text-decoration: underline; }

    .table-wrapper {
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 720px;
      background: #ffffff;
    }

    thead {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(37, 99, 235, 0.04));
      color: #1f2937;
    }

    th, td {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      text-align: start;
      vertical-align: top;
      font-size: 0.95rem;
    }

    tbody tr:hover { background: rgba(37, 99, 235, 0.04); }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .status-Expired { background: rgba(220, 38, 38, 0.1); color: #b91c1c; }
    .status-Upcoming { background: rgba(245, 158, 11, 0.15); color: #92400e; }
    .status-Active { background: rgba(5, 150, 105, 0.12); color: #047857; }

    .expiry-cell {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .doc-actions {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .doc-action-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 14px;
      font-size: 0.9rem;
      font-weight: 600;
      font: inherit;
      border: 1px solid transparent;
      background: rgba(37, 99, 235, 0.08);
      color: var(--primary-strong);
      text-decoration: none;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
    }

    .doc-action-button:focus-visible {
      outline: 3px solid rgba(37, 99, 235, 0.35);
      outline-offset: 2px;
    }

    .doc-action-button:hover {
      transform: translateY(-1px);
      background: rgba(37, 99, 235, 0.16);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.16);
    }

    .form-buttons {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
    }

    .record-actions {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
    }

    .record-action-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.04);
      color: var(--text);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), transform var(--transition), box-shadow var(--transition);
    }

    .record-action-button.edit {
      color: var(--primary-strong);
      border-color: rgba(37, 99, 235, 0.32);
      background: rgba(37, 99, 235, 0.08);
    }

    .record-action-button.renew {
      color: var(--accent);
      border-color: rgba(249, 115, 22, 0.35);
      background: var(--accent-soft);
    }

    .record-action-button.history {
      color: var(--muted);
      border-color: rgba(148, 163, 184, 0.4);
      background: rgba(148, 163, 184, 0.12);
    }

    .record-action-button:hover {
      transform: translateY(-1px);
      background: rgba(37, 99, 235, 0.1);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.15);
    }

    .record-action-button.renew:hover {
      background: rgba(249, 115, 22, 0.22);
      box-shadow: 0 10px 22px rgba(249, 115, 22, 0.22);
    }

    .record-action-button.history:hover {
      background: rgba(148, 163, 184, 0.2);
      box-shadow: 0 10px 22px rgba(148, 163, 184, 0.2);
    }

    .record-action-button[disabled],
    .record-action-button[disabled]:hover {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .record-action-button:focus-visible {
      outline: 3px solid rgba(37, 99, 235, 0.3);
      outline-offset: 2px;
    }

    .history-panel {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: min(420px, calc(100% - 32px));
      max-height: calc(100vh - 120px);
      z-index: 30;
    }

    .history-panel-inner {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-height: inherit;
    }

    .history-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .history-panel-titles {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .history-panel-title {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .btn-history-close {
      margin-left: auto;
    }

    .history-status {
      min-height: 20px;
    }

    .history-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
    }

    .history-entry {
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      background: var(--surface-muted);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-entry-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
    }

    .history-entry-body {
      display: grid;
      gap: 6px;
      font-size: 0.9rem;
    }

    .history-entry-body span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .history-entry a {
      color: var(--primary-strong);
      font-weight: 600;
      text-decoration: none;
    }

    .history-entry a:hover {
      text-decoration: underline;
    }

    .doc-action-button svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .doc-action-button.preview {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .doc-action-button.preview:hover {
      background: rgba(249, 115, 22, 0.28);
      box-shadow: 0 10px 22px rgba(249, 115, 22, 0.2);
    }

    .doc-action-empty { display: inline-block; }

    .upload-card {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    #uploadResult {
      padding-inline: 4px;
    }

    .upload-form {
      display: grid;
      gap: 20px;
    }

    .form-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-field label {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text);
    }

    .form-field input,
    .form-field textarea,
    .form-field select {
      width: 100%;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: #ffffff;
      font: inherit;
      transition: border-color var(--transition), box-shadow var(--transition);
    }

    .form-field input:focus,
    .form-field textarea:focus,
    .form-field select:focus {
      outline: none;
      border-color: rgba(37, 99, 235, 0.7);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12);
    }

    .form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
      justify-content: space-between;
    }

    .form-actions .form-field { flex: 1; }

    input[type="file"] {
      padding: 12px 16px;
      border: 1px dashed var(--border);
      cursor: pointer;
      background: linear-gradient(135deg, rgba(241, 245, 249, 0.9), rgba(226, 232, 240, 0.6));
    }

    input[type="file"]:focus { outline: none; border-color: rgba(37, 99, 235, 0.7); }

    .preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 40;
      backdrop-filter: blur(4px);
    }

    .preview-dialog {
      width: min(960px, 100%);
      max-height: 90vh;
      background: #ffffff;
      border-radius: var(--radius-lg);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .preview-title-group {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }

    .preview-title-group svg {
      width: 22px;
      height: 22px;
      color: var(--primary);
    }

    .preview-body { padding: 0 24px 24px; }

    .preview {
      width: 100%;
      height: 65vh;
      border: 0;
      border-radius: var(--radius-md);
      background: #f8fafc;
    }

    .hidden { display: none !important; }

    .loading { pointer-events: none; }

    @media (max-width: 720px) {
      .app-header { padding-bottom: 72px; }
      .container { margin-top: -36px; padding-inline: 12px; }
      .card { padding: 20px; }
      .panel-header { align-items: stretch; }
      .btn { width: 100%; }
      .form-actions { flex-direction: column; align-items: stretch; }
      .form-actions .btn { width: 100%; }
      .form-buttons { align-items: stretch; }
      .history-panel { left: 16px; right: 16px; bottom: 16px; width: auto; }
      .preview-body { padding-inline: 16px; padding-bottom: 16px; }
    }

    html[dir="rtl"] .header-inner { flex-direction: row-reverse; }
    html[dir="rtl"] .header-title { flex-direction: row-reverse; }
    html[dir="rtl"] .header-tabs { justify-content: flex-end; }
    html[dir="rtl"] .language-toggle { flex-direction: row-reverse; }
    html[dir="rtl"] .preview-header { flex-direction: row-reverse; }
    html[dir="rtl"] .preview-title-group { flex-direction: row-reverse; }
    html[dir="rtl"] .panel-header { flex-direction: column; align-items: stretch; }
    html[dir="rtl"] .search-group input { padding-inline-start: 16px; padding-inline-end: 48px; }
    html[dir="rtl"] .search-icon { inset-inline-start: auto; inset-inline-end: 16px; }
    html[dir="rtl"] .doc-actions { justify-content: flex-end; flex-direction: row-reverse; }
    html[dir="rtl"] .record-actions { justify-content: flex-end; flex-direction: row-reverse; }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-inner">
      <div class="header-title">
        <span class="header-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M5 4.75A2.75 2.75 0 017.75 2h6.19c.73 0 1.43.29 1.95.81l3.3 3.3c.52.52.81 1.22.81 1.95v11.19A2.75 2.75 0 0117.25 22h-9.5A2.75 2.75 0 015 19.25V4.75zm11.5-.69V6.5h2.44L16.5 4.06zM7.75 3.5A1.25 1.25 0 006.5 4.75v14.5c0 .69.56 1.25 1.25 1.25h9.5c.69 0 1.25-.56 1.25-1.25V8h-3.75A1.25 1.25 0 0013.5 6.75V3.5h-5.75z" />
          </svg>
        </span>
        <h1 id="headerTitle"></h1>
      </div>
      <div class="language-toggle">
        <label for="languageSelect" id="languageLabel"></label>
        <select id="languageSelect" aria-label="">
          <option value="en"></option>
          <option value="ar"></option>
        </select>
      </div>
    </div>
    <div class="header-tabs">
      <div class="tabs" role="tablist" aria-label="" id="tablist">
        <button type="button" class="tab active" data-tab="dashboard" role="tab" aria-selected="true" id="tabDashboard"></button>
        <button type="button" class="tab" data-tab="upload" role="tab" aria-selected="false" id="tabUpload"></button>
      </div>
    </div>
  </header>

  <main class="container" role="main">

    <!-- DASHBOARD -->
    <section id="dashboard">
      <div class="stats-grid">
        <article class="stat-card">
          <div class="stat-icon expired" aria-hidden="true">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2a9.94 9.94 0 00-7.07 2.93A10 10 0 1012 2zm0 18.5A8.5 8.5 0 1120.5 12 8.51 8.51 0 0112 20.5zm-.75-12.75a.75.75 0 011.5 0V12l2.22 2.22a.75.75 0 01-1.06 1.06l-2.47-2.47a.75.75 0 01-.19-.49z" />
            </svg>
          </div>
          <div class="stat-body">
            <span class="stat-label" id="statLabelExpired"></span>
            <p class="stat-value" id="stat-expired">0</p>
          </div>
        </article>
        <article class="stat-card">
          <div class="stat-icon upcoming" aria-hidden="true">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2a10 10 0 00-7.07 17.07A10 10 0 1012 2zm0 18.5A8.5 8.5 0 1120.5 12 8.51 8.51 0 0112 20.5zm-.75-12.25a.75.75 0 011.5 0v4.06l2.55 1.47a.75.75 0 11-.75 1.3l-3-1.73a.75.75 0 01-.37-.65z" />
            </svg>
          </div>
          <div class="stat-body">
            <span class="stat-label" id="statLabelUpcoming"></span>
            <p class="stat-value" id="stat-upcoming">0</p>
          </div>
        </article>
        <article class="stat-card">
          <div class="stat-icon active" aria-hidden="true">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2a10 10 0 1010 10A10 10 0 0012 2zm-1.12 13.42l-2.8-2.8a1 1 0 011.42-1.42l2.08 2.08 4.21-4.21a1 1 0 011.42 1.42l-4.92 4.93a1 1 0 01-1.42 0z" />
            </svg>
          </div>
          <div class="stat-body">
            <span class="stat-label" id="statLabelActive"></span>
            <p class="stat-value" id="stat-active">0</p>
          </div>
        </article>
      </div>

      <div class="card panel">
        <div class="panel-header">
          <div class="search-group">
            <span class="search-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M11 3.5a7.5 7.5 0 015.9 12.15l3.23 3.22a1 1 0 01-1.42 1.42l-3.22-3.23A7.5 7.5 0 1111 3.5zm0 13a5.5 5.5 0 10-5.5-5.5 5.5 5.5 0 005.5 5.5z" />
              </svg>
            </span>
            <input id="search" placeholder="" aria-label="" />
          </div>
          <button type="button" id="btnRefresh" class="btn btn-primary btn-refresh" aria-busy="false"></button>
        </div>
        <div class="muted" id="result-count" role="status" aria-live="polite"></div>
        <div class="table-wrapper">
          <table id="table" aria-label="">
            <thead>
              <tr>
                <th id="thId"></th>
                <th id="thName"></th>
                <th id="thDescription"></th>
                <th id="thExpiry1"></th>
                <th id="thExpiry2"></th>
                <th id="thStatus"></th>
                <th id="thFile"></th>
                <th id="thActions"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- UPLOAD -->
    <section id="upload" class="hidden">
      <div class="card upload-card">
        <form id="uploadForm" class="upload-form">
          <div class="form-grid">
            <div class="form-field">
              <label for="uploadName" id="labelName"></label>
              <input id="uploadName" name="name" required maxlength="200" />
            </div>
            <div class="form-field">
              <label for="uploadDescription" id="labelDescription"></label>
              <input id="uploadDescription" name="description" maxlength="500" />
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label for="uploadNameAr" id="labelNameAr"></label>
              <input id="uploadNameAr" name="nameAr" lang="ar" dir="rtl" maxlength="200" />
            </div>
            <div class="form-field">
              <label for="uploadDescriptionAr" id="labelDescriptionAr"></label>
              <input id="uploadDescriptionAr" name="descriptionAr" lang="ar" dir="rtl" maxlength="500" />
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label for="uploadExp1Label" id="labelExp1"></label>
              <input id="uploadExp1Label" name="exp1Label" placeholder="" maxlength="200" />
            </div>
            <div class="form-field">
              <label for="uploadExp1Date" id="labelExp1Date"></label>
              <input id="uploadExp1Date" type="date" name="exp1Date" />
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label for="uploadExp2Label" id="labelExp2"></label>
              <input id="uploadExp2Label" name="exp2Label" placeholder="" maxlength="200" />
            </div>
            <div class="form-field">
              <label for="uploadExp2Date" id="labelExp2Date"></label>
              <input id="uploadExp2Date" type="date" name="exp2Date" />
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label for="uploadExp1LabelAr" id="labelExp1Ar"></label>
              <input id="uploadExp1LabelAr" name="exp1LabelAr" placeholder="" lang="ar" dir="rtl" maxlength="200" />
            </div>
            <div class="form-field">
              <label for="uploadExp2LabelAr" id="labelExp2Ar"></label>
              <input id="uploadExp2LabelAr" name="exp2LabelAr" placeholder="" lang="ar" dir="rtl" maxlength="200" />
            </div>
          </div>
          <div class="form-actions">
            <div class="form-field">
              <label for="uploadFile" id="labelDocument"></label>
              <input id="uploadFile" type="file" name="file" accept="image/*,application/pdf" />
              <div class="muted" id="documentHelp"></div>
            </div>
            <div class="form-buttons">
              <button type="button" id="btnCancelEdit" class="btn btn-ghost hidden"></button>
              <button type="submit" id="btnUpload" class="btn btn-primary btn-upload" aria-busy="false"></button>
            </div>
          </div>
        </form>
        <div id="uploadResult" class="muted" role="status" aria-live="polite"></div>
      </div>
    </section>

  </main>

  <aside id="historyPanel" class="history-panel hidden" aria-hidden="true">
    <div class="history-panel-inner">
      <div class="history-panel-header">
        <div class="history-panel-titles">
          <h2 id="historyTitle" class="history-panel-title"></h2>
          <div id="historySubtitle" class="history-panel-subtitle muted"></div>
        </div>
        <button type="button" id="historyClose" class="btn btn-ghost btn-history-close"></button>
      </div>
      <div id="historyStatus" class="history-status muted"></div>
      <ul id="historyList" class="history-list"></ul>
    </div>
  </aside>

  <div id="preview-card" class="preview-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="preview-title">
    <div class="preview-dialog">
      <div class="preview-header">
        <div class="preview-title-group">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 5.75A2.75 2.75 0 016.75 3h10.5A2.75 2.75 0 0120 5.75v12.5A2.75 2.75 0 0117.25 21H6.75A2.75 2.75 0 014 18.25zm1.5 0v12.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25V5.75c0-.69-.56-1.25-1.25-1.25H6.75c-.69 0-1.25.56-1.25 1.25zm2.75 2a.75.75 0 010-1.5h7.5a.75.75 0 010 1.5zm0 4a.75.75 0 010-1.5h7.5a.75.75 0 010 1.5zm0 4a.75.75 0 010-1.5h4.5a.75.75 0 010 1.5z" />
          </svg>
          <strong id="preview-title"></strong>
        </div>
        <button type="button" id="btnClosePreview" class="btn btn-ghost btn-close-preview"></button>
      </div>
      <div class="preview-body" id="preview-body">
        <iframe id="preview-frame" class="preview" title=""></iframe>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const LANG_STORAGE_KEY = 'adminOfficeLicenses.lang';
    const translations = {
      en: {
        languageLabel: 'Language',
        languages: { en: 'English', ar: 'Arabic' },
        pageTitle: 'Admin Office Licenses',
        headerTitle: 'Admin Office Licenses',
        tablistLabel: 'Sections',
        tableAria: 'Licenses table',
        tabs: { dashboard: 'Dashboard', upload: 'Upload' },
        stats: { expired: 'Expired', upcoming: 'Upcoming (≤ 30 days)', active: 'Active' },
        searchPlaceholder: 'Search by name, description, labels…',
        searchAria: 'Search',
        refresh: 'Refresh',
        results: {
          countSingular: '{count} result',
          countPlural: '{count} result(s)',
          filteredSingular: '{count} result of {total} total',
          filteredPlural: '{count} result(s) of {total} total',
          failed: 'Failed to load data.',
          unable: 'Unable to load data.'
        },
        tableHeaders: {
          id: 'ID',
          name: 'Name',
          description: 'Description',
          exp1: 'Expiry 1',
          exp2: 'Expiry 2',
          status: 'Status',
          file: 'File',
          actions: 'Actions'
        },
        preview: {
          title: 'Preview',
          defaultTitle: 'Preview',
          close: 'Close',
          iframeTitle: 'File preview'
        },
        noRecords: 'No matching records.',
        fileLinks: { open: 'Open', preview: 'Preview', none: '—' },
        rowActions: {
          edit: 'Edit',
          editTooltip: 'Edit this record',
          renew: 'Renew',
          renewTooltip: 'Renew this record',
          history: 'History',
          historyTooltip: 'Show change history'
        },
        uploadForm: {
          nameLabel: 'Name',
          nameLabelAr: 'Name (Arabic)',
          namePlaceholderAr: 'Optional Arabic name',
          descriptionLabel: 'Description',
          descriptionLabelAr: 'Description (Arabic)',
          descriptionPlaceholderAr: 'Optional Arabic description',
          exp1Label: 'Expiry 1 Label',
          exp1Placeholder: 'e.g., License Expiry',
          exp1LabelAr: 'Expiry 1 Label (Arabic)',
          exp1PlaceholderAr: 'Arabic label (optional)',
          exp1Date: 'Expiry 1 Date',
          exp2Label: 'Expiry 2 Label',
          exp2Placeholder: 'e.g., Insurance Expiry',
          exp2LabelAr: 'Expiry 2 Label (Arabic)',
          exp2PlaceholderAr: 'Arabic label (optional)',
          exp2Date: 'Expiry 2 Date',
          documentLabel: 'Document (Image or PDF)',
          documentHelp: 'Optional. Files up to ~5MB recommended.',
          submit: 'Save',
          update: 'Update',
          renew: 'Renew',
          cancelEdit: 'Cancel edit'
        },
        uploadStatus: {
          uploading: 'Uploading…',
          saved: 'Saved. ID: {id}',
          updated: 'Updated. ID: {id}',
          renewed: 'Renewed. ID: {id}',
          link: 'Open file',
          errorWithMessage: 'Error: {message}',
          generic: 'Error saving record.',
          failedWithMessage: 'Failed: {message}'
        },
        history: {
          title: 'Change History',
          titleFor: 'History — {name}',
          subtitle: 'Record ID: {id}',
          close: 'Hide history',
          loading: 'Loading history…',
          empty: 'No history entries yet.',
          error: 'Unable to load history.',
          errorWithMessage: 'Unable to load history: {message}',
          noFile: 'No file available',
          labels: {
            timestamp: 'Timestamp',
            exp1: 'Expiry 1',
            exp2: 'Expiry 2',
            file: 'File',
            status: 'Status',
            none: '—'
          },
          actions: {
            update: 'Updated',
            renew: 'Renewed',
            create: 'Created'
          }
        },
        errors: {
          loadFail: 'Failed to load: {message}',
          runtimeUnavailable: 'Google Apps Script runtime is unavailable.'
        },
        status: {
          expired: 'Expired',
          active: 'Active',
          upcoming: {
            label: 'Upcoming',
            withinThreshold: 'Upcoming (≤ 30 days)',
            inOneDay: 'Upcoming (in 1 day)',
            inDays: 'Upcoming (in {days} days)',
            today: 'Upcoming (today)'
          }
        }
      },
      ar: {
        languageLabel: 'اللغة',
        languages: { en: 'الإنجليزية', ar: 'العربية' },
        pageTitle: 'تراخيص مكتب الإدارة',
        headerTitle: 'تراخيص مكتب الإدارة',
        tablistLabel: 'الأقسام',
        tableAria: 'جدول التراخيص',
        tabs: { dashboard: 'لوحة المعلومات', upload: 'رفع' },
        stats: { expired: 'منتهي', upcoming: 'قادم (≤ 30 يوم)', active: 'ساري' },
        searchPlaceholder: 'ابحث بالاسم أو الوصف أو التصنيفات…',
        searchAria: 'بحث',
        refresh: 'تحديث',
        results: {
          countSingular: '{count} نتيجة',
          countPlural: '{count} نتيجة',
          filteredSingular: '{count} نتيجة من إجمالي {total}',
          filteredPlural: '{count} نتيجة من إجمالي {total}',
          failed: 'فشل تحميل البيانات.',
          unable: 'تعذر تحميل البيانات.'
        },
        tableHeaders: {
          id: 'المعرف',
          name: 'الاسم',
          description: 'الوصف',
          exp1: 'الانتهاء 1',
          exp2: 'الانتهاء 2',
          status: 'الحالة',
          file: 'الملف',
          actions: 'الإجراءات'
        },
        preview: {
          title: 'معاينة',
          defaultTitle: 'معاينة',
          close: 'إغلاق',
          iframeTitle: 'معاينة الملف'
        },
        noRecords: 'لا توجد سجلات مطابقة.',
        fileLinks: { open: 'فتح', preview: 'معاينة', none: '—' },
        rowActions: {
          edit: 'تعديل',
          editTooltip: 'تعديل السجل',
          renew: 'تجديد',
          renewTooltip: 'تجديد السجل',
          history: 'السجل',
          historyTooltip: 'عرض سجل التعديلات'
        },
        uploadForm: {
          nameLabel: 'الاسم',
          nameLabelAr: 'الاسم (بالعربية)',
          namePlaceholderAr: 'اسم عربي اختياري',
          descriptionLabel: 'الوصف',
          descriptionLabelAr: 'الوصف (بالعربية)',
          descriptionPlaceholderAr: 'وصف عربي اختياري',
          exp1Label: 'تسمية الانتهاء 1',
          exp1Placeholder: 'مثال: انتهاء الترخيص',
          exp1LabelAr: 'تسمية الانتهاء 1 (بالعربية)',
          exp1PlaceholderAr: 'تسمية عربية اختيارية',
          exp1Date: 'تاريخ الانتهاء 1',
          exp2Label: 'تسمية الانتهاء 2',
          exp2Placeholder: 'مثال: انتهاء التأمين',
          exp2LabelAr: 'تسمية الانتهاء 2 (بالعربية)',
          exp2PlaceholderAr: 'تسمية عربية اختيارية',
          exp2Date: 'تاريخ الانتهاء 2',
          documentLabel: 'المستند (صورة أو PDF)',
          documentHelp: 'اختياري. يفضل ملفات حتى 5 ميجابايت تقريبًا.',
          submit: 'حفظ',
          update: 'تحديث',
          renew: 'تجديد',
          cancelEdit: 'إلغاء التعديل'
        },
        uploadStatus: {
          uploading: 'جارٍ الرفع…',
          saved: 'تم الحفظ. المعرّف: {id}',
          updated: 'تم التحديث. المعرّف: {id}',
          renewed: 'تم التجديد. المعرّف: {id}',
          link: 'فتح الملف',
          errorWithMessage: 'خطأ: {message}',
          generic: 'حدث خطأ أثناء حفظ السجل.',
          failedWithMessage: 'فشل: {message}'
        },
        history: {
          title: 'سجل التغييرات',
          titleFor: 'سجل التغييرات — {name}',
          subtitle: 'معرف السجل: {id}',
          close: 'إخفاء السجل',
          loading: 'جاري تحميل السجل…',
          empty: 'لا توجد تغييرات مسجلة.',
          error: 'تعذر تحميل السجل.',
          errorWithMessage: 'تعذر تحميل السجل: {message}',
          noFile: 'لا يوجد ملف',
          labels: {
            timestamp: 'الوقت',
            exp1: 'الانتهاء 1',
            exp2: 'الانتهاء 2',
            file: 'الملف',
            status: 'الحالة',
            none: '—'
          },
          actions: {
            update: 'تم التحديث',
            renew: 'تم التجديد',
            create: 'تم الإنشاء'
          }
        },
        errors: {
          loadFail: 'فشل التحميل: {message}',
          runtimeUnavailable: 'بيئة Google Apps Script غير متاحة.'
        },
        status: {
          expired: 'منتهي',
          active: 'ساري',
          upcoming: {
            label: 'قادم',
            withinThreshold: 'قادم (≤ 30 يوم)',
            inOneDay: 'قادم (خلال يوم واحد)',
            inDays: 'قادم (خلال {days} يوم)',
            today: 'قادم (اليوم)'
          }
        }
      }
    };

    const languageSelect = document.getElementById('languageSelect');
    const headerTitle = document.getElementById('headerTitle');
    const tabDashboard = document.getElementById('tabDashboard');
    const tabUpload = document.getElementById('tabUpload');
    const tablist = document.getElementById('tablist');
    const statLabelExpired = document.getElementById('statLabelExpired');
    const statLabelUpcoming = document.getElementById('statLabelUpcoming');
    const statLabelActive = document.getElementById('statLabelActive');
    const searchEl = document.getElementById('search');
    const btnRefresh = document.getElementById('btnRefresh');
    const resultCountEl = document.getElementById('result-count');
    const table = document.getElementById('table');
    const previewCard = document.getElementById('preview-card');
    const previewTitle = document.getElementById('preview-title');
    const previewFrame = document.getElementById('preview-frame');
    const btnClosePreview = document.getElementById('btnClosePreview');
    const labelName = document.getElementById('labelName');
    const labelDescription = document.getElementById('labelDescription');
    const labelNameAr = document.getElementById('labelNameAr');
    const labelDescriptionAr = document.getElementById('labelDescriptionAr');
    const labelExp1 = document.getElementById('labelExp1');
    const labelExp1Date = document.getElementById('labelExp1Date');
    const labelExp2 = document.getElementById('labelExp2');
    const labelExp2Date = document.getElementById('labelExp2Date');
    const labelExp1Ar = document.getElementById('labelExp1Ar');
    const labelExp2Ar = document.getElementById('labelExp2Ar');
    const labelDocument = document.getElementById('labelDocument');
    const documentHelp = document.getElementById('documentHelp');
    const btnUpload = document.getElementById('btnUpload');
    const btnCancelEdit = document.getElementById('btnCancelEdit');
    const uploadResult = document.getElementById('uploadResult');
    const languageLabel = document.getElementById('languageLabel');
    const uploadForm = document.getElementById('uploadForm');
    const historyPanel = document.getElementById('historyPanel');
    const historyTitle = document.getElementById('historyTitle');
    const historySubtitle = document.getElementById('historySubtitle');
    const historyStatus = document.getElementById('historyStatus');
    const historyList = document.getElementById('historyList');
    const historyClose = document.getElementById('historyClose');

    const inputName = document.getElementById('uploadName');
    const inputDescription = document.getElementById('uploadDescription');
    const inputNameAr = document.getElementById('uploadNameAr');
    const inputDescriptionAr = document.getElementById('uploadDescriptionAr');
    const exp1LabelInputEn = document.getElementById('uploadExp1Label');
    const exp1LabelInputAr = document.getElementById('uploadExp1LabelAr');
    const exp2LabelInputEn = document.getElementById('uploadExp2Label');
    const exp2LabelInputAr = document.getElementById('uploadExp2LabelAr');

    let currentLang = localStorage.getItem(LANG_STORAGE_KEY) || 'en';
    if (!translations[currentLang]) currentLang = 'en';
    languageSelect.value = currentLang;

    const state = {
      rows: [],
      rowsById: new Map(),
      countsAll: createEmptyCounts(),
      countsFiltered: createEmptyCounts()
    };
    let hasLoaded = false;
    let lastUploadState = { type: 'idle', payload: null };
    let resultState = { type: 'count' };
    let formMode = { type: 'create', id: null, record: null };
    const historyState = { open: false, id: null, record: null, entries: [], loading: false, error: null };

    function t(path) {
      const langTable = translations[currentLang] || translations.en;
      const parts = path.split('.');
      let node = langTable;
      for (const part of parts) {
        if (node && Object.prototype.hasOwnProperty.call(node, part)) {
          node = node[part];
        } else {
          return path;
        }
      }
      return typeof node === 'string' ? node : path;
    }

    function format(str, params = {}) {
      return String(str).replace(/\{(\w+)\}/g, (_, key) => (
        params[key] != null ? params[key] : ''
      ));
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function escapeAttr(s) {
      return String(s ?? '')
        .replace(/&/g,'&amp;').replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;').replace(/</g,'&lt;');
    }
    function safeHref(url) {
      const value = String(url || '').trim();
      return /^https?:\/\//i.test(value) ? value : '';
    }

    function createEmptyStatusCounts() {
      return { total: 0, exp1: 0, exp2: 0, overall: 0 };
    }

    function createEmptyCounts() {
      return {
        total: 0,
        expired: createEmptyStatusCounts(),
        upcoming: createEmptyStatusCounts(),
        active: createEmptyStatusCounts()
      };
    }

    function toCountNumber(value, fallback = 0) {
      const num = Number(value);
      if (Number.isFinite(num)) return num;
      const fallbackNum = Number(fallback);
      return Number.isFinite(fallbackNum) ? fallbackNum : 0;
    }

    function normalizeStatusCounts(bucket) {
      const base = createEmptyStatusCounts();
      if (!bucket || typeof bucket !== 'object') {
        return base;
      }
      ['total', 'exp1', 'exp2', 'overall'].forEach(key => {
        if (bucket[key] != null) {
          base[key] = toCountNumber(bucket[key], base[key]);
        }
      });
      return base;
    }

    function normalizeCountsPayload(payload, fallbackTotal) {
      const base = createEmptyCounts();
      if (!payload || typeof payload !== 'object') {
        base.total = toCountNumber(fallbackTotal, 0);
        return base;
      }
      base.total = toCountNumber(payload.total, fallbackTotal);
      base.expired = normalizeStatusCounts(payload.expired);
      base.upcoming = normalizeStatusCounts(payload.upcoming);
      base.active = normalizeStatusCounts(payload.active);
      return base;
    }

    function trimUploadTextFields() {
      [
        inputName,
        inputDescription,
        inputNameAr,
        inputDescriptionAr,
        exp1LabelInputEn,
        exp1LabelInputAr,
        exp2LabelInputEn,
        exp2LabelInputAr
      ].forEach(input => {
        if (!input) return;
        if (typeof input.value === 'string') {
          input.value = input.value.trim();
        }
      });
    }

    function updateFormModeUi() {
      const langTable = translations[currentLang] || translations.en;
      const formStrings = langTable.uploadForm || translations.en.uploadForm;
      const mode = formMode && formMode.type ? formMode.type : 'create';
      let key = 'submit';
      if (mode === 'edit') key = 'update';
      if (mode === 'renew') key = 'renew';
      const submitLabel = formStrings[key] || formStrings.submit || '';
      btnUpload.textContent = submitLabel;
      if (btnCancelEdit) {
        const cancelLabel = formStrings.cancelEdit || '';
        btnCancelEdit.textContent = cancelLabel;
        btnCancelEdit.classList.toggle('hidden', mode === 'create');
      }
    }

    function setFormMode(type, options = {}) {
      const normalizedType = type === 'edit' || type === 'renew' ? type : 'create';
      formMode = {
        type: normalizedType,
        id: options && options.id != null ? String(options.id) : null,
        record: options && options.record ? options.record : null
      };
      if (uploadForm) {
        if (normalizedType === 'create') {
          delete uploadForm.dataset.mode;
          delete uploadForm.dataset.recordId;
        } else {
          uploadForm.dataset.mode = normalizedType;
          uploadForm.dataset.recordId = formMode.id || '';
        }
      }
      updateFormModeUi();
    }

    function populateFormFromRecord(record) {
      if (!record || !uploadForm) return;
      uploadForm.reset();
      if (inputName) inputName.value = record.name || '';
      if (inputDescription) inputDescription.value = record.description || '';
      if (inputNameAr) inputNameAr.value = record.nameAr || '';
      if (inputDescriptionAr) inputDescriptionAr.value = record.descriptionAr || '';
      if (exp1LabelInputEn) exp1LabelInputEn.value = record.exp1Label || '';
      if (exp1LabelInputAr) exp1LabelInputAr.value = record.exp1LabelAr || '';
      if (exp2LabelInputEn) exp2LabelInputEn.value = record.exp2Label || '';
      if (exp2LabelInputAr) exp2LabelInputAr.value = record.exp2LabelAr || '';
      const exp1DateInput = uploadForm.querySelector('input[name="exp1Date"]');
      const exp2DateInput = uploadForm.querySelector('input[name="exp2Date"]');
      if (exp1DateInput) exp1DateInput.value = record.exp1Date || '';
      if (exp2DateInput) exp2DateInput.value = record.exp2Date || '';
      if (uploadForm.file) {
        try { uploadForm.file.value = ''; } catch (err) {}
      }
    }

    function goToUploadTab() {
      if (tabUpload && !tabUpload.classList.contains('active')) {
        tabUpload.click();
      }
    }

    function enterFormMode(type, record) {
      if (!record) return;
      populateFormFromRecord(record);
      setFormMode(type, { id: record.id, record });
      goToUploadTab();
      setUploadStatus('idle');
      if (inputName && typeof inputName.focus === 'function') {
        setTimeout(() => inputName.focus(), 0);
      }
    }

    function cancelEditMode() {
      if (uploadForm) uploadForm.reset();
      setFormMode('create');
      setUploadStatus('idle');
    }

    function getHistoryStrings() {
      return (translations[currentLang] && translations[currentLang].history) || translations.en.history;
    }

    function updateHistoryTitles() {
      if (!historyPanel) return;
      const hist = getHistoryStrings();
      if (historyClose) historyClose.textContent = hist.close || '';
      if (!historyState.open || !historyState.record) {
        historyTitle.textContent = hist.title || '';
        historySubtitle.textContent = '';
        return;
      }
      const name = getLocalizedField(historyState.record, 'name') || historyState.record.name || historyState.record.id || '';
      const title = name && hist.titleFor ? format(hist.titleFor, { name }) : hist.title;
      historyTitle.textContent = title || '';
      const subtitle = hist.subtitle ? format(hist.subtitle, { id: historyState.id || '' }) : '';
      historySubtitle.textContent = subtitle || '';
    }

    function updateHistoryUi() {
      if (!historyPanel) return;
      if (historyState.open) {
        historyPanel.classList.remove('hidden');
        historyPanel.setAttribute('aria-hidden', 'false');
        updateHistoryTitles();
      } else {
        historyPanel.classList.add('hidden');
        historyPanel.setAttribute('aria-hidden', 'true');
      }
      renderHistoryEntries();
      if (!historyState.open) {
        updateHistoryTitles();
      }
    }

    function renderHistoryEntries() {
      if (!historyPanel) return;
      const hist = getHistoryStrings();
      if (!historyState.open) {
        historyStatus.textContent = '';
        historyList.innerHTML = '';
        return;
      }
      if (historyState.loading) {
        historyStatus.textContent = hist.loading || '';
        historyList.innerHTML = '';
        return;
      }
      if (historyState.error) {
        historyStatus.textContent = historyState.error;
        historyList.innerHTML = '';
        return;
      }
      if (!historyState.entries.length) {
        historyStatus.textContent = hist.empty || '';
        historyList.innerHTML = '';
        return;
      }
      historyStatus.textContent = '';
      const noneLabel = (hist.labels && hist.labels.none) || t('fileLinks.none');
      historyList.innerHTML = historyState.entries.map(entry => {
        const actionLabel = (hist.actions && hist.actions[entry.action]) || entry.action || '';
        const timestampText = formatHistoryTimestamp(entry.timestamp);
        const exp1Value = entry.prevExp1Date
          ? escapeHtml(entry.prevExp1Date)
          : `<span class="muted">${escapeHtml(noneLabel)}</span>`;
        const exp2Value = entry.prevExp2Date
          ? escapeHtml(entry.prevExp2Date)
          : `<span class="muted">${escapeHtml(noneLabel)}</span>`;
        const statusValue = entry.prevStatus
          ? escapeHtml(entry.prevStatus)
          : `<span class="muted">${escapeHtml(noneLabel)}</span>`;
        const fileHtml = entry.prevFileUrl
          ? `<a href="${escapeAttr(entry.prevFileUrl)}" target="_blank" rel="noopener">${escapeHtml(entry.prevFileName || entry.prevFileUrl)}</a>`
          : `<span class="muted">${escapeHtml(hist.noFile || noneLabel)}</span>`;
        return `
          <li class="history-entry">
            <div class="history-entry-header">
              <span>${escapeHtml(actionLabel)}</span>
              <time>${escapeHtml(timestampText)}</time>
            </div>
            <div class="history-entry-body">
              <span><strong>${escapeHtml(hist.labels.exp1)}</strong> ${exp1Value}</span>
              <span><strong>${escapeHtml(hist.labels.exp2)}</strong> ${exp2Value}</span>
              <span><strong>${escapeHtml(hist.labels.status)}</strong> ${statusValue}</span>
              <span><strong>${escapeHtml(hist.labels.file)}</strong> ${fileHtml}</span>
            </div>
          </li>
        `;
      }).join('');
    }

    function closeHistoryPanel() {
      historyState.open = false;
      historyState.id = null;
      historyState.record = null;
      historyState.entries = [];
      historyState.error = null;
      historyState.loading = false;
      updateHistoryUi();
    }

    function fetchHistory(recordId) {
      if (!recordId) {
        historyState.loading = false;
        historyState.error = getHistoryStrings().error || '';
        renderHistoryEntries();
        return;
      }
      historyState.loading = true;
      historyState.error = null;
      historyState.entries = [];
      renderHistoryEntries();
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error(t('errors.runtimeUnavailable'));
        }
        google.script.run.withSuccessHandler(entries => {
          historyState.loading = false;
          historyState.error = null;
          historyState.entries = Array.isArray(entries) ? entries : [];
          renderHistoryEntries();
        }).withFailureHandler(err => {
          historyState.loading = false;
          const message = err && err.message ? err.message : err;
          const hist = getHistoryStrings();
          historyState.error = hist.errorWithMessage
            ? format(hist.errorWithMessage, { message: String(message || '') })
            : (hist.error || String(message || ''));
          renderHistoryEntries();
        }).getLicenseHistory(recordId);
      } catch (err) {
        historyState.loading = false;
        const hist = getHistoryStrings();
        historyState.error = hist.errorWithMessage
          ? format(hist.errorWithMessage, { message: String((err && err.message) || err || '') })
          : (hist.error || String((err && err.message) || err || ''));
        renderHistoryEntries();
      }
    }

    function toggleHistory(record) {
      if (!record) return;
      const recordId = record.id != null ? String(record.id) : '';
      if (!recordId) return;
      if (historyState.open && historyState.id === recordId) {
        closeHistoryPanel();
        return;
      }
      historyState.open = true;
      historyState.id = recordId;
      historyState.record = record;
      historyState.entries = [];
      historyState.error = null;
      historyState.loading = true;
      updateHistoryUi();
      fetchHistory(recordId);
    }

    function formatHistoryTimestamp(value) {
      if (!value) return '';
      const date = new Date(value);
      if (!isNaN(date)) {
        try {
          const locale = currentLang === 'ar' ? 'ar' : 'en';
          return date.toLocaleString(locale, { dateStyle: 'medium', timeStyle: 'short' });
        } catch (err) {
          return date.toISOString();
        }
      }
      return String(value);
    }

    function getRowByIdLocal(id) {
      if (id == null) return null;
      const key = String(id);
      if (state.rowsById && typeof state.rowsById.get === 'function' && state.rowsById.has(key)) {
        return state.rowsById.get(key);
      }
      return state.rows.find(r => String(r.id) === key) || null;
    }

    function applyTranslations() {
      const langTable = translations[currentLang] || translations.en;
      document.documentElement.lang = currentLang;
      document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
      document.title = langTable.pageTitle;
      headerTitle.textContent = langTable.headerTitle;
      tabDashboard.textContent = langTable.tabs.dashboard;
      tabUpload.textContent = langTable.tabs.upload;
      tablist.setAttribute('aria-label', langTable.tablistLabel);
      statLabelExpired.textContent = langTable.stats.expired;
      statLabelUpcoming.textContent = langTable.stats.upcoming;
      statLabelActive.textContent = langTable.stats.active;
      searchEl.placeholder = langTable.searchPlaceholder;
      searchEl.setAttribute('aria-label', langTable.searchAria);
      btnRefresh.textContent = langTable.refresh;
      renderResultState();
      table.setAttribute('aria-label', langTable.tableAria);
      document.getElementById('thId').textContent = langTable.tableHeaders.id;
      document.getElementById('thName').textContent = langTable.tableHeaders.name;
      document.getElementById('thDescription').textContent = langTable.tableHeaders.description;
      document.getElementById('thExpiry1').textContent = langTable.tableHeaders.exp1;
      document.getElementById('thExpiry2').textContent = langTable.tableHeaders.exp2;
      document.getElementById('thStatus').textContent = langTable.tableHeaders.status;
      document.getElementById('thFile').textContent = langTable.tableHeaders.file;
      document.getElementById('thActions').textContent = langTable.tableHeaders.actions;
      previewTitle.textContent = previewCard.classList.contains('hidden') ? langTable.preview.title : previewTitle.textContent;
      previewFrame.title = langTable.preview.iframeTitle;
      btnClosePreview.textContent = langTable.preview.close;
      labelName.textContent = langTable.uploadForm.nameLabel;
      labelDescription.textContent = langTable.uploadForm.descriptionLabel;
      if (labelNameAr) labelNameAr.textContent = langTable.uploadForm.nameLabelAr;
      if (labelDescriptionAr) labelDescriptionAr.textContent = langTable.uploadForm.descriptionLabelAr;
      labelExp1.textContent = langTable.uploadForm.exp1Label;
      labelExp1Date.textContent = langTable.uploadForm.exp1Date;
      labelExp2.textContent = langTable.uploadForm.exp2Label;
      labelExp2Date.textContent = langTable.uploadForm.exp2Date;
      if (labelExp1Ar) labelExp1Ar.textContent = langTable.uploadForm.exp1LabelAr;
      if (labelExp2Ar) labelExp2Ar.textContent = langTable.uploadForm.exp2LabelAr;
      labelDocument.textContent = langTable.uploadForm.documentLabel;
      documentHelp.textContent = langTable.uploadForm.documentHelp;
      exp1LabelInputEn.placeholder = langTable.uploadForm.exp1Placeholder;
      exp2LabelInputEn.placeholder = langTable.uploadForm.exp2Placeholder;
      if (inputNameAr) inputNameAr.placeholder = langTable.uploadForm.namePlaceholderAr;
      if (inputDescriptionAr) inputDescriptionAr.placeholder = langTable.uploadForm.descriptionPlaceholderAr;
      if (exp1LabelInputAr) exp1LabelInputAr.placeholder = langTable.uploadForm.exp1PlaceholderAr;
      if (exp2LabelInputAr) exp2LabelInputAr.placeholder = langTable.uploadForm.exp2PlaceholderAr;
      languageLabel.textContent = langTable.languageLabel;
      languageSelect.setAttribute('aria-label', langTable.languageLabel);
      Object.entries(langTable.languages).forEach(([value, label]) => {
        const option = languageSelect.querySelector(`option[value="${value}"]`);
        if (option) option.textContent = label;
      });
      updateFormModeUi();
      updateHistoryUi();
      renderUploadStatus();
      renderTable(state.rows);
      updateStatsDisplay();
      renderResultState();
    }

    function formatCountLabel() {
      const filtered = toCountNumber(state.countsFiltered && state.countsFiltered.total, state.rows.length);
      const total = toCountNumber(state.countsAll && state.countsAll.total, filtered);
      const same = filtered === total;
      const key = same
        ? (filtered === 1 ? 'results.countSingular' : 'results.countPlural')
        : (filtered === 1 ? 'results.filteredSingular' : 'results.filteredPlural');
      return format(t(key), { count: filtered, total });
    }

    function renderResultState() {
      if (resultState.type === 'failed') {
        resultCountEl.textContent = t('results.failed');
      } else if (resultState.type === 'unable') {
        resultCountEl.textContent = t('results.unable');
      } else {
        resultCountEl.textContent = formatCountLabel();
      }
    }

    function setResultState(type) {
      resultState = { type };
      renderResultState();
    }

    function updateStatsDisplay() {
      const counts = state.countsAll || createEmptyCounts();
      const expired = counts.expired || createEmptyStatusCounts();
      const upcoming = counts.upcoming || createEmptyStatusCounts();
      const active = counts.active || createEmptyStatusCounts();

      document.getElementById('stat-expired').textContent = toCountNumber(expired.total, 0);
      document.getElementById('stat-upcoming').textContent = toCountNumber(upcoming.total, 0);
      document.getElementById('stat-active').textContent = toCountNumber(active.total, 0);
    }

    function setUploadStatus(type, payload) {
      lastUploadState = { type, payload };
      renderUploadStatus();
    }

    function renderUploadStatus() {
      switch (lastUploadState.type) {
        case 'uploading':
          uploadResult.textContent = t('uploadStatus.uploading');
          break;
        case 'saved':
        case 'updated':
        case 'renewed': {
          const payload = lastUploadState.payload || {};
          const openUrl = safeHref(payload.fileUrl);
          let key = 'uploadStatus.saved';
          if (lastUploadState.type === 'updated') key = 'uploadStatus.updated';
          if (lastUploadState.type === 'renewed') key = 'uploadStatus.renewed';
          const savedText = format(t(key), { id: payload.id != null ? payload.id : '' });
          const linkHtml = openUrl
            ? ` · <a class="link" target="_blank" rel="noopener" href="${escapeAttr(openUrl)}">${escapeHtml(t('uploadStatus.link'))}</a>`
            : '';
          uploadResult.innerHTML = `${escapeHtml(savedText)}${linkHtml}`;
          break;
        }
        case 'error': {
          const messageRaw = lastUploadState.payload && lastUploadState.payload.message;
          const message = messageRaw != null ? String(messageRaw) : '';
          if (message) {
            uploadResult.textContent = format(t('uploadStatus.errorWithMessage'), { message });
          } else {
            uploadResult.textContent = t('uploadStatus.generic');
          }
          break;
        }
        case 'failed': {
          const messageRaw = lastUploadState.payload && lastUploadState.payload.message;
          const message = messageRaw != null ? String(messageRaw) : '';
          uploadResult.textContent = format(t('uploadStatus.failedWithMessage'), { message });
          break;
        }
        default:
          uploadResult.textContent = '';
      }
    }

    function setLoading(el, isLoading){
      if (!el) return;
      const loading = !!isLoading;
      el.classList.toggle('loading', loading);
      if ('disabled' in el) el.disabled = loading;
      el.setAttribute('aria-busy', loading ? 'true' : 'false');
    }

    function statusPill(status) {
      if (status == null || status === '') {
        return '';
      }
      const base = 'pill status-';
      const langStatus = (translations[currentLang] && translations[currentLang].status) || translations.en.status;
      const upcomingTranslations = langStatus.upcoming || {};

      const statusObj = (status && typeof status === 'object') ? status : null;
      const raw = statusObj && statusObj.label != null ? String(statusObj.label) : String(status || '');

      if (!statusObj && !raw.trim()) {
        return '';
      }

      let type = statusObj && statusObj.type ? String(statusObj.type) : '';
      let days = statusObj && statusObj.daysUntil != null ? Number(statusObj.daysUntil) : null;
      if (!Number.isFinite(days)) days = null;
      let withinThreshold = !!(statusObj && statusObj.withinThreshold);
      let mode = statusObj && statusObj.mode ? String(statusObj.mode) : '';

      if (!type) {
        const normalized = raw.toLowerCase();
        if (normalized === 'expired') {
          type = 'Expired';
        } else if (normalized === 'active') {
          type = 'Active';
        } else if (normalized.startsWith('upcoming')) {
          type = 'Upcoming';
        }
      }

      if (type === 'Upcoming') {
        if (days == null) {
          const match = raw.match(/in\s+(-?\d+)/i);
          if (match) {
            const parsed = Number(match[1]);
            if (Number.isFinite(parsed)) days = parsed;
          }
        }
        if (!withinThreshold && /≤\s*30/.test(raw)) {
          withinThreshold = true;
          if (!mode) mode = 'threshold';
        }
        if (!mode) {
          mode = days != null ? 'exact' : (withinThreshold ? 'threshold' : '');
        }
      }

      let text;
      if (type === 'Expired') {
        text = langStatus.expired;
      } else if (type === 'Upcoming') {
        if ((mode === 'threshold' || (withinThreshold && days == null)) && upcomingTranslations.withinThreshold) {
          text = upcomingTranslations.withinThreshold;
        } else if (days != null) {
          if (days === 0 && upcomingTranslations.today) {
            text = upcomingTranslations.today;
          } else if (days === 1 && upcomingTranslations.inOneDay) {
            text = upcomingTranslations.inOneDay;
          } else if (upcomingTranslations.inDays) {
            text = format(upcomingTranslations.inDays, { days });
          } else if (upcomingTranslations.withinThreshold) {
            text = upcomingTranslations.withinThreshold;
          } else if (upcomingTranslations.label) {
            text = upcomingTranslations.label;
          } else {
            text = 'Upcoming';
          }
        } else if (upcomingTranslations.label) {
          text = upcomingTranslations.label;
        } else {
          text = 'Upcoming';
        }
      } else {
        type = 'Active';
        text = langStatus.active;
      }

      const variant = type === 'Expired' ? 'Expired' : type === 'Upcoming' ? 'Upcoming' : 'Active';
      return `<span class="${base}${variant}">${escapeHtml(text)}</span>`;
    }

    function renderExpiryCell(label, date, status) {
      const pieces = [];
      const hasLabel = label && String(label).trim();
      const hasDate = date && String(date).trim();
      if (hasLabel) {
        pieces.push(escapeHtml(label));
      }
      if (hasDate) {
        pieces.push(`<span class="muted">(${escapeHtml(date)})</span>`);
      }
      if (!pieces.length) {
        pieces.push(`<span class="muted">—</span>`);
      }
      const pill = statusPill(status);
      const pillPart = pill ? ` ${pill}` : '';
      return `<div class="expiry-cell">${pieces.join(' ')}${pillPart}</div>`;
    }

    function getLocalizedField(row, key) {
      if (!row) return '';
      if (currentLang === 'ar') {
        const localizedKey = `${key}Ar`;
        if (row[localizedKey]) {
          return row[localizedKey];
        }
      }
      return row[key] || '';
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#table tbody');
      if (!hasLoaded && (!rows || !rows.length)) {
        tbody.innerHTML = '';
        return;
      }
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="muted">${escapeHtml(t('noRecords'))}</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const displayName = getLocalizedField(r, 'name');
        const displayDescription = getLocalizedField(r, 'description');
        const exp1Label = getLocalizedField(r, 'exp1Label');
        const exp2Label = getLocalizedField(r, 'exp2Label');
        const exp1 = renderExpiryCell(exp1Label, r.exp1Date, r.exp1StatusInfo || r.exp1Status || null);
        const exp2 = renderExpiryCell(exp2Label, r.exp2Date, r.exp2StatusInfo || r.exp2Status || null);
        const rowId = r.id != null ? r.id : '';
        const fileUrl = safeHref(r.fileUrl);
        const previewUrl = safeHref(r.filePreviewUrl);
        const previewTitleText = r.fileName || displayName || t('preview.defaultTitle');
        const openButton = fileUrl
          ? `<a class="doc-action-button open" href="${escapeAttr(fileUrl)}" target="_blank" rel="noopener">`
            + `<svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">`
            + `<path d="M14 3h7v7" /><path d="M10 14L21 3" /><path d="M21 10v9a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h9" />`
            + `</svg><span>${escapeHtml(t('fileLinks.open'))}</span></a>`
          : '';
        const previewButton = previewUrl
          ? `<button type="button" class="doc-action-button preview link-preview" aria-haspopup="dialog" data-preview-url="${escapeAttr(previewUrl)}" data-preview-title="${escapeAttr(previewTitleText)}">`
            + `<svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">`
            + `<path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" /><circle cx="12" cy="12" r="3" />`
            + `</svg><span>${escapeHtml(t('fileLinks.preview'))}</span></button>`
          : '';
        const fileCell = openButton || previewButton
          ? `<div class="doc-actions">${openButton}${previewButton}</div>`
          : `<span class="muted doc-action-empty">${escapeHtml(t('fileLinks.none'))}</span>`;
        const actionEditLabel = t('rowActions.edit');
        const actionRenewLabel = t('rowActions.renew');
        const actionHistoryLabel = t('rowActions.history');
        const actionEditTooltip = t('rowActions.editTooltip');
        const actionRenewTooltip = t('rowActions.renewTooltip');
        const actionHistoryTooltip = t('rowActions.historyTooltip');
        const historyButton = r.hasHistory
          ? `<button type="button" class="record-action-button history" data-action="history" data-id="${escapeAttr(rowId)}" title="${escapeAttr(actionHistoryTooltip)}">${escapeHtml(actionHistoryLabel)}</button>`
          : `<button type="button" class="record-action-button history" data-action="history" data-id="${escapeAttr(rowId)}" title="${escapeAttr(actionHistoryTooltip)}" disabled aria-disabled="true">${escapeHtml(actionHistoryLabel)}</button>`;
        const actionsCell = `
          <div class="record-actions" data-id="${escapeAttr(rowId)}">
            <button type="button" class="record-action-button edit" data-action="edit" data-id="${escapeAttr(rowId)}" title="${escapeAttr(actionEditTooltip)}">${escapeHtml(actionEditLabel)}</button>
            <button type="button" class="record-action-button renew" data-action="renew" data-id="${escapeAttr(rowId)}" title="${escapeAttr(actionRenewTooltip)}">${escapeHtml(actionRenewLabel)}</button>
            ${historyButton}
          </div>
        `;
        return `
          <tr data-record-id="${escapeAttr(rowId)}">
            <td>${escapeHtml(rowId)}</td>
            <td>${escapeHtml(displayName)}</td>
            <td>${escapeHtml(displayDescription)}</td>
            <td>${exp1}</td>
            <td>${exp2}</td>
            <td>${statusPill(r.statusInfo || r.status)}</td>
            <td>${fileCell}</td>
            <td>${actionsCell}</td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('.link-preview').forEach(link => {
        link.addEventListener('click', evt => {
          evt.preventDefault();
          preview(link.getAttribute('data-preview-url'), link.getAttribute('data-preview-title'));
        });
      });
      tbody.querySelectorAll('.record-action-button').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.disabled) return;
          const action = btn.getAttribute('data-action');
          const id = btn.getAttribute('data-id');
          handleRecordAction(action, id);
        });
      });
    }

    function handleRecordAction(action, id) {
      const record = getRowByIdLocal(id);
      if (!record) return;
      if (action === 'edit') {
        enterFormMode('edit', record);
      } else if (action === 'renew') {
        enterFormMode('renew', record);
      } else if (action === 'history') {
        toggleHistory(record);
      }
    }

    function updateCounts(data) {
      const prevTotal = state.countsAll && Number.isFinite(state.countsAll.total)
        ? state.countsAll.total
        : null;
      const fallbackTotal = prevTotal && prevTotal > 0 ? prevTotal : state.rows.length;
      state.countsAll = normalizeCountsPayload(data, fallbackTotal);
      updateStatsDisplay();
    }

    function updateFilteredCounts(countsFiltered) {
      state.countsFiltered = normalizeCountsPayload(countsFiltered, state.rows.length);
      if (resultState.type === 'count') {
        renderResultState();
      }
    }

    function preview(url, title){
      const safeUrl = safeHref(url);
      if (!safeUrl) return;
      previewTitle.textContent = title || t('preview.defaultTitle');
      previewFrame.src = safeUrl;
      previewCard.classList.remove('hidden');
      if (typeof previewFrame.focus === 'function') {
        previewFrame.focus();
      }
    }
    window.preview = preview;
    btnClosePreview.addEventListener('click', ()=>{
      previewCard.classList.add('hidden');
      previewFrame.src = '';
      previewTitle.textContent = t('preview.title');
    });

    if (btnCancelEdit) {
      btnCancelEdit.addEventListener('click', () => {
        cancelEditMode();
      });
    }

    if (historyClose) {
      historyClose.addEventListener('click', () => {
        closeHistoryPanel();
      });
    }

    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>{
          x.classList.remove('active'); x.setAttribute('aria-selected','false');
        });
        t.classList.add('active'); t.setAttribute('aria-selected','true');
        const tab = t.dataset.tab;
        document.getElementById('dashboard').classList.toggle('hidden', tab!=='dashboard');
        document.getElementById('upload').classList.toggle('hidden', tab!=='upload');
      });
    });

    languageSelect.addEventListener('change', ()=>{
      const value = languageSelect.value;
      currentLang = translations[value] ? value : 'en';
      localStorage.setItem(LANG_STORAGE_KEY, currentLang);
      applyTranslations();
    });

    searchEl.addEventListener('input', debounce(() => refresh(), 250));
    btnRefresh.addEventListener('click', () => refresh());

    function debounce(fn, ms){ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a), ms); }; }

    function refresh(options) {
      const hasOverride = options && typeof options === 'object' && Object.prototype.hasOwnProperty.call(options, 'query');
      const q = hasOverride ? options.query : (searchEl.value || '');
      setLoading(btnRefresh, true);
      try {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error(t('errors.runtimeUnavailable'));
        }
        google.script.run.withSuccessHandler((payload = {})=>{
          let resultType = 'count';
          try {
            const isObjectPayload = payload && typeof payload === 'object' && !Array.isArray(payload);
            let safePayload = isObjectPayload ? payload : null;
            if (!safePayload) {
              console.warn('Dashboard payload was empty or invalid; using defaults.', payload);
              safePayload = {
                rows: [],
                countsAll: createEmptyCounts(),
                countsFiltered: createEmptyCounts()
              };
              resultType = 'failed';
            }

            const rowsAreArray = Array.isArray(safePayload.rows);
            if (!rowsAreArray && safePayload.rows != null) {
              console.warn('Dashboard payload rows must be an array; defaulting to empty list.', safePayload.rows);
              resultType = 'failed';
            }
            const rows = rowsAreArray ? safePayload.rows : [];
            const countsAll = normalizeCountsPayload(safePayload.countsAll, rows.length);
            const countsFiltered = normalizeCountsPayload(safePayload.countsFiltered, rows.length);

            state.rows = rows;
            state.rowsById = new Map(rows.map(r => [String(r.id), r]));
            if (historyState.open && historyState.id) {
              const updatedRecord = state.rowsById.get(String(historyState.id));
              if (updatedRecord) {
                historyState.record = updatedRecord;
                updateHistoryTitles();
              }
            }
            updateCounts(countsAll);
            updateFilteredCounts(countsFiltered);
            hasLoaded = true;
            renderTable(state.rows);
            setResultState(resultType);
          } catch (err) {
            console.error('Unexpected dashboard payload', err, payload);
            const message = err && err.message ? err.message : t('results.unable');
            alert(format(t('errors.loadFail'), { message: String(message || '') }));
            setResultState('failed');
          } finally {
            setLoading(btnRefresh, false);
          }
        }).withFailureHandler(err=>{
          console.error('Failed to load dashboard data', err);
          setLoading(btnRefresh, false);
          const message = err && err.message ? err.message : err;
          alert(format(t('errors.loadFail'), { message: String(message || '') }));
          setResultState('failed');
        }).getDashboardData(q);
      } catch(e) {
        console.error(e);
        setLoading(btnRefresh, false);
        setResultState('unable');
      }
    }

    uploadForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      trimUploadTextFields();
      if (!uploadForm.reportValidity()) {
        return;
      }
      setUploadStatus('uploading');
      setLoading(btnUpload, true);

      const currentMode = formMode && formMode.type ? formMode.type : 'create';
      const currentId = formMode && formMode.id != null ? formMode.id : null;

      try {
        const fd = new FormData(uploadForm);
        const obj = {};
        fd.forEach((v,k)=>{
          if (k === 'file') return;
          if (typeof v === 'string') {
            obj[k] = v.trim();
          } else {
            obj[k] = v;
          }
        });

        const fileInput = uploadForm.file;
        if (fileInput && fileInput.files && fileInput.files.length) {
          const file = fileInput.files[0];
          obj.fileName = file.name;
          obj.fileType = file.type || 'application/octet-stream';
          obj.fileB64 = await readAsBase64_(file);
        }

        if (currentMode !== 'create') {
          if (!currentId) {
            throw new Error('Record ID is required for updates.');
          }
          obj.id = currentId;
          obj.mode = currentMode;
        }

        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          throw new Error(t('errors.runtimeUnavailable'));
        }

        const runner = google.script.run.withSuccessHandler(res=>{
          setLoading(btnUpload, false);
          if (res && res.ok) {
            const openUrl = res.fileUrl ? safeHref(res.fileUrl) : '';
            const responseId = res.id != null ? res.id : currentId;
            const payload = { id: responseId, fileUrl: openUrl };
            if (currentMode === 'create') {
              setUploadStatus('saved', payload);
              uploadForm.reset();
              setFormMode('create');
              searchEl.value = '';
              refresh({ query: '' });
            } else {
              const statusType = currentMode === 'renew' ? 'renewed' : 'updated';
              setUploadStatus(statusType, payload);
              uploadForm.reset();
              setFormMode('create');
              refresh({ query: searchEl.value || '' });
              if (historyState.open && responseId != null && String(historyState.id) === String(responseId)) {
                fetchHistory(String(responseId));
              }
            }
          } else {
            const message = res && res.error ? res.error : '';
            setUploadStatus('error', { message: String(message || '') });
          }
        }).withFailureHandler(err=>{
          setLoading(btnUpload, false);
          const message = err && err.message ? err.message : err;
          setUploadStatus('failed', { message: String(message || '') });
        });

        if (currentMode === 'create') {
          runner.uploadDocument(obj);
        } else if (currentMode === 'renew') {
          runner.renewLicense(obj);
        } else {
          runner.updateLicense(obj);
        }
      } catch (err) {
        setLoading(btnUpload, false);
        const message = err && err.message ? err.message : err;
        setUploadStatus('failed', { message: String(message || '') });
      }
    });

    function readAsBase64_(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> {
          const s = String(fr.result || '');
          resolve(s.includes(',') ? s.substring(s.indexOf(',')+1) : s);
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    applyTranslations();
    updateStatsDisplay();
    renderResultState();
    renderTable(state.rows);
    refresh();
  })();
  </script>
</body>
</html>
